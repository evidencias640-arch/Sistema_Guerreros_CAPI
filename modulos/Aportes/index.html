<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema Gesti√≥n - Guerreros CAPI</title>

  <!-- Dependencias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- Paleta: Dashboard 2025 Pro -->
  <style>
    :root {
      --primary: #4F46E5;
      --primary-2: #6d28d9;
      --muted: #6B7280;
      --success: #10B981;
      --danger: #EF4444;
      --bg: #F9FAFB;
      --text: #111827;
      --white: #ffffff;
      --border: rgba(17, 24, 39, 0.06);
      --card-radius: 12px;
      --input-radius: 10px;
      --shadow: 0 8px 22px rgba(2, 6, 23, 0.08);
      --transition: 200ms cubic-bezier(.2, .9, .3, 1);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: Inter, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      padding: 18px;
      display: flex;
      justify-content: center;
    }

    .root {
      width: 100%;
      max-width: 1400px
    }

    /* Login */
    .login-container {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(79, 70, 229, 0.07), rgba(17, 24, 39, 0.6));
      padding: 24px;
      z-index: 40
    }

    .login-box {
      width: 100%;
      max-width: 420px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.98));
      padding: 28px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      animation: loginIn .6s ease both
    }

    @keyframes loginIn {
      from {
        opacity: 0;
        transform: translateY(24px) scale(.995)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .login-box h2 {
      color: var(--primary);
      margin-bottom: 8px
    }

    .form-group {
      margin-bottom: 10px
    }

    label {
      display: block;
      font-size: .9rem;
      color: var(--muted);
      margin-bottom: 6px
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--input-radius);
      border: 1px solid var(--border);
      background: var(--white);
      transition: box-shadow var(--transition), border-color var(--transition);
      font-size: .95rem
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      box-shadow: 0 6px 18px rgba(79, 70, 229, 0.08);
      border-color: rgba(79, 70, 229, 0.4)
    }

    .primary-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      color: var(--white);
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 8px 22px rgba(79, 70, 229, 0.12);
      transition: transform var(--transition)
    }

    .primary-button:disabled {
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none
    }

    .secondary-button {
      background: transparent;
      border: 1px solid var(--border);
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--muted)
    }

    /* App container */
    .app-container {
      display: none;
      background: var(--white);
      border-radius: var(--card-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-top: 20px
    }

    header.app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px
    }

    header.app-header h1 {
      font-size: 1.25rem
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .tab-button {
      background: transparent;
      border-radius: 8px;
      padding: 8px 12px;
      border: 1px solid transparent;
      color: var(--muted);
      cursor: pointer;
      transition: all var(--transition);
      font-weight: 700
    }

    .tab-button.active {
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.1), rgba(79, 70, 229, 0.04));
      color: var(--primary);
      border-color: rgba(79, 70, 229, 0.12)
    }

    /* grids */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 18px
    }

    .metric-card {
      background: linear-gradient(180deg, #fff, rgba(255, 255, 255, 0.98));
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.04)
    }

    .metric-card h4 {
      font-size: .8rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 6px
    }

    .metric-card p {
      font-size: 1.4rem;
      font-weight: 800
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 18px
    }

    .chart-card {
      padding: 14px;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.04);
      border: 1px solid var(--border)
    }

    /* tables */
    .table-container {
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px
    }

    th,
    td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(17, 24, 39, 0.04);
      font-size: .95rem
    }

    thead th {
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.06), rgba(17, 24, 39, 0.02));
      color: var(--muted);
      font-weight: 700
    }

    .paid {
      background: #ecfdf5;
      color: var(--success);
      font-weight: 700;
      padding: 6px 8px;
      border-radius: 8px;
      display: inline-block
    }

    .month-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      margin: 6px;
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      background: #fff
    }

    .month-item.paid {
      background: #f0fdf4;
      border-color: rgba(16, 185, 129, 0.16);
      color: var(--success)
    }

    .month-item.pending-selected {
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.06), rgba(16, 185, 129, 0.03));
      border-color: rgba(79, 70, 229, 0.08)
    }

    .note-card {
      padding: 14px;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 6px 16px rgba(2, 6, 23, 0.03);
      border-left: 6px solid #eee
    }

    .note-card.Positiva {
      border-left-color: var(--success)
    }

    .note-card.Aviso {
      border-left-color: var(--primary)
    }

    .note-card.Conducta {
      border-left-color: #F59E0B
    }

    .note-card.Academica {
      border-left-color: #06B6D4
    }

    .note-card.General {
      border-left-color: var(--muted)
    }

    .note-card.Solucionada {
      border-left-color: #7C3AED;
      background: #FBF8FF
    }

    /* modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 60;
      align-items: center;
      justify-content: center
    }

    .modal.active {
      display: flex
    }

    .modal-content {
      width: 100%;
      max-width: 900px;
      background: #fff;
      padding: 18px;
      border-radius: 12px;
      box-shadow: var(--shadow)
    }

    /* toast */
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 9999;
      padding: 12px 16px;
      border-radius: 10px;
      color: #fff;
      font-weight: 700;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.12);
      transform: translateY(12px);
      opacity: 0;
      transition: all 300ms ease;
      pointer-events: none
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto
    }

    .toast.info {
      background: linear-gradient(90deg, #06B6D4, #0891B2)
    }

    .toast.success {
      background: linear-gradient(90deg, #10B981, #059669)
    }

    .toast.error {
      background: linear-gradient(90deg, #EF4444, #DC2626)
    }

    .icon-button {
      border: none;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      background: linear-gradient(90deg, #dff6fa, #e2e1f3);
      color: #fff;
      box-shadow: 0 8px 18px rgba(79, 70, 229, 0.08)
    }

    @media(max-width:900px) {
      body {
        padding: 12px
      }

      .login-box {
        padding: 18px
      }

      .chart-card,
      .metric-card {
        padding: 12px
      }

      table {
        min-width: 650px
      }
    }

    @media(max-width:600px) {
      header.app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px
      }

      .metrics-grid {
        grid-template-columns: 1fr
      }

      .chart-card {
        min-height: 220px
      }

      table {
        min-width: 500px
      }
    }



    /* --- ESTILOS PARA EL BOT√ìN DE ELIMINAR (Uiverse.io) --- */
    .button {
      width: 35px;
      height: 35;
      border-radius: 35%;
      /* Lo ponemos rojo inmediatamente en el estado normal */
      background-color: rgb(255, 69, 69);
      border: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition-duration: .3s;
      overflow: hidden;
      position: relative;
      /* Aseguramos que no interfiera con otros elementos */
      flex-shrink: 0;
    }

    .svgIcon {
      width: 15px;
      /* Aumentamos un poco el tama√±o del icono */
      transition-duration: .3s;
    }

    .svgIcon path {
      fill: white;
    }

    .button:hover {
      width: 140px;
      border-radius: 50px;
      transition-duration: .3s;
      background-color: rgb(200, 30, 30);
      /* Un rojo un poco m√°s oscuro al hacer hover */
      align-items: center;
    }

    .button:hover .svgIcon {
      width: 50px;
      transition-duration: .3s;
      transform: translateY(60%);
    }

    .button::before {
      position: absolute;
      top: -20px;
      content: "Eliminar";
      /* Cambiado a Espa√±ol */
      color: white;
      transition-duration: .3s;
      font-size: 2px;
    }

    .button:hover::before {
      font-size: 13px;
      opacity: 1;
      transform: translateY(30px);
      transition-duration: .3s;
    }
  </style>
</head>

<body>
  <div class="root">
    <!-- LOGIN -->
    <div id="loginSection" class="login-container" aria-hidden="false">
      <div class="login-box" role="dialog" aria-modal="true">
        <h2>Acceder al Sistema de Gesti√≥n</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="username">Usuario / C√≥digo</label>
            <input id="username" type="text" required />
          </div>
          <div class="form-group">
            <label for="password">Contrase√±a</label>
            <input id="password" type="password" required />
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <button id="btnLogin" class="primary-button" type="submit">Iniciar Sesi√≥n</button>
            <button id="demoLogin" type="button" class="secondary-button">Demo</button>
          </div>
          <p id="loginMessage" style="color:var(--danger);margin-top:12px;font-weight:700"></p>
        </form>
      </div>
    </div>

    <!-- APLICACI√ìN -->
    <div id="appSection" class="app-container" aria-hidden="true">
      <header class="app-header">
        <h1 id="appTitle">Gesti√≥n de Participantes</h1>
        <div class="tab-buttons" id="tabButtons">
          <!-- generated -->
        </div>
      </header>

      <main id="mainContent">
        <!-- DASHBOARD -->
        <section id="dashboard" class="tab-content active" style="display:flex;flex-direction:column">
          <h2>Dashboard de Participantes y Finanzas üìä</h2>
          <div class="metrics-grid" id="dashboardMetrics">
            <div class="metric-card">
              <h4>Total Participantes</h4>
              <p id="metricTotalParticipants">0</p>
            </div>
            <div class="metric-card">
              <h4>Valor Ingresado (Mes Actual)</h4>
              <p id="metricMonthlyContribution">$0.00</p>
            </div>
            <div class="metric-card">
              <h4>Participantes Saldos OK</h4>
              <p id="metricParticipantsPaid">0</p>
            </div>
            <div class="metric-card">
              <h4>Participantes con Deuda</h4>
              <p id="metricParticipantsDebt">0</p>
            </div>
          </div>

          <div class="charts-grid">
            <div class="chart-card">
              <h3 style="margin-bottom:8px">Aportes por Tutora (Mes Actual)</h3>
              <canvas id="chartContributionsByTutor" height="220"></canvas>
            </div>
            <div class="chart-card">
              <h3 style="margin-bottom:8px">Distribuci√≥n por Nacionalidad</h3>
              <canvas id="chartNationalityDistribution" height="220"></canvas>
            </div>
          </div>

          <h3 style="margin-top:16px">Tabla Resumen Mensual</h3>
          <div class="table-container" style="margin-top:10px">
            <table id="participantsTable" class="participants-table" aria-describedby="Tabla resumen">
              <thead>
                <tr id="participantTableHeaders"></tr>
              </thead>
              <tbody id="participantsTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- APORTES -->
        <section id="paymentsSection" class="tab-content" style="display:none;flex-direction:column">
          <h2>Registro de Aportes/Pagos Compuestos üí∞</h2>

          <form id="paymentForm" style="display:grid;gap:12px;margin-top:12px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
              <div class="form-group">
                <label for="paymentParticipantCode">C√≥digo o Nombre del Participante</label>
                <select id="paymentParticipantCode" required>
                  <option value="">-- Seleccionar Participante --</option>
                </select>
                <p style="font-size:.9rem;margin-top:6px">Participante Seleccionado: <strong
                    id="selectedParticipantName">---</strong></p>
              </div>
              <div class="form-group">
                <label for="amountPaid">Monto Entregado por Cliente (Ej: 10000.00)</label>
                <input type="number" id="amountPaid" step="0.01" min="0" required />
              </div>
            </div>

            <div class="debt-summary-box"
              style="background: linear-gradient(90deg, rgba(239,68,68,0.06), rgba(255,255,255,0.03)); padding:12px; border-radius:10px; border:1px solid rgba(239,68,68,0.08)">
              <p style="margin:0 0 6px 0">Deuda Total Pendiente (Meses Atrasados):</p>
              <p style="margin:0"><strong><span id="totalPendingDebtValue">$0.00</span></strong> (<span
                  id="pendingMonthsCount">0</span> meses)</p>
            </div>

            <div id="paymentSummary" style="display:grid;gap:6px;margin-top:6px">
              <h3 style="margin:6px 0">Resumen Financiero - <span id="summaryCode"></span></h3>
              <p>Costo Mensual: <strong id="monthlyCostValue">Cargando...</strong></p>
              <p>Saldo de Abono Anterior: <strong id="abonoBalanceValue">Cargando...</strong></p>
              <p>Total a Pagar por Meses Seleccionados: <strong id="totalCostValue" class="status-debt">0.00</strong>
              </p>
              <p>Nuevo Saldo de Abono: <strong id="abonoSurplusValue" class="status-abono">0.00</strong></p>
              <p style="margin-top:8px;color:var(--danger);font-size:.9rem">**El sistema usar√° primero el Saldo de Abono
                Anterior.**</p>
            </div>

            <label>Seleccionar Meses Pendientes (Bloqueado/Verde = Pagado):</label>
            <div id="monthsToPayList" style="display:flex;flex-wrap:wrap;gap:6px">
              <p>Seleccione un participante para cargar los meses.</p>
            </div>

            <div class="form-group">
              <label for="paymentObservaciones">Observaciones (Opcional)</label>
              <textarea id="paymentObservaciones" rows="2"></textarea>
            </div>

            <div style="display:flex;gap:10px;justify-content:flex-end">
              <button type="submit" id="submitPaymentButton" class="primary-button" disabled>Registrar Aporte</button>
            </div>
          </form>

          <h3 style="margin-top:18px">Historial de Aportes Registrados</h3>
          <div style="display:flex;gap:10px;margin-bottom:12px;margin-top:8px">
            <input type="text" id="historyFilterText" placeholder="C√≥digo o Nombre (din√°mico)..."
              style="flex:2;padding:9px;border-radius:10px;border:1px solid var(--border)">
            <select id="historyFilterMonth"
              style="flex:1;padding:9px;border-radius:10px;border:1px solid var(--border)">
              <option value="">Mes</option>
            </select>
            <select id="historyFilterYear" style="flex:1;padding:9px;border-radius:10px;border:1px solid var(--border)">
              <option value="">A√±o</option>
            </select>
            <select id="historyFilterTutora"
              style="flex:1;padding:9px;border-radius:10px;border:1px solid var(--border)">
              <option value="">Tutora</option>
              <option value="Juliana Villamizar Ortiz">Juliana Villamizar Ortiz</option>
              <option value="Diana Carolina Ure√±a Mendoza">Diana Carolina Ure√±a Mendoza</option>
              <option value="Helen Abelyn Sanchez Herrera">Helen Abelyn Sanchez Herrera</option>
              <option value="Yrany Lisbeth Martinez Sanchez">Yrany Lisbeth Martinez Sanchez</option>
            </select>
          </div>

          <div class="table-container" style="margin-top:8px">
            <table id="contributionHistoryTable">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>C√≥digo</th>
                  <th>Participante</th>
                  <th>Tutora</th>
                  <th>Monto Pagado</th>
                  <th>Meses Cubiertos</th>
                  <th>Abono Restante</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody id="contributionHistoryTableBody">
                <tr>
                  <td colspan="8">Cargando historial de aportes...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- PARTICIPANTES CRUD -->
        <section id="participantCrudSection" class="tab-content" style="display:none;flex-direction:column">
          <h2>Administraci√≥n de Participantes (CRUD) üßë‚Äçüéì</h2>
          <button id="btnAddParticipant" class="primary-button" style="margin:10px 0">‚ûï Agregar Participante</button>

          <!-- Modal Add -->
          <div id="addParticipantModal" class="modal" aria-hidden="true">
            <div class="modal-content">
              <span id="closeAddModal" style="float:right;cursor:pointer;font-size:20px">&times;</span>
              <h3>Registrar Nuevo Participante</h3>
              <form id="addParticipantFormModal" style="display:grid;gap:10px;margin-top:10px">
                <div class="form-group"><label>C√≥digo:</label><input type="text" id="modalAddCode" required></div>
                <div class="form-group"><label>Nombre:</label><input type="text" id="modalAddName" required></div>
                <div class="form-group"><label>Nacionalidad:</label><select id="modalAddNation" required>
                    <option value="">Seleccione</option>
                    <option>Colombia</option>
                    <option>Venezuela</option>
                    <option>Per√∫</option>
                    <option>Brasil</option>
                    <option>Ecuador</option>
                    <option>Otro</option>
                  </select></div>
                <div class="form-group"><label>Tutora:</label><select id="modalAddTutor" required>
                    <option value="">Seleccione</option>
                    <option>Juliana Villamizar Ortiz</option>
                    <option>Diana Carolina Ure√±a Mendoza</option>
                    <option>Helen Abelyn Sanchez Herrera</option>
                    <option>Yrany Lisbeth Martinez Sanchez</option>
                  </select></div>
                <div class="form-group"><label>URL_ID (Acceso Padre):</label><input type="text" id="modalAddUrlId">
                </div>
                <div class="form-group"><label>Costo Mensual:</label><input type="number" id="modalAddCost"
                    value="3000.00" required></div>
                <div class="form-group"><label for="modalAddMonth">Mes de Inscripci√≥n:</label><select id="modalAddMonth"
                    required></select></div>
                <p>üìÖ Fecha de Inscripci√≥n: <strong id="modalAddDate"></strong></p>
                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px"><button type="submit"
                    class="primary-button">Guardar Participante</button></div>
                <p id="addParticipantMessageModal" style="margin-top:10px;font-weight:700"></p>
              </form>
            </div>
          </div>

          <!-- Modal Edit -->
          <div id="editParticipantModal" class="modal" aria-hidden="true">
            <div class="modal-content">
              <span id="closeEditParticipantModal"
                style="position:absolute;right:16px;top:12px;cursor:pointer;font-size:20px">&times;</span>
              <h3>‚úèÔ∏è Actualizar Informaci√≥n del Participante</h3>
              <form id="editParticipantForm"
                style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px">
                <div class="form-group"><label>C√≥digo:</label><input id="editCodigo" readonly></div>
                <div class="form-group"><label>Nombre:</label><input id="editNombre" required></div>
                <div class="form-group"><label>Nacionalidad:</label><select id="editNacionalidad" required>
                    <option value="">Seleccione</option>
                    <option>Colombia</option>
                    <option>Venezuela</option>
                    <option>Per√∫</option>
                    <option>Brasil</option>
                    <option>Ecuador</option>
                    <option>Otro</option>
                  </select></div>
                <div class="form-group"><label>Tutora:</label><select id="editTutora" required>
                    <option value="">Seleccione</option>
                    <option>Juliana Villamizar Ortiz</option>
                    <option>Diana Carolina Ure√±a Mendoza</option>
                    <option>Helen Abelyn Sanchez Herrera</option>
                    <option>Yrany Lisbeth Martinez Sanchez</option>
                  </select></div>
                <div class="form-group"><label>Costo Mensual:</label><input id="editCostoMensual" type="number"
                    step="0.01" min="0" required></div>
                <div class="form-group"><label>Abono Acumulado:</label><input id="editAbono" type="number" step="0.01"
                    min="0" required></div>
                <div class="form-group"><label>URL ID:</label><input id="editUrl"></div>
                <div class="form-group"><label>Mes Inscripci√≥n:</label><select id="editMesInscripcion"
                    required></select></div>
                <div style="grid-column:1/-1;text-align:center;margin-top:10px"><button type="submit"
                    class="primary-button" id="btnSaveEdit">üíæ Guardar Cambios</button></div>
                <p id="editParticipantMessage" style="font-weight:700;text-align:center;margin-top:6px"></p>
              </form>
            </div>
          </div>

          <!-- Overlay (para cerrar al hacer clic fuera) -->
          <div id="detailOverlay" class="overlay"></div>

          <!-- Detail modal -->
          <div id="detailModal" class="modal" aria-hidden="true">
            <div class="modal-content">
              <span id="closeDetailModal" class="close-btn">&times;</span>
              <h2 id="detailTitle" class="modal-title">Detalle del Participante</h2>

              <div id="detailParticipantInfo" class="detail-section"></div>
              <div id="detailFinancial" class="detail-section"></div>
              <div id="detailPayments" class="detail-section"></div>
              <div id="detailNotes" class="detail-section"></div>
            </div>
          </div>
          <style>
            /* Fondo semitransparente */
            .overlay {
              position: fixed;
              inset: 0;
              background: rgba(0, 0, 0, 0.45);
              opacity: 0;
              visibility: hidden;
              transition: all 0.3s ease;
              z-index: 998;
            }

            .overlay.show {
              opacity: 1;
              visibility: visible;
            }

            /* Modal principal */
            .modal {
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%) scale(0.95);
              background: #fff;
              width: 90%;
              max-width: 650px;
              border-radius: 14px;
              box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
              opacity: 0;
              visibility: hidden;
              transition: all 0.3s ease;
              z-index: 999;
            }

            .modal.active {
              opacity: 1;
              visibility: visible;
              transform: translate(-50%, -50%) scale(1);
            }

            .modal-content {
              padding: 20px 24px;
              max-height: 80vh;
              overflow-y: auto;
              position: relative;
            }

            .close-btn {
              position: absolute;
              right: 16px;
              top: 12px;
              cursor: pointer;
              font-size: 26px;
              color: #444;
              transition: color 0.2s ease;
            }

            .close-btn:hover {
              color: #e11d48;
            }

            .modal-title {
              text-align: center;
              font-size: 20px;
              color: #1f2937;
              margin-bottom: 12px;
            }

            .detail-section {
              margin-top: 14px;
            }

            /* Tarjetas de detalle */
            .detail-card {
              background: #f9fafb;
              border-radius: 10px;
              padding: 14px;
              margin-bottom: 14px;
              box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            }

            /* Meses */
            .months-grid {
              display: flex;
              flex-wrap: wrap;
              gap: 6px;
              margin-top: 10px;
            }

            .month-box {
              font-size: 13px;
              padding: 6px 10px;
              border-radius: 6px;
              border: 1px solid #ddd;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              transition: transform 0.2s ease;
            }

            .month-box:hover {
              transform: scale(1.05);
            }

            /* Pagos */
            .payment-item {
              display: flex;
              justify-content: space-between;
              padding: 6px 0;
              border-bottom: 1px solid #eee;
              font-size: 14px;
            }

            /* Notas */
            .note-item {
              padding: 8px 10px;
              border-radius: 6px;
              margin-bottom: 6px;
              font-size: 14px;
            }

            /* Responsivo */
            @media (max-width: 600px) {
              .modal-content {
                padding: 16px;
              }

              .modal {
                width: 95%;
                max-height: 90vh;
              }
            }
          </style>

          <h3 style="margin-top:12px">Listado y Acciones de Participantes</h3>
          <div class="table-container" style="margin-top:10px">
            <table id="crudParticipantsTable" class="participants-table">
              <thead>
                <tr id="crudParticipantTableHeaders"></tr>
              </thead>
              <tbody id="crudParticipantsTableBody">
                <tr>
                  <td colspan="100">Cargando participantes...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h3 style="margin-top:18px">Actualizar Estado Mensual (Admin)</h3>
          <form id="adminUpdateForm"
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px">
            <div class="form-group"><label for="adminCode">C√≥digo:</label><select id="adminCode">
                <option value="">-- Seleccionar C√≥digo --</option>
              </select></div>
            <div class="form-group"><label for="adminYearMonth">Mes (YYYYMM):</label><input id="adminYearMonth"
                placeholder="Ej: 202310"></div>
            <div class="form-group"><label for="adminValue">Ponga X para Pago / Vacio no Pago:</label><input
                id="adminValue" placeholder="X o dejar vac√≠o"></div>
            <div style="display:flex;align-items:end;justify-content:flex-end"><button type="submit"
                class="primary-button">Actualizar Mes</button></div>
          </form>
          <p id="adminUpdateMessage" style="margin-top:12px;font-weight:700"></p>
        </section>

        <!-- NOTAS -->
        <section id="notesSection" class="tab-content" style="display:none;flex-direction:column">
          <h2>Registro de Notas/Observaciones üìù</h2>
          <form id="noteForm" style="display:grid;gap:10px;margin-top:12px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
              <div class="form-group"><label for="noteParticipantCode">C√≥digo o Nombre</label><select
                  id="noteParticipantCode">
                  <option value="">-- Seleccionar Participante --</option>
                </select></div>
              <div class="form-group"><label for="noteFecha">Fecha</label><input type="date" id="noteFecha" required>
              </div>
              <div class="form-group"><label for="noteTipo">Tipo de Nota</label><select id="noteTipo">
                  <option value="Positiva">Positiva</option>
                  <option value="Aviso">Aviso</option>
                  <option value="Conducta">Conducta</option>
                  <option value="Academica">Acad√©mica</option>
                  <option value="Inconsistencia">Inconsistencia de Aportes</option>
                  <option value="Asistencia">Asistencia</option>
                </select></div>
            </div>
            <div class="form-group"><label for="noteDescripcion">Descripci√≥n</label><textarea id="noteDescripcion"
                rows="4" required></textarea></div>
            <div style="display:flex;justify-content:flex-end"><button type="submit" id="submitNoteButton"
                class="primary-button">Registrar Nota</button></div>
          </form>

          <h3 style="margin-top:18px">Notas Registradas (Acciones)</h3>
          <input id="noteFilterCode" placeholder="Filtrar por C√≥digo o Nombre (din√°mico)..."
            style="margin-bottom:10px;padding:9px;border-radius:10px;border:1px solid var(--border)">
          <div id="notesListContainer" class="notes-list-container" style="margin-top:10px">
            <p>Cargue notas de un participante o todas las notas si es administrador/tutora.</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Toast -->
  <div id="globalToast" class="toast info" style="display:none"></div>

  <!-- SCRIPT -->
  <script>
    // ---------------------------
    // Config
    // ---------------------------
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzTbndAlOOlEx17kTLQPVEAsutMFQo5HoL5mAEsT59SUDlmmLyez6KECK8Lf5Md-8rn/exec';

    // Estado global
    let userRole = null;
    let userResponsible = 'Sistema';
    let userFilterValue = null;
    let userFilterType = null;
    let allParticipants = [];
    let allParticipantsHeaders = [];
    let allParticipantsMap = {};
    let financialSummary = {};
    let dashboardCharts = {};

    // DOM refs
    const loginSection = document.getElementById('loginSection');
    const appSection = document.getElementById('appSection');
    const loginForm = document.getElementById('loginForm');
    const btnLogin = document.getElementById('btnLogin');
    const demoLogin = document.getElementById('demoLogin');
    const toastEl = document.getElementById('globalToast');

    // Payment / Note DOM
    const paymentForm = document.getElementById('paymentForm');
    const paymentParticipantCodeInput = document.getElementById('paymentParticipantCode');
    const amountPaidInput = document.getElementById('amountPaid');
    const monthsToPayList = document.getElementById('monthsToPayList');
    const totalCostValueEl = document.getElementById('totalCostValue');
    const abonoBalanceValueEl = document.getElementById('abonoBalanceValue');
    const abonoSurplusValueEl = document.getElementById('abonoSurplusValue');
    const monthlyCostValueEl = document.getElementById('monthlyCostValue');
    const submitPaymentButton = document.getElementById('submitPaymentButton');
    const selectedParticipantNameEl = document.getElementById('selectedParticipantName');
    const totalPendingDebtValueEl = document.getElementById('totalPendingDebtValue');
    const pendingMonthsCountEl = document.getElementById('pendingMonthsCount');

    const noteForm = document.getElementById('noteForm');
    const submitNoteButton = document.getElementById('submitNoteButton');

    // Chart contexts
    const chartContributionsByTutorCtx = document.getElementById('chartContributionsByTutor');
    const chartNationalityDistributionCtx = document.getElementById('chartNationalityDistribution');

    // CRUD DOM
    const crudParticipantTableHeaders = document.getElementById('crudParticipantTableHeaders');
    const crudParticipantsTableBody = document.getElementById('crudParticipantsTableBody');

    // NOTES DOM
    const notesListContainer = document.getElementById('notesListContainer');

    // --------------------------------
    // Toast helper
    // --------------------------------
    function showToast(message, type = 'info', timeout = 3000) {
      toastEl.textContent = message;
      toastEl.className = 'toast ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : 'info');
      toastEl.style.display = 'block';
      setTimeout(() => toastEl.classList.add('show'), 50);
      if (timeout) {
        setTimeout(() => { toastEl.classList.remove('show'); setTimeout(() => toastEl.style.display = 'none', 300) }, timeout);
      }
    }

    // --------------------------------
    // Generic fetch helper (GET/POST)
    // --------------------------------
    async function fetchData(action, data = {}, method = 'GET') {
      let url = `${WEB_APP_URL}?action=${encodeURIComponent(action)}`;
      const params = new URLSearchParams(data);
      const options = { method: method, redirect: 'follow' };
      if (method === 'GET') {
        url += '&' + params.toString();
      } else {
        options.headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
        options.body = params.toString();
      }

      try {
        const resp = await fetch(url, options);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const json = await resp.json();

        // after create/update/delete actions, re-enable buttons if needed (safety)
        const reenableButtons = ['registerComplexPayment', 'registerNote', 'addParticipant', 'updateParticipant', 'deleteParticipant', 'deleteNote', 'updateNoteSolution', 'updateParticipantMonth'];
        if (reenableButtons.includes(action)) {
          // attempt to re-enable (some buttons store state)
          const payBtn = document.getElementById('submitPaymentButton');
          const noteBtn = document.getElementById('submitNoteButton');
          if (payBtn && payBtn.dataset.processing === 'true') { payBtn.disabled = false; payBtn.dataset.processing = 'false'; payBtn.innerHTML = payBtn.dataset.origText || 'Registrar Aporte' }
          if (noteBtn && noteBtn.dataset.processing === 'true') { noteBtn.disabled = false; noteBtn.dataset.processing = 'false'; noteBtn.innerHTML = noteBtn.dataset.origText || 'Registrar Nota' }
        }

        if (json.status === 'error') showToast(json.message || 'Error servidor', 'error', 4000);
        return json;
      } catch (err) {
        showToast('Error de conexi√≥n: ' + err.message, 'error', 4000);
        console.error('fetchData error', err);
        return { status: 'error', message: err.message };
      }
    }

    // --------------------------------
    // Auth (demo + real)
    // --------------------------------
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) { document.getElementById('loginMessage').textContent = 'Ingrese credenciales'; return; }
      btnLogin.disabled = true; const orig = btnLogin.innerHTML; btnLogin.innerHTML = '‚è≥ Iniciando...';

      // Prefer POST authenticateUser (your doPost handles it)
      const res = await fetchData('authenticateUser', { username, password }, 'POST');
      btnLogin.disabled = false; btnLogin.innerHTML = orig;
      if (res.status === 'success') {
        userRole = res.role || 'ADMIN';
        userResponsible = res.responsible || 'Sistema';
        userFilterValue = res.filterValue || null;
        userFilterType = res.filterType || null;
        loginSection.style.display = 'none';
        loginSection.setAttribute('aria-hidden', 'true');
        appSection.style.display = 'block';
        appSection.setAttribute('aria-hidden', 'false');
        setupApp(userRole);
        await genericosPostLogin();
      } else {
        document.getElementById('loginMessage').textContent = res.message || 'Credenciales inv√°lidas';
      }
    });

    demoLogin.addEventListener('click', () => { document.getElementById('username').value = 'ICC2025'; document.getElementById('password').value = 'ICC2025'; });

    async function genericosPostLogin() {
      generarOpcionesMeses(); document.getElementById('modalAddDate').textContent = new Date().toLocaleDateString('es-CO');
      await loadParticipantsAndRender();
      await loadDashboardData();

      // pasar filtro al historial y a notas si el usuario es una TUTORA
      if (userFilterType === 'TUTORA' || userFilterType === 'TUTORA') {
        // enviar como { tutora: userFilterValue } al backend
        await loadContributionHistory({ tutora: userFilterValue });
        await loadNotes(userFilterValue); // tu loadNotes acepta ahora un param (ver abajo)
      } else {
        await loadContributionHistory({});
        await loadNotes('');
      }

    }

    // --------------------------------
    // Setup tabs
    // --------------------------------
    function setupApp(role) {
      const tabs = [{ id: 'dashboard', name: 'Dashboard', active: true }, { id: 'paymentsSection', name: 'Aportes' }, { id: 'notesSection', name: 'Notas' }];
      if (role === 'ADMIN' || role === 'TUTORA') tabs.push({ id: 'participantCrudSection', name: 'Participantes' });
      const container = document.getElementById('tabButtons'); container.innerHTML = '';
      tabs.forEach(t => {
        const btn = document.createElement('button'); btn.className = 'tab-button' + (t.active ? ' active' : ''); btn.textContent = t.name;
        btn.onclick = () => showTab(t.id);
        container.appendChild(btn);
      });
      const logoutBtn = document.createElement('button'); logoutBtn.className = 'tab-button'; logoutBtn.textContent = 'Cerrar Sesi√≥n'; logoutBtn.onclick = () => location.reload();
      container.appendChild(logoutBtn);
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(s => s.style.display = 'none');
      const el = document.getElementById(tabId);
      if (el) el.style.display = 'flex';
      // mark active
      document.querySelectorAll('.tab-button').forEach(b => {
        b.classList.toggle('active', b.textContent.trim().toLowerCase() === (tabId === 'participantCrudSection' ? 'participantes' : tabId.replace('Section', '').toLowerCase()));
      });
      // load specific data
      if (tabId === 'dashboard') loadDashboardData();
      if (tabId === 'paymentsSection') { if (allParticipants.length === 0) loadParticipantsAndRender(); }
      if (tabId === 'notesSection') loadNotes();
    }

    // --------------------------------
    // Load participants
    // --------------------------------
    async function loadParticipantsAndRender() {
      const params = {};
      // use filter if provided (tutora/participante)
      if (userFilterType && userFilterValue) { params.filterType = userFilterType; params.filterValue = userFilterValue; }
      const res = await fetchData('getParticipants', params, 'GET');
      if (res.status === 'success' && Array.isArray(res.data)) {
        allParticipants = res.data;
        allParticipantsHeaders = res.headers || [];
        allParticipantsMap = {}; allParticipants.forEach(p => { allParticipantsMap[p.CODIGO] = p; });
        populateSelects();
        renderParticipantsTable(allParticipants, allParticipantsHeaders);
        renderCrudTable(allParticipants, allParticipantsHeaders);
        showToast(`Cargados ${allParticipants.length} participantes`, 'success', 1400);
      } else {
        allParticipants = []; renderParticipantsTable([]); renderCrudTable([]);
        showToast('No se pudieron cargar participantes', 'error', 3000);
      }
    }

    function populateSelects() {
      const ids = ['paymentParticipantCode', 'noteParticipantCode', 'adminCode'];
      ids.forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return; sel.innerHTML = '<option value="">-- Seleccionar Participante --</option>';
        allParticipants.forEach(p => {
          const opt = document.createElement('option'); opt.value = p.CODIGO; opt.textContent = `${p.CODIGO} - ${p.PARTICIPANTE}`; sel.appendChild(opt);
        });
      });
    }

    // Participants table (dashboard)
    function renderParticipantsTable(participants, headers = []) {
      const thRow = document.getElementById('participantTableHeaders');
      const tbody = document.getElementById('participantsTableBody');

      thRow.innerHTML = '';
      tbody.innerHTML = '';

      if (!participants || participants.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100">No hay participantes cargados.</td></tr>';
        return;
      }

      const baseHeaders = ['CODIGO', 'PARTICIPANTE', 'TUTORA'];
      const monthHeaders = (headers || []).filter(h => /^\d{6}$/.test(h)).sort();
      const visible = [...baseHeaders, 'ABONO_ACUMULADO', ...monthHeaders];

      // Estilos CSS Integrados (para el check y la cruz)
      const PAID_STYLE = `
    color: #065F46; /* Verde oscuro */
    font-weight: 700;
    font-size: 1.1rem;
    background-color: #D1FAE5; /* Verde claro */
    border-radius: 4px;
    padding: 3px 6px;
    display: inline-block;
  `;

      const UNPAID_STYLE = `
    color: #B91C1C; /* Rojo oscuro */
    font-weight: 700;
    font-size: 1.1rem;
    background-color: #FEE2E2; /* Rojo claro solicitado */
    border-radius: 4px;
    padding: 3px 6px;
    display: inline-block;
  `;

      // Renderizar encabezados
      visible.forEach(h => {
        const th = document.createElement('th');
        th.textContent = /^\d{6}$/.test(h) ? (formatYearMonthShort(h)) : h.replace('_', ' ');
        if (/^\d{6}$/.test(h)) th.style.textAlign = 'center';
        thRow.appendChild(th);
      });

      // Renderizar filas de participantes
      participants.forEach(p => {
        const tr = document.createElement('tr');
        visible.forEach(h => {
          const td = document.createElement('td');
          let v = p[h] || '';

          if (/^\d{6}$/.test(h)) {
            // Es una columna de mes (YYYYMM)
            td.style.textAlign = 'center';

            if ((v + '').toUpperCase() === 'X') {
              // PAGADO: Check verde con estilos integrados
              td.innerHTML = `<span style="${PAID_STYLE}">‚úî</span>`;
            } else {
              // NO PAGADO: X roja con estilos integrados
              td.innerHTML = `<span style="${UNPAID_STYLE}">X</span>`;
            }

          } else if (h === 'ABONO_ACUMULADO') {
            // Formato de moneda para el abono
            td.textContent = formatCurrency(parseFloat(v || 0));
            td.style.textAlign = 'right';
          }
          else {
            // Otros datos (Nombre, Tutora, C√≥digo)
            td.textContent = v;
          }

          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // CRUD table
    function renderCrudTable(participants, headers = []) {
      crudParticipantTableHeaders.innerHTML = ''; crudParticipantsTableBody.innerHTML = '';
      if (!participants || participants.length === 0) { crudParticipantsTableBody.innerHTML = '<tr><td colspan="100">No se encontraron participantes.</td></tr>'; return; }
      const baseHeaders = ['CODIGO', 'PARTICIPANTE', 'NACIONALIDAD', 'TUTORA', 'COSTO_MENSUAL', 'MES_INSCRIPCION', 'URL_ID'];
      const visible = [...baseHeaders, 'ACCIONES'];
      visible.forEach(h => { const th = document.createElement('th'); th.textContent = h.replace('_', ' '); crudParticipantTableHeaders.appendChild(th); });
      participants.forEach(p => {
        const tr = document.createElement('tr');
        visible.forEach(h => {
          const td = document.createElement('td');
          if (h === 'ACCIONES') {
            td.innerHTML = `<button class="primary-button" style="padding:6px 8px;font-size:.9rem" onclick="openEditModal('${p.CODIGO}')">‚úèÔ∏è Editar</button>
            <button class="primary-button" style="padding:6px 8px;font-size:.9rem;margin-left:6px" onclick="openDetailModal('${p.CODIGO}')">üîç Detalle</button>
            <button class="secondary-button" style="margin-left:6px" onclick="deleteParticipantConfirm('${p.CODIGO}','${escape(p.PARTICIPANTE)}')">üóëÔ∏è Eliminar</button>
            <button class="icon-button" style="margin-left:6px" onclick="copyParticipantURL('${p.URL_ID}')">üîó</button>`;
          } else if (h === 'COSTO_MENSUAL' || h === 'ABONO_ACUMULADO') td.textContent = formatCurrency(parseFloat(p[h] || 0));
          else td.textContent = p[h] || '';
          tr.appendChild(td);
        });
        crudParticipantsTableBody.appendChild(tr);
      });
    }

    // --------------------------------
    // Payments: load summary & months
    // --------------------------------
    paymentParticipantCodeInput.addEventListener('change', async (e) => {
      const code = e.target.value;
      if (!code || !allParticipantsMap[code]) { selectedParticipantNameEl.textContent = '---'; monthsToPayList.innerHTML = '<p>Seleccione un participante para cargar los meses.</p>'; submitPaymentButton.disabled = true; return; }
      selectedParticipantNameEl.textContent = allParticipantsMap[code].PARTICIPANTE;
      await loadFinancialSummary(code);
    });

    amountPaidInput.addEventListener('input', calculatePaymentSummary);

    function renderMonthsCheckboxes(availableMonths = [], financialStatus = {}) {
      monthsToPayList.innerHTML = '';
      const sorted = (availableMonths || []).slice().sort();
      if (sorted.length === 0) { monthsToPayList.innerHTML = '<p>No hay meses disponibles.</p>'; return; }
      sorted.forEach(ym => {
        const isPaid = (financialStatus[ym] || '').toString().toUpperCase() === 'X';
        const label = document.createElement('label'); label.className = 'month-item ' + (isPaid ? 'paid' : 'pending');
        const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = ym; checkbox.style.marginRight = '8px';
        if (isPaid) { checkbox.checked = true; checkbox.disabled = true; } else { checkbox.addEventListener('change', () => { if (checkbox.checked) label.classList.add('pending-selected'); else label.classList.remove('pending-selected'); calculatePaymentSummary(); }); }
        label.appendChild(checkbox); label.appendChild(document.createTextNode(formatYearMonthLong(ym)));
        monthsToPayList.appendChild(label);
      });
    }

    async function loadFinancialSummary(code) {
      submitPaymentButton.disabled = true;
      monthsToPayList.innerHTML = '<p>Cargando estado financiero...</p>';
      const res = await fetchData('getParticipantFinancialSummary', { participantCode: code }, 'GET');
      if (res.status === 'success') {
        financialSummary = res;
        const mesesPagados = Object.entries(res.financialStatus || {}).filter(([k, v]) => v === 'X').map(([k]) => k).sort();
        const ultimoMesPagado = mesesPagados.length ? mesesPagados[mesesPagados.length - 1] : null;
        // availableMonths already sorted by backend
        renderMonthsCheckboxes(res.availableMonths || [], res.financialStatus || {});
        monthlyCostValueEl.textContent = formatCurrency(res.monthlyCost || 0);
        abonoBalanceValueEl.textContent = formatCurrency(res.abonoBalance || 0);
        calculatePaymentSummary();
        submitPaymentButton.disabled = false;
        // load history for selected if needed
        await loadContributionHistory(code);
      } else {
        showToast(res.message || 'Error al cargar financiero', 'error');
        monthsToPayList.innerHTML = '<p style="color:var(--danger)">Error al cargar resumen.</p>';
      }
    }

    function calculatePaymentSummary() {
      if (!financialSummary || !financialSummary.monthlyCost) return;
      const montoEntregado = parseFloat(amountPaidInput.value) || 0;
      const abonoAnterior = parseFloat(financialSummary.abonoBalance || 0);
      const costoMensual = parseFloat(financialSummary.monthlyCost || 0);
      const monthsToPay = Array.from(monthsToPayList.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value).filter(ym => (financialSummary.financialStatus || {})[ym] !== 'X');
      const totalCostoMeses = monthsToPay.length * costoMensual;
      const totalFondo = abonoAnterior + montoEntregado;
      const nuevoAbono = totalFondo - totalCostoMeses;
      totalCostValueEl.textContent = formatCurrency(totalCostoMeses);
      abonoSurplusValueEl.textContent = formatCurrency(nuevoAbono);
      if (totalCostoMeses > 0 && nuevoAbono < 0) abonoSurplusValueEl.style.color = 'var(--danger)'; else abonoSurplusValueEl.style.color = 'var(--success)';
      submitPaymentButton.disabled = (nuevoAbono < 0) || (totalCostoMeses === 0 && montoEntregado === 0 && abonoAnterior === 0);
      // pending debt
      totalPendingDebtValueEl.textContent = formatCurrency(totalCostoMeses);
      pendingMonthsCountEl.textContent = monthsToPay.length;
    }

    // Submit registerComplexPayment (bloquea bot√≥n)
    paymentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitPaymentButton.dataset.processing === 'true') return;
      const participantCode = paymentParticipantCodeInput.value;
      if (!participantCode) { showToast('Seleccione el participante', 'error'); return; }
      const montoEntregado = parseFloat(amountPaidInput.value) || 0;
      const mesesSeleccionados = Array.from(monthsToPayList.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value).filter(ym => (financialSummary.financialStatus || {})[ym] !== 'X');
      if (montoEntregado <= 0 && mesesSeleccionados.length === 0 && !(financialSummary.abonoBalance > 0)) { showToast('No hay monto ni meses seleccionados.', 'error'); return; }

      // bloqueo UI
      submitPaymentButton.dataset.origText = submitPaymentButton.innerHTML;
      submitPaymentButton.innerHTML = '‚è≥ Creando aporte...'; submitPaymentButton.disabled = true; submitPaymentButton.dataset.processing = 'true';
      showToast('Creando aporte...', 'info');

      // calcular nuevo abono final
      const abonoAnterior = parseFloat(financialSummary.abonoBalance || 0);
      const costoMensual = parseFloat(financialSummary.monthlyCost || 0);
      const totalCostoMeses = mesesSeleccionados.length * costoMensual;
      const finalAbono = (abonoAnterior + montoEntregado) - totalCostoMeses;

      const payload = {
        participantCode,
        amountPaid: montoEntregado,
        mesesPagados: JSON.stringify(mesesSeleccionados),
        finalAbono,
        paymentObservaciones: document.getElementById('paymentObservaciones').value || ''
      };

      const res = await fetchData('registerComplexPayment', payload, 'POST');
      if (res.status === 'success') {
        showToast('‚úÖ Aporte creado y guardado exitosamente.', 'success');
        await loadParticipantsAndRender();
        await loadFinancialSummary(participantCode);
      } else {
        showToast(res.message || 'Error creando aporte', 'error', 4000);
      }
      // safety re-enable
      setTimeout(() => { submitPaymentButton.disabled = false; submitPaymentButton.dataset.processing = 'false'; submitPaymentButton.innerHTML = submitPaymentButton.dataset.origText || 'Registrar Aporte'; }, 3000);
    });

    // =================================================================================
    // === HISTORIAL DE APORTES (CORREGIDO para usar objetos y Tutora Filter) ===
    // =================================================================================

    async function loadContributionHistory(params = {}) {
      const historyTableBody = document.getElementById('contributionHistoryTableBody');
      historyTableBody.innerHTML = '<tr><td colspan="7">Cargando historial de aportes...</td></tr>';

      // La funci√≥n fetchData ahora incluye los params (filtros de Tutora)
      const res = await fetchData('getContributionHistory', params, 'GET');

      if (res.status === 'success' && Array.isArray(res.data)) {
        window.historyData = res.data;
        renderContributionHistory(window.historyData);

      } else {
        const errorMessage = res.message || 'Error al cargar historial. Aseg√∫rese de que la App Script est√© implementada correctamente y devuelva objetos.';
        historyTableBody.innerHTML = `<tr><td colspan="7">${errorMessage}</td></tr>`;
        showToast(`‚ùå ${errorMessage}`, 'danger');
        window.historyData = [];
      }
    }

    // Funci√≥n de renderizado separada que usa los nombres de las propiedades
    function renderContributionHistory(history) {
      const historyTableBody = document.getElementById('contributionHistoryTableBody');
      historyTableBody.innerHTML = '';

      if (history.length === 0) {
        historyTableBody.innerHTML = `<tr><td colspan="7">No hay registros de aportes ${userFilterType === 'TUTORA' ? 'para tus participantes' : ''}.</td></tr>`;
        return;
      }

      history.forEach(h => {
        const row = historyTableBody.insertRow();
        const fecha = formatDate(h.FECHA); // Asumiendo que el campo es FECHA
        const codigo = h.CODIGO_PARTICIPANTE; // Asumiendo que el campo es CODIGO_PARTICIPANTE
        const participante = allParticipantsMap[codigo]?.PARTICIPANTE || 'N/A';
        const tutora = allParticipantsMap[codigo]?.TUTORA || 'N/A';
        const monto = h.MONTO_PAGADO || 0; // Asumiendo que el campo es MONTO
        const mes = h.MESES_CUBIERTOS || 'N/A'; // Ajusta si el nombre de tu columna es diferente
        const abono = h.ABONO_REMANENTE || 'N/A'; // Ajusta si el nombre de tu columna es diferente
        const observaciones = h.OBSERVACIONES || 'N/A'; // Asumiendo que el campo es REGISTRO

        row.insertCell().textContent = fecha;
        row.insertCell().textContent = codigo;
        row.insertCell().textContent = participante;
        row.insertCell().textContent = tutora;
        row.insertCell().textContent = formatCurrency(monto);
        // 1. Intentar parsear la cadena JSON
        let mesesArray = [];
        try {
          // El valor de la celda de la hoja de c√°lculo es una cadena JSON
          mesesArray = JSON.parse(mes);
          if (!Array.isArray(mesesArray)) {
            // Si el parseo es exitoso pero no es un array (ej: solo devolvi√≥ el valor 'null'), lo inicializamos vac√≠o
            mesesArray = [];
          }
        } catch (e) {
          // Si falla el parseo (no es JSON, quiz√°s est√° vac√≠o o tiene otro valor), lo inicializamos vac√≠o
          mesesArray = [];
        }

        // 2. Formatear cada c√≥digo de mes a 'MMM YYYY' y unirlos con un separador
        const mesesFormateados = mesesArray.map(formatMonthCode).join(' - ');

        // 3. Insertar el texto formateado
        row.insertCell().textContent = mesesFormateados;
        row.insertCell().textContent = formatCurrency(abono);
        row.insertCell().textContent = observaciones;
      });
    }

    function filterContributionHistory() {
      const filterText = document.getElementById('filterContributionInput').value.toLowerCase();
      const filtered = window.historyData.filter(h => {
        const participant = allParticipantsMap[h.CODIGO_PARTICIPANTE]?.PARTICIPANTE || '';
        const tutora = allParticipantsMap[h.CODIGO_PARTICIPANTE]?.TUTORA || '';
        return h.CODIGO_PARTICIPANTE.toLowerCase().includes(filterText) ||
          participant.toLowerCase().includes(filterText) ||
          tutora.toLowerCase().includes(filterText);
      });
      renderContributionHistory(filtered);
    }

    // --------------------------------
    // Notes: load/create/update/delete
    // --------------------------------
    async function loadNotes(filterValue = '') {
      notesListContainer.innerHTML = '<p>Cargando notas...</p>';
      const res = await fetchData('getNotes', { filterValue: filterValue || '' }, 'GET');

      // --- ESTILOS INTEGRADOS EN JS (Para las tarjetas de nota) ---
      const CARD_BASE_STYLE = 'padding: 15px; margin-bottom: 15px; border-radius: 8px; transition: background-color 0.3s ease;';
      const PENDING_CARD_STYLE = 'background-color: #FEF3C7; border: 1px solid #FBBF24; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);'; // Amarillo claro
      const SOLVED_CARD_STYLE = 'background-color: #D1FAE5; border: 1px solid #34D399; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);'; // Verde claro
      const SOLUTION_BOX_STYLE = 'margin-top:12px; padding:10px; background-color:rgba(0,128,0,0.08); border-left:4px solid #10B981; border-radius:4px;';
      // --------------------------------

      if (res.status === 'success' && Array.isArray(res.data)) {
        notesListContainer.innerHTML = '';
        if (res.data.length === 0) { notesListContainer.innerHTML = '<p>No hay notas.</p>'; return; }

        res.data.forEach(n => {
          // 1. DETERMINAR ESTADO Y ESTILO
          const isSolved = (n.SOLUCION || '').trim().length > 0;
          const cardColorStyle = isSolved ? SOLVED_CARD_STYLE : PENDING_CARD_STYLE;

          const card = document.createElement('div');
          card.style.cssText = CARD_BASE_STYLE + cardColorStyle;

          const fecha = formatDate(n.FECHA) || n.FECHA || '';
          const participante = (allParticipantsMap[n.CODIGO_PARTICIPANTE] || {}).PARTICIPANTE || n.CODIGO_PARTICIPANTE;

          // 2. CONSTRUIR EL HTML DE LA SOLUCI√ìN (Si existe)
          let solutionHTML = '';
          if (isSolved) {
            const solutionDate = formatDate(n.FECHA_SOLUCION) || '';
            solutionHTML = `
                    <div style="${SOLUTION_BOX_STYLE}">
                        <p style="font-weight:600; color:#10B981;">‚úÖ Soluci√≥n Registrada</p>
                        <p style="margin-top:4px;">${n.SOLUCION || 'N/A'}</p>
                        <p style="margin-top:4px; font-size:.85rem; color:#10B981;">Responsable: ${n.RESPONSABLE_SOLUCION || 'N/A'}</p>
                    </div>
                `;
          }

          // 3. RENDERIZAR LA TARJETA COMPLETA
          card.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div>
                        <strong>${participante}</strong> 
                        <small style="color:var(--muted)">(${n.CODIGO_PARTICIPANTE})</small> 
                        ¬∑ 
                        <small style="color:var(--muted)">${fecha}</small>
                    </div>
                    <div style="display:flex;gap:8px">
                        ${!isSolved // Muestra el bot√≥n 'Soluci√≥n' solo si NO est√° solucionada
              ? `<button class="primary-button" style="padding:6px 8px;font-size:.9rem" onclick="openNoteSolutionModal('${n.ID}','${escape(n.DESCRIPCION || '')}')">üõ†Ô∏è Soluci√≥n</button>`
              : ''
            }
                        <button class="button" onclick="deleteNoteConfirm('${n.ID}')"><svg viewBox="0 0 448 512" class="svgIcon"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"></path></svg></button>
                    </div>
                </div>
                
                <p style="margin-top:8px; font-weight:500;">üìå Descripci√≥n:</p>
                <p style="margin-top:4px; margin-left:15px; border-left: 2px solid #ccc; padding-left: 10px;">${n.DESCRIPCION || ''}</p>
                
                ${solutionHTML}
                
                <p style="margin-top:8px;font-size:.9rem;color:var(--muted); border-top: 1px solid rgba(0,0,0,0.05); padding-top: 8px;">
                    Tipo: ${n.TIPO || ''} ¬∑ Responsable de Registro: ${n.RESPONSABLE_REGISTRO || ''}
                </p>
            `;
          notesListContainer.appendChild(card);
        });
      } else {
        notesListContainer.innerHTML = '<p>Error cargando notas.</p>';
      }
    }

    // registerNote (POST -> registerNote)
    noteForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitNoteButton.dataset.processing === 'true') return;
      const participantCode = document.getElementById('noteParticipantCode').value;
      const fecha = document.getElementById('noteFecha').value;
      const tipo = document.getElementById('noteTipo').value;
      const descripcion = document.getElementById('noteDescripcion').value.trim();
      if (!participantCode || !fecha || !descripcion) { showToast('Complete todos los campos de la nota', 'error'); return; }

      // UI lock
      submitNoteButton.dataset.origText = submitNoteButton.innerHTML;
      submitNoteButton.innerHTML = '‚è≥ Guardando nota...'; submitNoteButton.disabled = true; submitNoteButton.dataset.processing = 'true';
      showToast('Guardando nota...', 'info');

      const payload = { code: participantCode, fecha, tipo, descripcion, responsable: userResponsible };
      const res = await fetchData('registerNote', payload, 'POST');

      // UI unlock cleanup (Se mueve aqu√≠ para asegurar que la UI se restablezca ANTES de la recarga)
      submitNoteButton.disabled = false;
      submitNoteButton.dataset.processing = 'false';
      submitNoteButton.innerHTML = submitNoteButton.dataset.origText || 'Registrar Nota';

      if (res.status === 'success') {
        showToast('‚úÖ Nota creada y guardada exitosamente. Recargando...', 'success');

        // **FIX CLAVE:** A√±adir un peque√±o retraso. Esto da tiempo a Google Apps Script para confirmar 
        // la operaci√≥n en segundo plano y evita que la recarga (loadNotes) cause un error de sesi√≥n.
        await new Promise(resolve => setTimeout(resolve, 500));
        await loadNotes();
        noteForm.reset();
      } else {
        showToast(res.message || 'Error guardando nota', 'error', 4000);
      }
    });

    // updateNoteSolution (modal)
    window.openNoteSolutionModal = function (noteId, descriptionEscaped) {
      const desc = unescape(descriptionEscaped);
      const solution = prompt('Escribe la soluci√≥n/observaci√≥n para la nota:', '');
      if (solution === null) return;
      const responsible = userResponsible || 'Sistema';
      showToast('Guardando soluci√≥n...', 'info');

      fetchData('updateNoteSolution', { noteId, solution, responsible }, 'POST').then(async res => {
        if (res.status === 'success') {
          showToast('‚úÖ Nota actualizada', 'success');
          // **FIX CLAVE:** A√±adir un peque√±o retraso antes de recargar
          await new Promise(resolve => setTimeout(resolve, 500));
          loadNotes();
        } else {
          showToast(res.message || 'Error', 'error');
        }
      });
    }

    // deleteNote
    window.deleteNoteConfirm = function (noteId) {
      if (!confirm('¬øEliminar esta nota? Esta acci√≥n es irreversible.')) return;
      fetchData('deleteNote', { noteId }, 'POST').then(res => {
        if (res.status === 'success') { showToast('Nota eliminada', 'success'); loadNotes(); } else showToast(res.message || 'Error', 'error');
      });
    }

    // --------------------------------
    // CRUD: add / edit / delete participant
    // --------------------------------
    // modal controls add
    document.getElementById('btnAddParticipant').addEventListener('click', () => { document.getElementById('addParticipantModal').classList.add('active'); document.getElementById('addParticipantModal').setAttribute('aria-hidden', 'false'); });
    document.getElementById('closeAddModal').addEventListener('click', () => { document.getElementById('addParticipantModal').classList.remove('active'); document.getElementById('addParticipantModal').setAttribute('aria-hidden', 'true'); });

    // add participant submit -> calls addParticipant (POST -> addParticipant)
    document.getElementById('addParticipantFormModal').addEventListener('submit', async (e) => {
      e.preventDefault();
      const dataObj = {
        CODIGO: document.getElementById('modalAddCode').value.trim(),
        PARTICIPANTE: document.getElementById('modalAddName').value.trim(),
        NACIONALIDAD: document.getElementById('modalAddNation').value,
        TUTORA: document.getElementById('modalAddTutor').value,
        URL_ID: document.getElementById('modalAddUrlId').value || '',
        COSTO_MENSUAL: parseFloat(document.getElementById('modalAddCost').value || 0),
        ABONO_ACUMULADO: 0,
        FECHA_INSCRIPCION: new Date().toLocaleDateString('es-CO'),
        MES_INSCRIPCION: document.getElementById('modalAddMonth').value
      };
      const btn = e.target.querySelector('button[type="submit"]');
      btn.dataset.origText = btn.innerHTML; btn.innerHTML = '‚è≥ Guardando...'; btn.disabled = true;
      const res = await fetchData('addParticipant', { data: JSON.stringify(dataObj) }, 'POST');
      btn.disabled = false; btn.innerHTML = btn.dataset.origText || 'Guardar Participante';
      if (res.status === 'success') { showToast('‚úÖ Participante creado', 'success'); document.getElementById('addParticipantModal').classList.remove('active'); await loadParticipantsAndRender(); }
      else showToast(res.message || 'Error crear participante', 'error');
    });

    // open edit modal
    window.openEditModal = function (code) {
      const participant = allParticipantsMap[code];
      if (!participant) { showToast('Participante no encontrado', 'error'); return; }
      document.getElementById('editCodigo').value = participant.CODIGO || '';
      document.getElementById('editNombre').value = participant.PARTICIPANTE || '';
      document.getElementById('editNacionalidad').value = participant.NACIONALIDAD || '';
      document.getElementById('editTutora').value = participant.TUTORA || '';
      document.getElementById('editCostoMensual').value = participant.COSTO_MENSUAL || 0;
      document.getElementById('editAbono').value = participant.ABONO_ACUMULADO || 0;
      document.getElementById('editUrl').value = participant.URL_ID || '';
      document.getElementById('editMesInscripcion').value = participant.MES_INSCRIPCION || '';
      document.getElementById('editParticipantModal').classList.add('active'); document.getElementById('editParticipantModal').setAttribute('aria-hidden', 'false');
    };

    // close edit
    document.getElementById('closeEditParticipantModal').addEventListener('click', () => { document.getElementById('editParticipantModal').classList.remove('active'); document.getElementById('editParticipantModal').setAttribute('aria-hidden', 'true'); });

    // save edit -> updateParticipant (POST -> updateParticipant(JSON))
    document.getElementById('editParticipantForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const dataObj = {
        CODIGO: document.getElementById('editCodigo').value,
        PARTICIPANTE: document.getElementById('editNombre').value,
        NACIONALIDAD: document.getElementById('editNacionalidad').value,
        TUTORA: document.getElementById('editTutora').value,
        COSTO_MENSUAL: parseFloat(document.getElementById('editCostoMensual').value || 0),
        ABONO_ACUMULADO: parseFloat(document.getElementById('editAbono').value || 0),
        URL_ID: document.getElementById('editUrl').value || '',
        MES_INSCRIPCION: document.getElementById('editMesInscripcion').value || ''
      };
      const btn = document.getElementById('btnSaveEdit'); btn.dataset.origText = btn.innerHTML; btn.innerHTML = '‚è≥ Guardando...'; btn.disabled = true;
      const res = await fetchData('updateParticipant', { data: JSON.stringify(dataObj) }, 'POST');
      btn.disabled = false; btn.innerHTML = btn.dataset.origText || 'Guardar Cambios';
      if (res.status === 'success') { showToast('‚úÖ Participante actualizado', 'success'); document.getElementById('editParticipantModal').classList.remove('active'); await loadParticipantsAndRender(); }
      else showToast(res.message || 'Error actualizar', 'error');
    });

    // delete participant
    window.deleteParticipantConfirm = function (code, nameEscaped) {
      const name = unescape(nameEscaped);
      if (!confirm(`¬øEliminar participante ${name} (${code})? Esta acci√≥n es irreversible.`)) return;
      fetchData('deleteParticipant', { code }, 'POST').then(async res => {
        if (res.status === 'success') { showToast('Participante eliminado', 'success'); await loadParticipantsAndRender(); } else showToast(res.message || 'Error eliminando', 'error');
      });
    }

    // update specific month (admin)
    document.getElementById('adminUpdateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = document.getElementById('adminCode').value;
      const yearMonth = document.getElementById('adminYearMonth').value;
      const value = document.getElementById('adminValue').value || '';
      if (!code || !yearMonth) { document.getElementById('adminUpdateMessage').textContent = 'Complete los campos'; return; }
      const btnText = e.submitter ? e.submitter.innerText : 'Actualizar';
      document.getElementById('adminUpdateMessage').textContent = 'Actualizando...';
      const res = await fetchData('updateParticipantMonth', { code, yearMonth, value }, 'POST');
      if (res.status === 'success') { document.getElementById('adminUpdateMessage').textContent = res.message || 'Actualizado'; await loadParticipantsAndRender(); } else document.getElementById('adminUpdateMessage').textContent = res.message || 'Error';
    });

    // --------------------------------
    // Detail view
    // --------------------------------
    window.openDetailModal = function (code) {
      const p = allParticipantsMap[code];
      if (!p) { showToast('Participante no encontrado', 'error'); return; }

      const modal = document.getElementById('detailModal');
      const overlay = document.getElementById('detailOverlay');

      // Banderas seg√∫n nacionalidad
      const flagMap = { 'COLOMBIA': 'üá®üá¥', 'VENEZUELA': 'üáªüá™' };
      const nacionalidad = (p.NACIONALIDAD || '').toUpperCase();
      const bandera = flagMap[nacionalidad] || 'üåé';

      // --- Informaci√≥n principal ---
      document.getElementById('detailParticipantInfo').innerHTML = `
    <div class="detail-card">
      <h3>${bandera} ${p.PARTICIPANTE}</h3>
      <p><strong>C√≥digo:</strong> ${p.CODIGO}</p>
      <p><strong>Tutora:</strong> ${p.TUTORA || 'Sin asignar'}</p>
      <p><strong>Nacionalidad:</strong> ${p.NACIONALIDAD || 'Desconocida'}</p>
    </div>
  `;

      // --- Financiero ---
      const today = new Date();
      const currentYM = today.getFullYear() * 100 + (today.getMonth() + 1);
      let monthsHtml = '';

      (allParticipantsHeaders || [])
        .filter(h => /^\d{6}$/.test(h))
        .sort()
        .forEach(m => {
          const val = p[m] || '';
          const numeric = parseInt(m);
          let bg = '#f3f4f6', color = '#333', symbol = '‚Äî';

          if (numeric < currentYM) {
            if (val === 'X') { bg = '#e8f7ed'; color = '#0f5132'; symbol = '‚úîÔ∏è'; }
            else { bg = '#f8d7da'; color = '#842029'; symbol = '‚úñÔ∏è'; }
          } else if (numeric === currentYM) {
            bg = '#fff3cd'; color = '#856404'; symbol = '‚Ä¢';
          }

          monthsHtml += `<div class="month-box" style="background:${bg};color:${color}">${formatYearMonthShort(m)} ${symbol}</div>`;
        });

      document.getElementById('detailFinancial').innerHTML = `
    <div class="detail-card">
      <h4>üí∞ Financiero</h4>
      <p><strong>Costo mensual:</strong> ${formatCurrency(p.COSTO_MENSUAL || 0)}</p>
      <p><strong>Abono acumulado:</strong> ${formatCurrency(p.ABONO_ACUMULADO || 0)}</p>
      <div class="months-grid">${monthsHtml}</div>
    </div>
  `;

      // --- Pagos ---
      const payments = [];
      if (window.historyData && Array.isArray(window.historyData)) {
        window.historyData.forEach(r => {
          const codigo = r[1] || r.codigo || '';
          if (String(codigo) === String(code)) payments.push(r);
        });
      }
      const payHtml = payments.length ? `
    <div class="detail-card">
      <h4>üìÖ Pagos</h4>
      ${payments.map(r => `
        <div class="payment-item">
          <span><strong>${formatDate(r[0])}</strong></span>
          <span>${formatCurrency(parseFloat(r[2] || 0))}</span>
          <span>Meses: ${r[3] || '-'}</span>
        </div>
      `).join('')}
    </div>` : '<div class="detail-card"><p>No hay pagos registrados</p></div>';
      document.getElementById('detailPayments').innerHTML = payHtml;

      // --- Notas ---
      fetchData('getNotes', { filterValue: code }, 'GET').then(res => {
        if (res.status === 'success' && Array.isArray(res.data)) {
          const notes = res.data;
          const notesHtml = notes.length ? `
        <div class="detail-card">
          <h4>üóíÔ∏è Notas</h4>
          ${notes.map(n => {
            const solved = n.ESTADO && n.ESTADO.toLowerCase().includes('solucion');
            const bg = solved ? '#e8f7ed' : '#fff3cd';
            const border = solved ? '#0f5132' : '#856404';
            return `
              <div class="note-item" style="background:${bg};border-left:4px solid ${border}">
                <p><strong>${formatDate(n.FECHA)}</strong> ¬∑ ${n.TIPO}</p>
                <p>${n.DESCRIPCION}</p>
              </div>`;
          }).join('')}
        </div>` : '<div class="detail-card"><p>No hay notas registradas</p></div>';
          document.getElementById('detailNotes').innerHTML = notesHtml;
        } else {
          document.getElementById('detailNotes').innerHTML = '<p>Error cargando notas</p>';
        }
      });

      // Mostrar modal y overlay
      modal.classList.add('active');
      overlay.classList.add('show');
    };

    // Cerrar modal
    document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
    document.getElementById('detailOverlay').addEventListener('click', closeDetailModal);

    function closeDetailModal() {
      document.getElementById('detailModal').classList.remove('active');
      document.getElementById('detailOverlay').classList.remove('show');
    }


    // --------------------------------
    // Dashboard & charts
    // --------------------------------
    async function loadDashboardData() {
      const res = await fetchData('getDashboardData', { filterValue: userFilterValue || '', filterType: userFilterType || '' }, 'GET');
      if (res.status === 'success' && res.data) {
        const data = res.data;
        document.getElementById('metricTotalParticipants').textContent = data.totalParticipants || 0;
        document.getElementById('metricMonthlyContribution').textContent = formatCurrency(data.monthlyContribution || 0);
        document.getElementById('metricParticipantsPaid').textContent = data.participantsPaid || 0;
        document.getElementById('metricParticipantsDebt').textContent = data.participantsDebt || 0;
        renderDashboardCharts(data.contributionsByTutor || {}, data.nationalityDistribution || {});
      } else {
        document.getElementById('metricTotalParticipants').textContent = '0';
      }
    }

    function renderDashboardCharts(tutorData, nationalityData) {
      if (dashboardCharts.tutorChart) dashboardCharts.tutorChart.destroy();
      if (dashboardCharts.nationalityChart) dashboardCharts.nationalityChart.destroy();
      const colors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#6B7280', '#06B6D4', '#F97316'];
      const tutorLabels = Object.keys(tutorData || {}); const tutorValues = tutorLabels.map(k => tutorData[k]);
      const ctx1 = chartContributionsByTutorCtx.getContext ? chartContributionsByTutorCtx.getContext('2d') : chartContributionsByTutorCtx;
      dashboardCharts.tutorChart = new Chart(ctx1, { type: 'bar', data: { labels: tutorLabels, datasets: [{ label: 'Aportes ($)', data: tutorValues, backgroundColor: colors.slice(0, tutorLabels.length), borderWidth: 1 }] }, options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
      const natLabels = Object.keys(nationalityData || {}); const natValues = natLabels.map(k => nationalityData[k]);
      const ctx2 = chartNationalityDistributionCtx.getContext ? chartNationalityDistributionCtx.getContext('2d') : chartNationalityDistributionCtx;
      dashboardCharts.nationalityChart = new Chart(ctx2, { type: 'doughnut', data: { labels: natLabels, datasets: [{ label: 'Participantes', data: natValues, backgroundColor: colors.slice(0, natLabels.length), hoverOffset: 6 }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
    }

    // --------------------------------
    // Utilities
    // --------------------------------
    function formatCurrency(amount) { if (typeof amount !== 'number' && isNaN(amount)) return '$0.00'; const n = Number(amount || 0); return '$' + n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
    function formatDate(val) { try { const d = new Date(val); if (isNaN(d)) return val; return d.toLocaleDateString('es-CO'); } catch (e) { return val; } }
    function formatYearMonthShort(ym) { if (!/^\d{6}$/.test(ym)) return ym; const year = ym.substring(0, 4); const month = ym.substring(4, 6); const dt = new Date(year, month - 1, 1); return dt.toLocaleDateString('es-ES', { month: 'short' }).slice(0, 3).toUpperCase() + '/' + year.slice(2); }
    function formatYearMonthLong(ym) { if (!/^\d{6}$/.test(ym)) return ym; const year = ym.substring(0, 4); const month = ym.substring(4, 6); const dt = new Date(year, month - 1, 1); return dt.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' }); }

    // copy URL helper
    function copyParticipantURL(urlId) {
      if (!urlId) { showToast("‚ö†Ô∏è Este participante no tiene un URL_ID registrado.", "error"); return; }
      const fullURL = `https://evidencias640-arch.github.io/Sistema_Guerreros_CAPI/modulos/Aportes/participantes.html?urlid=${encodeURIComponent(urlId)}`;
      navigator.clipboard.writeText(fullURL).then(() => showToast("‚úÖ URL creada y copiada correctamente.", "success")).catch(() => showToast("‚ùå Error al copiar la URL.", "error"));
    }

    // generar meses para selects
    function generarOpcionesMeses() {
      const select = document.getElementById('modalAddMonth'); const editSelect = document.getElementById('editMesInscripcion');
      if (!select || !editSelect) return;
      select.innerHTML = ''; editSelect.innerHTML = '';
      const ahora = new Date(); const a√±oActual = ahora.getFullYear(); const a√±oInicio = 2022; const a√±oFin = a√±oActual + 1;
      const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      for (let a√±o = a√±oInicio; a√±o <= a√±oFin; a√±o++) { for (let m = 1; m <= 12; m++) { const mesStr = m.toString().padStart(2, '0'); const valor = `${a√±o}${mesStr}`; const nombre = `${meses[m - 1]} ${a√±o}`; const opt = document.createElement('option'); opt.value = valor; opt.textContent = nombre; select.appendChild(opt); const opt2 = opt.cloneNode(true); editSelect.appendChild(opt2); } }
      const mesActual = ahora.getFullYear().toString() + (ahora.getMonth() + 1).toString().padStart(2, '0'); select.value = mesActual; editSelect.value = mesActual;
    }

    // init
    document.addEventListener('DOMContentLoaded', () => {
      generarOpcionesMeses();
      document.getElementById('modalAddDate').textContent = new Date().toLocaleDateString('es-CO');
      // optionally auto demo: document.getElementById('demoLogin').click();
    });

    /**
   * Convierte un c√≥digo YYYYMM (ej: 202501) a formato MMM YYYY (ej: ENE 2025).
   * @param {string} ymCode C√≥digo de mes y a√±o (YYYYMM).
   * @returns {string} Mes y a√±o formateado.
   */
    function formatMonthCode(ymCode) {
      // 1. Validar formato
      if (!/^\d{6}$/.test(ymCode)) {
        return ymCode;
      }
      const year = ymCode.substring(0, 4);
      const month = ymCode.substring(4, 6);

      // Nombres de meses en espa√±ol (tres letras)
      const monthNames = [
        'ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN',
        'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'
      ];

      const monthIndex = parseInt(month, 10) - 1; // 01 -> √≠ndice 0, 12 -> √≠ndice 11

      if (monthIndex >= 0 && monthIndex < 12) {
        return `${monthNames[monthIndex]} ${year}`;
      }
      return ymCode; // Falla la conversi√≥n
    }
  </script>

</body>

</html>
