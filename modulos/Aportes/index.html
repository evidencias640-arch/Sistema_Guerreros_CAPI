<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n Avanzada de Participantes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* Estilos Globales y Variables CSS */
        :root {
            --primary-color: #007bff;
            /* Azul para gesti√≥n */
            --secondary-color: #6c757d;
            /* Gris oscuro */
            --accent-color: #28a745;
            /* Verde para √©xito/Acciones */
            --danger-color: #dc3545;
            /* Rojo para eliminaci√≥n/Deuda */
            --background-light: #f8f9fa;
            /* Fondo claro */
            --background-dark: #343a40;
            /* Fondo oscuro para headers/footers */
            --text-color: #343a40;
            --light-text-color: #FFFFFF;
            --border-color: #dee2e6;
            --box-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.15);
            --border-radius-card: 12px;
            --border-radius-input: 8px;
            --transition-speed: 0.3s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: var(--background-light);
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Contenedores Principales */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--background-dark) 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-hover);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
            position: relative;
        }

        .app-container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 30px;
            display: none;
            /* Se mostrar√° con JS */
            flex-direction: column;
            gap: 25px;
            background: #fff;
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-light);
            width: 100%;
        }

        /* Dashboard Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-light);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.2s;
        }

        .metric-card.danger {
            border-left-color: var(--danger-color);
        }

        .metric-card.success {
            border-left-color: var(--accent-color);
        }

        .metric-card h4 {
            font-size: 0.9em;
            color: var(--secondary-color);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .metric-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-color);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-card {
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-light);
            min-height: 300px;
        }

        /* Contenido de las Pesta√±as */
        .tab-content {
            padding: 30px;
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-light);
            display: none;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.6s ease-out;
            background-color: var(--background-light);
        }

        .tab-content.active {
            display: flex;
        }

        /* Resumen de Deuda en Aportes */
        .debt-summary-box {
            background-color: #ffe0e6;
            /* Fondo rojo claro para la deuda */
            border: 2px solid var(--danger-color);
            padding: 15px;
            border-radius: var(--border-radius-input);
            margin-top: 15px;
            font-size: 1.1em;
        }

        .debt-summary-box strong {
            color: var(--danger-color);
            font-size: 1.2em;
        }

        /* Tabla de Historial de Pagos */
        #contributionHistoryTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 800px;
        }

        #contributionHistoryTable th,
        #contributionHistoryTable td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        #contributionHistoryTable thead th {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Asegurar que los estilos de Toast est√©n aqu√≠ */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(20px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: block;
        }

        /* Estilos de Botones y Formularios Adicionales */
        .primary-button {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius-input);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .action-button.delete {
            background-color: var(--danger-color);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            color: var(--light-text-color);
            transition: background-color 0.2s;
            border-radius: 6px 6px 0 0;
            font-weight: 500;
            margin-right: 5px;
        }

        .tab-buttons {
            display: flex;
            align-items: center;
            background-color: var(--background-dark);
            border-radius: 8px 8px 0 0;
            padding: 5px;
        }

        header {
            width: 100%;
            background-color: var(--background-dark);
            color: var(--light-text-color);
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow-light);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-input);
            margin-top: 5px;
        }

        /* Estilos de la tabla de participantes */
        .participants-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #fff;
            min-width: 800px;
        }

        .participants-table th,
        .participants-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .participants-table th {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            font-weight: 600;
        }

        .paid {
            background-color: #c8e6c9;
            /* Verde muy claro */
            font-weight: bold;
            color: var(--accent-color);
        }

        .month-item {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 10px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            background-color: #fff;
            transition: background-color 0.1s;
        }

        .month-item.paid {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            cursor: default;
        }

        .month-item.pending-selected {
            background-color: #ffe0b2;
            /* Naranja claro */
            border-color: #ffb74d;
        }

        .notes-list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .note-card {
            padding: 15px;
            border-radius: var(--border-radius-card);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 5px solid;
            background-color: #fff;
        }

        .note-card.Positiva {
            border-left-color: var(--accent-color);
        }

        .note-card.Aviso {
            border-left-color: var(--primary-color);
        }

        .note-card.Conducta {
            border-left-color: #ffc107;
        }

        .note-card.Academica {
            border-left-color: #17a2b8;
        }

        .note-card.General {
            border-left-color: var(--secondary-color);
        }

        .note-card.Solucionada {
            border-left-color: #6f42c1;
            background-color: #f3f0fb;
        }

        /* Nuevos estilos para responsividad de tabla */
        .table-container {
            overflow-x: auto;
            /* Permite scroll horizontal */
            width: 100%;
            margin-top: 15px;
        }

        .participants-table {
            min-width: 1000px;
            /* Asegura que la tabla no se colapse por defecto */
            width: 100%;
            border-collapse: collapse;
        }

        .participants-table th,
        .participants-table td {
            padding: 8px 12px;
            text-align: left;
            white-space: nowrap;
            /* Evita que el texto de las celdas se rompa */
        }

        /* Estilo del modal de detalle */
        .detail-section {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .detail-grid h5 {
            grid-column: 1 / -1;
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        /* Estilos para el dashboard (gr√°ficos) */
        .dashboard-metrics {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--box-shadow-light);
            min-width: 200px;
            text-align: center;
            flex-grow: 1;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 5px;
        }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--box-shadow-light);
        }

        /* Media query para m√≥viles */
        @media (max-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr;
                /* Una sola columna en m√≥viles */
            }

            .chart-container {
                grid-template-columns: 1fr;
            }
        }

        .icon-button {
            background: linear-gradient(135deg, #00b4ff, #0077ff);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 18px;
            padding: 6px 10px;
            cursor: pointer;
            box-shadow: 0 0 12px rgba(0, 180, 255, 0.5);
            transition: transform 0.2s, box-shadow 0.3s;
        }

        .icon-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 180, 255, 0.8);
        }

        /* Toast futurista */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 200, 255, 0.2);
            color: #aef;
            border: 1px solid rgba(0, 200, 255, 0.5);
            border-radius: 10px;
            padding: 10px 16px;
            font-family: "Poppins", sans-serif;
            font-size: 0.9rem;
            box-shadow: 0 0 15px rgba(0, 180, 255, 0.4);
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.4s ease;
            z-index: 9999;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <div id="loginSection" class="login-container">
        <div class="login-box">
            <h2>Acceder al Sistema de Gesti√≥n</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario / C√≥digo:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="primary-button" style="margin-top: 15px;">Iniciar Sesi√≥n</button>
            </form>
            <p id="loginMessage" style="color: var(--danger-color); margin-top: 15px; font-weight: 500;"></p>
        </div>
    </div>

    <div id="appSection" class="app-container">
        <header>
            <h1 id="appTitle">Gesti√≥n de Participantes</h1>
            <div class="tab-buttons" id="tabButtons">
                <button id="logoutButton" class="tab-button">Cerrar Sesi√≥n</button>
            </div>
        </header>

        <main id="mainContent">
            <section id="dashboard" class="tab-content active">
                <h2>Dashboard de Participantes y Finanzas üìä</h2>

                <div class="metrics-grid" id="dashboardMetrics">
                    <div class="metric-card success">
                        <h4>Total Participantes</h4>
                        <p id="metricTotalParticipants">0</p>
                    </div>
                    <div class="metric-card danger">
                        <h4>Valor Ingresado (Mes Actual)</h4>
                        <p id="metricMonthlyContribution">$0.00</p>
                    </div>
                    <div class="metric-card success">
                        <h4>Participantes Saldos OK</h4>
                        <p id="metricParticipantsPaid">0</p>
                    </div>
                    <div class="metric-card danger">
                        <h4>Participantes con Deuda</h4>
                        <p id="metricParticipantsDebt">0</p>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Aportes por Tutora (Mes Actual)</h3>
                        <canvas id="chartContributionsByTutor"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Distribuci√≥n por Nacionalidad</h3>
                        <canvas id="chartNationalityDistribution"></canvas>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Tabla Resumen Mensual</h3>
                <div class="table-container">
                    <table id="participantsTable" class="participants-table">
                        <thead>
                            <tr id="participantTableHeaders"></tr>
                        </thead>
                        <tbody id="participantsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="paymentsSection" class="tab-content">
                <h2>Registro de Aportes/Pagos Compuestos üí∞</h2>
                <form id="paymentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="paymentParticipantCode">C√≥digo o Nombre del Participante:</label>
                            <select id="paymentParticipantCode" required>
                                <option value="">-- Seleccionar Participante --</option>
                            </select>
                            <p style="font-size: 0.9em; margin-top: 5px;">Participante Seleccionado: <strong
                                    id="selectedParticipantName">---</strong></p>
                        </div>
                        <div class="form-group">
                            <label for="amountPaid">Monto Entregado por Cliente (Ej: 10000.00):</label>
                            <input type="number" id="amountPaid" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="debt-summary-box">
                        <p>Deuda Total Pendiente (Meses Atrasados):</p>
                        <p><strong><span id="totalPendingDebtValue">$0.00</span></strong> (<span
                                id="pendingMonthsCount">0</span> meses)</p>
                    </div>

                    <div id="paymentSummary">
                        <h3>Resumen Financiero - <span id="summaryCode"></span></h3>
                        <p>Costo Mensual: <strong id="monthlyCostValue">Cargando...</strong></p>
                        <p>Saldo de Abono Anterior: <strong id="abonoBalanceValue">Cargando...</strong></p>
                        <p>Total a Pagar por Meses Seleccionados: <strong id="totalCostValue"
                                class="status-debt">0.00</strong></p>
                        <p class="payment-status">Nuevo Saldo de Abono: <strong id="abonoSurplusValue"
                                class="status-abono">0.00</strong></p>
                        <p style="margin-top: 10px; color: var(--danger-color); font-size: 0.9em;">**El sistema usar√°
                            primero el Saldo de Abono Anterior.**</p>
                    </div>

                    <label style="margin-top: 15px;">Seleccionar Meses Pendientes (Bloqueado/Verde = Pagado):</label>
                    <div id="monthsToPayList">
                        <p>Seleccione un participante para cargar los meses.</p>
                    </div>

                    <div class="form-group">
                        <label for="paymentObservaciones">Observaciones (Opcional):</label>
                        <textarea id="paymentObservaciones" rows="2"></textarea>
                    </div>

                    <button type="submit" class="primary-button" id="submitPaymentButton" disabled>Registrar
                        Aporte</button>
                </form>

                <h3 style="margin-top: 40px;">Historial de Aportes Registrados</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="historyFilterText" placeholder="C√≥digo o Nombre (din√°mico)..."
                        style="flex: 2;">
                    <select id="historyFilterMonth" style="flex: 1;">
                        <option value="">Mes</option>
                    </select>
                    <select id="historyFilterYear" style="flex: 1;">
                        <option value="">A√±o</option>
                    </select>
                    <select id="historyFilterTutora" style="flex: 1;">
                        <option value="">Tutora</option>
                        <option value="Juliana Villamizar Ortiz">Juliana Villamizar Ortiz</option>
                        <option value="Diana Carolina Ure√±a Mendoza">Diana Carolina Ure√±a Mendoza</option>
                        <option value="Helen Abelyn Sanchez Herrera">Helen Abelyn Sanchez Herrera</option>
                        <option value="Yrany Lisbeth Martinez Perez">Yrany Lisbeth Martinez Perez</option>
                    </select>
                </div>

                <div class="table-container">
                    <table id="contributionHistoryTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>C√≥digo</th>
                                <th>Participante</th>
                                <th>Tutora</th>
                                <th>Monto Pagado</th>
                                <th>Meses Cubiertos</th>
                                <th>Abono Restante</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody id="contributionHistoryTableBody">
                            <tr>
                                <td colspan="8">Cargando historial de aportes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="participantCrudSection" class="tab-content">
                <h2>Administraci√≥n de Participantes (CRUD) üßë‚Äçüéì</h2>

                <!-- Bot√≥n principal para agregar participante -->
                <button id="btnAddParticipant" class="primary-button" style="margin-bottom: 20px;">
                    ‚ûï Agregar Participante
                </button>

                <!-- Modal: Agregar Participante -->
                <div id="addParticipantModal" class="modal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; background-color: rgba(0,0,0,0.5);">
                    <div class="modal-content" style="background: #fff; margin: 5% auto; padding: 25px; border-radius: 8px; 
              width: 80%; max-width: 600px;">

                        <span id="closeAddModal" class="close-button"
                            style="float:right; cursor:pointer; font-size:28px;">&times;</span>
                        <h3>Registrar Nuevo Participante</h3>

                        <form id="addParticipantFormModal" class="form-grid" style="margin-top:15px;">
                            <div class="form-group">
                                <label>C√≥digo:</label>
                                <input type="text" id="modalAddCode" required>
                            </div>

                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" id="modalAddName" required>
                            </div>

                            <div class="form-group">
                                <label>Nacionalidad:</label>
                                <select id="modalAddNation" required>
                                    <option value="">Seleccione</option>
                                    <option value="Colombia">Colombia</option>
                                    <option value="Venezuela">Venezuela</option>
                                    <option value="Per√∫">Per√∫</option>
                                    <option value="Brasil">Brasil</option>
                                    <option value="Ecuador">Ecuador</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Tutora:</label>
                                <select id="modalAddTutor" required>
                                    <option value="">Seleccione</option>
                                    <option value="Juliana Villamizar Ortiz">Juliana Villamizar Ortiz</option>
                                    <option value="Diana Carolina Ure√±a Mendoza">Diana Carolina Ure√±a Mendoza</option>
                                    <option value="Helen Abelyn Sanchez Herrera">Helen Abelyn Sanchez Herrera</option>
                                    <option value="Yrany Lisbeth Martinez Perez">Yrany Lisbeth Martinez Perez</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>URL_ID (Acceso Padre):</label>
                                <input type="text" id="modalAddUrlId">
                            </div>

                            <div class="form-group">
                                <label>Costo Mensual:</label>
                                <input type="number" id="modalAddCost" value="3000.00" required>
                            </div>

                            <!-- üÜï Campo din√°mico: Mes de Inscripci√≥n -->
                            <div class="form-group">
                                <label for="modalAddMonth">Mes de Inscripci√≥n:</label>
                                <select id="modalAddMonth" required>
                                    <option value="">Cargando meses disponibles...</option>
                                </select>
                            </div>

                            <p>üìÖ Fecha de Inscripci√≥n: <strong id="modalAddDate"></strong></p>

                            <div class="form-group" style="grid-column:1/-1;">
                                <button type="submit" class="primary-button">Guardar Participante</button>
                            </div>
                        </form>

                        <p id="addParticipantMessageModal" style="margin-top: 10px; font-weight: bold;"></p>
                    </div>
                </div>

                <!-- üåü Modal: Editar Participante -->
                <div id="editParticipantModal" class="modal"
                    style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.45); backdrop-filter: blur(3px);">
                    <div class="modal-content"
                        style="background: #ffffff; margin: 5% auto; padding: 30px 35px; border-radius: 12px; width: 90%; max-width: 620px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; animation: fadeIn 0.3s ease;">

                        <span id="closeEditParticipantModal"
                            style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:28px; color:#888; transition:color 0.2s;"
                            onmouseover="this.style.color='#000'" onmouseout="this.style.color='#888'">&times;</span>

                        <h3 style="text-align:center; margin-bottom:25px; color:#222;">‚úèÔ∏è Actualizar Informaci√≥n del
                            Participante</h3>

                        <form id="editParticipantForm" class="form-grid"
                            style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px;">

                            <!-- C√≥digo -->
                            <div class="form-group">
                                <label for="editCodigo" style="font-weight:600;">C√≥digo:</label>
                                <input type="text" id="editCodigo" readonly
                                    style="background:#f0f0f0; border:1px solid #ccc; border-radius:6px; padding:8px;">
                            </div>

                            <!-- Nombre -->
                            <div class="form-group">
                                <label for="editNombre" style="font-weight:600;">Nombre:</label>
                                <input type="text" id="editNombre" required
                                    style="border:1px solid #ccc; border-radius:6px; padding:8px;">
                            </div>

                            <!-- Nacionalidad -->
                            <div class="form-group">
                                <label for="editNacionalidad" style="font-weight:600;">Nacionalidad:</label>
                                <select id="editNacionalidad" required
                                    style="border:1px solid #ccc; border-radius:6px; padding:8px;">
                                    <option value="">Seleccione</option>
                                    <option value="Colombia">Colombia</option>
                                    <option value="Venezuela">Venezuela</option>
                                    <option value="Peru">Per√∫</option>
                                    <option value="Brasil">Brasil</option>
                                    <option value="Ecuador">Ecuador</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <!-- Tutora -->
                            <div class="form-group">
                                <label for="editTutora" style="font-weight:600;">Tutora:</label>
                                <select id="editTutora" required
                                    style="border:1px solid #ccc; border-radius:6px; padding:8px;">
                                    <option value="">Seleccione</option>
                                    <option value="Juliana Villamizar Ortiz">Juliana Villamizar Ortiz</option>
                                    <option value="Diana Carolina Ure√±a Mendoza">Diana Carolina Ure√±a Mendoza</option>
                                    <option value="Helen Abelyn Sanchez Herrera">Helen Abelyn Sanchez Herrera</option>
                                    <option value="Yrany Lisbeth Martinez Perez">Yrany Lisbeth Martinez Perez</option>
                                </select>
                            </div>

                            <!-- Costo mensual -->
                            <div class="form-group">
                                <label for="editCostoMensual" style="font-weight:600;">Costo Mensual:</label>
                                <input type="number" id="editCostoMensual" step="0.01" min="0" required
                                    style="border:1px solid #ccc; border-radius:6px; padding:8px;">
                            </div>

                            <!-- Abono acumulado -->
                            <div class="form-group">
                                <label for="editAbono" style="font-weight:600;">Abono Acumulado:</label>
                                <input type="number" id="editAbono" step="0.01" min="0" required
                                    style="border:1px solid #ccc; border-radius:6px; padding:8px;">
                            </div>

                            <!-- URL ID -->
                            <div class="form-group">
                                <label for="editUrl" style="font-weight:600;">URL ID:</label>
                                <input type="text" id="editUrl" step="0.01" min="0" required
                                    style="border:1px solid #ccc; border-radius:6px; padding:8px;">
                            </div>

                            <!-- Mes de inscripci√≥n -->
                            <div class="form-group">
                                <label for="editMesInscripcion" style="font-weight:600;">Mes de Inscripci√≥n:</label>
                                <select id="editMesInscripcion" required
                                    style="border:1px solid #ccc; border-radius:6px; padding:8px;">
                                    <option value="">Seleccione mes...</option>
                                </select>
                            </div>

                            <!-- Bot√≥n guardar -->
                            <div class="form-group" style="grid-column:1 / -1; text-align:center; margin-top:10px;">
                                <button type="submit" class="primary-button"
                                    style="background:#4CAF50; color:#fff; border:none; border-radius:8px; padding:10px 25px; cursor:pointer; font-size:16px; transition:background 0.2s;">
                                    üíæ Guardar Cambios
                                </button>
                            </div>
                        </form>

                        <p id="editParticipantMessage"
                            style="margin-top:10px; text-align:center; font-weight:bold; color:#333;"></p>
                    </div>
                </div>

                <!-- Animaci√≥n -->
                <style>
                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                            transform: scale(0.95);
                        }

                        to {
                            opacity: 1;
                            transform: scale(1);
                        }
                    }
                </style>


                <!-- üåü Modal: Detalle del Participante -->
                <div id="detailModal" class="modal"
                    style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.55); backdrop-filter:blur(4px);">

                    <div class="modal-content"
                        style="background:#ffffff; margin:3% auto; padding:30px; border-radius:12px; width:90%; max-width:950px; box-shadow:0 10px 25px rgba(0,0,0,0.25); position:relative; animation:fadeIn 0.3s ease;">

                        <!-- Cerrar -->
                        <span id="closeDetailModal"
                            style="position:absolute; top:15px; right:20px; font-size:30px; color:#777; cursor:pointer; transition:color 0.2s;"
                            onmouseover="this.style.color='#000'" onmouseout="this.style.color='#777'">&times;</span>

                        <h2 id="detailTitle" style="text-align:center; margin-bottom:25px; color:#222;">Detalle del
                            Participante</h2>

                        <!-- SECCIONES -->
                        <div id="detailParticipantInfo" class="detail-section" style="margin-bottom:25px;"></div>
                        <div id="detailFinancial" class="detail-section" style="margin-bottom:25px;"></div>
                        <div id="detailPayments" class="detail-section" style="margin-bottom:25px;"></div>
                        <div id="detailNotes" class="detail-section"></div>
                    </div>
                </div>

                <!-- Animaci√≥n -->
                <style>
                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                            transform: scale(0.96);
                        }

                        to {
                            opacity: 1;
                            transform: scale(1);
                        }
                    }
                </style>


                <!-- Tabla CRUD -->
                <h3>Listado y Acciones de Participantes</h3>
                <div class="table-container">
                    <table id="crudParticipantsTable" class="participants-table" style="min-width: 1000px;">
                        <thead>
                            <tr id="crudParticipantTableHeaders"></tr>
                        </thead>
                        <tbody id="crudParticipantsTableBody">
                            <tr>
                                <td colspan="100">Cargando participantes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 style="margin-top: 30px;">Actualizar Estado Mensual (Admin)</h3>
                <form id="adminUpdateForm"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div class="form-group">
                        <label for="adminCode">C√≥digo:</label>
                        <select id="adminCode" required>
                            <option value="">-- Seleccionar C√≥digo --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="adminYearMonth">Mes (YYYYMM):</label>
                        <input type="text" id="adminYearMonth" placeholder="Ej: 202310" required>
                    </div>
                    <div class="form-group">
                        <label for="adminValue">Ponga X para Pago / Vacio no Pago:</label>
                        <input type="text" id="adminValue" placeholder="X o dejar vac√≠o">
                    </div>
                    <button type="submit" class="primary-button" style="align-self: flex-end;">Actualizar Mes</button>
                </form>
                <p id="adminUpdateMessage" style="margin-top: 15px; font-weight: 500;"></p>
            </section>

            <section id="notesSection" class="tab-content">
                <h2>Registro de Notas/Observaciones üìù</h2>
                <form id="noteForm" class="form-grid">
                    <div class="form-group">
                        <label for="noteParticipantCode">C√≥digo o Nombre del Participante:</label>
                        <select id="noteParticipantCode" required>
                            <option value="">-- Seleccionar Participante --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="noteFecha">Fecha:</label>
                        <input type="date" id="noteFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="noteTipo">Tipo de Nota:</label>
                        <select id="noteTipo" required>
                            <option value="Positiva">Positiva</option>
                            <option value="Aviso">Aviso</option>
                            <option value="Conducta">Conducta</option>
                            <option value="Academica">Acad√©mica</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="noteDescripcion">Descripci√≥n:</label>
                        <textarea id="noteDescripcion" rows="4" required></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;"><button type="submit"
                            class="primary-button">Registrar Nota</button></div>
                </form>

                <h3 style="margin-top: 30px;">Notas Registradas (Acciones)</h3>
                <input type="text" id="noteFilterCode" placeholder="Filtrar por C√≥digo o Nombre (din√°mico)..."
                    style="margin-bottom: 15px;">
                <div id="notesListContainer" class="notes-list-container">
                    <p>Cargue notas de un participante o todas las notas si es administrador/tutora.</p>
                </div>
            </section>
        </main>
    </div>

    <!-- üöÄ Script para copiar y mostrar mensaje -->
    <script>
        function copyParticipantURL(urlId) {
            if (!urlId) {
                showToast("‚ö†Ô∏è Este participante no tiene un URL_ID registrado.");
                return;
            }

            const fullURL = `https://evidencias640-arch.github.io/Sistema_Guerreros_CAPI/modulos/Aportes/participantes.html?urlid=${encodeURIComponent(urlId)}`;
            navigator.clipboard.writeText(fullURL)
                .then(() => {
                    showToast("‚úÖ URL creada y copiada correctamente.");
                })
                .catch(() => {
                    showToast("‚ùå Error al copiar la URL.");
                });
        }

        // üí¨ Muestra toast visual
        function showToast(message) {
            const toast = document.createElement("div");
            toast.className = "toast";
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add("show"), 50);
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }
    </script>


    <div id="toast"></div>

    <script src="animaciones.js"></script>
    <!-- Script para generar din√°micamente los meses -->
    <script>
        function generarOpcionesMeses() {
            const select = document.getElementById("modalAddMonth");
            if (!select) return;

            select.innerHTML = ""; // Limpiar opciones previas

            const ahora = new Date();
            const a√±oActual = ahora.getFullYear();
            const a√±oInicio = 2022; // Puedes cambiar el punto de inicio si lo deseas
            const a√±oFin = a√±oActual + 1; // Un a√±o por adelantado

            const meses = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];

            for (let a√±o = a√±oInicio; a√±o <= a√±oFin; a√±o++) {
                for (let mes = 1; mes <= 12; mes++) {
                    const mesStr = mes.toString().padStart(2, "0");
                    const valor = `${a√±o}${mesStr}`; // Ejemplo: 202510
                    const nombre = `${meses[mes - 1]} ${a√±o}`;
                    const option = document.createElement("option");
                    option.value = valor;
                    option.textContent = nombre;
                    select.appendChild(option);
                }
            }

            // Seleccionar por defecto el mes actual
            const mesActual = ahora.getFullYear().toString() + (ahora.getMonth() + 1).toString().padStart(2, "0");
            select.value = mesActual;
        }

        // Ejecutar al cargar la p√°gina
        document.addEventListener("DOMContentLoaded", () => {
            generarOpcionesMeses();

            // Mostrar la fecha actual autom√°ticamente
            const dateSpan = document.getElementById("modalAddDate");
            if (dateSpan) {
                dateSpan.textContent = new Date().toLocaleDateString("es-CO");
            }
        });

        function addParticipant(e) {
            try {
                const ss = SpreadsheetApp.getActiveSpreadsheet();
                const sheet = ss.getSheetByName("PARTICIPANTES");

                const data = JSON.parse(e.parameter.data);
                const {
                    CODIGO,
                    PARTICIPANTE,
                    NACIONALIDAD,
                    TUTORA,
                    URL_ID,
                    COSTO_MENSUAL,
                    ABONO_ACUMULADO,
                    FECHA_INSCRIPCION,
                    MES_INSCRIPCION
                } = data;

                // üß© Verificar que no exista el c√≥digo
                const codigos = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues().flat();
                if (codigos.includes(CODIGO)) {
                    return ContentService.createTextOutput(JSON.stringify({
                        status: "error",
                        message: "El participante ya existe."
                    })).setMimeType(ContentService.MimeType.JSON);
                }

                // Buscar la columna inicial donde terminan los datos fijos
                const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
                const colFechaRegistro = headers.indexOf("FECHA_REGISTRO") + 1;
                const colMesInscripcion = headers.indexOf("MES_INSCRIPCION") + 1;

                // Crear una nueva fila con los datos base
                const newRow = [
                    CODIGO,
                    PARTICIPANTE,
                    NACIONALIDAD,
                    TUTORA,
                    URL_ID,
                    COSTO_MENSUAL,
                    ABONO_ACUMULADO,
                    FECHA_INSCRIPCION,
                    MES_INSCRIPCION
                ];

                // Agregar la fila a la hoja
                sheet.appendRow(newRow);

                // Obtener la fila en la que se agreg√≥
                const lastRow = sheet.getLastRow();

                // ‚úÖ Marcar las "X" hacia atr√°s seg√∫n MES_INSCRIPCION
                marcarMesesPagados(sheet, lastRow, MES_INSCRIPCION);

                return ContentService.createTextOutput(JSON.stringify({
                    status: "success",
                    message: "Participante registrado correctamente."
                })).setMimeType(ContentService.MimeType.JSON);

            } catch (err) {
                return ContentService.createTextOutput(JSON.stringify({
                    status: "error",
                    message: "Error al registrar participante: " + err
                })).setMimeType(ContentService.MimeType.JSON);
            }
        }


        /**
         * üß© Funci√≥n auxiliar: marca con "X" los meses anteriores al mes de inscripci√≥n.
         * @param {GoogleAppsScript.Spreadsheet.Sheet} hoja - hoja de participantes
         * @param {number} fila - fila del nuevo participante
         * @param {string} mesInscripcion - formato YYYYMM
         */
        function marcarMesesPagados(hoja, fila, mesInscripcion) {
            const headers = hoja.getRange(1, 1, 1, hoja.getLastColumn()).getValues()[0];

            // Filtrar solo las columnas que son meses tipo 202201, 202202, etc.
            const columnasMeses = headers.map((h, i) => ({
                nombre: h,
                col: i + 1
            })).filter(c => /^\d{6}$/.test(c.nombre));

            // Colocar "X" en todos los meses anteriores al mes de inscripci√≥n
            columnasMeses.forEach(colObj => {
                if (Number(colObj.nombre) < Number(mesInscripcion)) {
                    hoja.getRange(fila, colObj.col).setValue("X");
                }
            });
        }

    </script>
    <script>
        // *****************************************************************
        // ***** REEMPLAZA ESTA URL con la de tu Despliegue de Apps Script *****
        // *****************************************************************
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzTbndAlOOlEx17kTLQPVEAsutMFQo5HoL5mAEsT59SUDlmmLyez6KECK8Lf5Md-8rn/exec';
        // Usa la URL de tu despliegue de Apps Script

        // Variables de estado global
        let userRole = null;
        let userResponsible = null;
        let userFilterValue = null;
        let userFilterType = null;
        let allParticipants = [];
        let allParticipantsHeaders = [];
        let allParticipantsMap = {}; // C√≥digo -> {Participante, Tutora, etc}
        let financialSummary = {};
        let historyData = []; // Para historial de aportes

        // Constantes para nombres de columnas
        const participantCodeName = 'CODIGO';
        const participantNameName = 'PARTICIPANTE';
        const participantTutoraName = 'TUTORA';
        const participantNacionalidadName = 'NACIONALIDAD';

        // Elementos del DOM - Aportes
        const paymentForm = document.getElementById('paymentForm');
        const paymentParticipantCodeInput = document.getElementById('paymentParticipantCode');
        const amountPaidInput = document.getElementById('amountPaid');
        const monthsToPayList = document.getElementById('monthsToPayList');
        const totalCostValueEl = document.getElementById('totalCostValue');
        const abonoBalanceValueEl = document.getElementById('abonoBalanceValue');
        const abonoSurplusValueEl = document.getElementById('abonoSurplusValue');
        const monthlyCostValueEl = document.getElementById('monthlyCostValue');
        const submitPaymentButton = document.getElementById('submitPaymentButton');
        const selectedParticipantNameEl = document.getElementById('selectedParticipantName');
        const totalPendingDebtValueEl = document.getElementById('totalPendingDebtValue');
        const pendingMonthsCountEl = document.getElementById('pendingMonthsCount');

        // Elementos del DOM - Dashboard
        let dashboardCharts = {}; // Para almacenar instancias de Chart.js
        const chartContributionsByTutorCtx = document.getElementById('chartContributionsByTutor').getContext('2d');
        const chartNationalityDistributionCtx = document.getElementById('chartNationalityDistribution').getContext('2d');

        // Elementos del DOM - Historial de Aportes
        const historyFilterText = document.getElementById('historyFilterText');
        const historyFilterMonth = document.getElementById('historyFilterMonth');
        const historyFilterYear = document.getElementById('historyFilterYear');
        const historyFilterTutora = document.getElementById('historyFilterTutora');
        const contributionHistoryTableBody = document.getElementById('contributionHistoryTableBody');

        // Elementos del DOM - Notas
        const noteFilterCodeInput = document.getElementById('noteFilterCode');
        const notesListContainer = document.getElementById('notesListContainer');

        // Nuevos elementos para CRUD
        const crudParticipantTableHeaders = document.getElementById('crudParticipantTableHeaders');
        const crudParticipantsTableBody = document.getElementById('crudParticipantsTableBody');
        const editModal = document.getElementById('editModal');
        const editFormFields = document.getElementById('editFormFields');
        const editCodeInput = document.getElementById('edit-CODIGO');
        const editMessage = document.getElementById('editMessage');
        const adminUpdateForm = document.getElementById('adminUpdateForm');
        const adminUpdateMessage = document.getElementById('adminUpdateMessage');

        // Funci√≥n para formatear YYYYMM (Ej: 202409 -> Sep/24)
        function formatYearMonthShort(ym) {
            if (!/^\d{6}$/.test(ym)) return ym;
            const year = ym.substring(2, 4);
            const month = ym.substring(4);
            const date = new Date(ym.substring(0, 4), month - 1, 1);
            const monthName = date.toLocaleDateString('es-ES', { month: 'short' }).substring(0, 3);
            return monthName.charAt(0).toUpperCase() + monthName.slice(1) + '/' + year;
        }

        /**
         * Renderiza la tabla completa con acciones para la secci√≥n CRUD.
         */
        function renderCrudTable(participants, headers) {
            crudParticipantTableHeaders.innerHTML = '';
            crudParticipantsTableBody.innerHTML = '';

            if (participants.length === 0) {
                crudParticipantsTableBody.innerHTML = '<tr><td colspan="100">No se encontraron participantes.</td></tr>';
                return;
            }

            // Encabezados que el usuario quiere ver, incluyendo los nuevos de fecha
            let baseHeaders = ['CODIGO', 'PARTICIPANTE', 'NACIONALIDAD', 'TUTORA', 'COSTO_MENSUAL', 'MES_INSCRIPCION', 'URL_ID'];
            // Obtener y ordenar los encabezados de mes (YYYYMM)
            const visibleHeaders = [...baseHeaders, 'ACCIONES'];

            // Renderizar Encabezados
            visibleHeaders.forEach(header => {
                const th = document.createElement('th');
                if (/^\d{6}$/.test(header)) {
                    th.textContent = formatYearMonthShort(header);
                } else {
                    th.textContent = header.replace('_', ' ');
                }
                crudParticipantTableHeaders.appendChild(th);
            });

            // Renderizar Filas
            participants.forEach(participant => {
                const tr = document.createElement('tr');
                visibleHeaders.forEach(header => {
                    const td = tr.insertCell();
                    let value = participant[header] || '';

                    if (header === 'ACCIONES') {
                        td.innerHTML = `
    <button 
        class="primary-button" 
        style="padding: 5px 10px; font-size: 12px; background-color: var(--primary-color);" 
        onclick="openEditModal('${participant.CODIGO}')">
        ‚úèÔ∏è Editar
    </button>
    <button 
        class="primary-button" 
        style="padding: 5px 10px; font-size: 12px; margin-left: 5px; background-color: var(--accent-color);" 
        onclick="openDetailModal('${participant.CODIGO}')">
        üîç Detalle
    </button>
    <button 
        class="action-button delete" 
        style="margin-left: 5px; padding: 5px 10px; font-size: 12px;" 
        onclick="deleteParticipant('${participant.CODIGO}', '${participant.PARTICIPANTE}')">
        üóëÔ∏è Eliminar
    </button>
    <button 
        class="icon-button" 
        title="Copiar enlace de acceso del participante"
        onclick="copyParticipantURL('${participant.URL_ID}')">üîó
    </button>
`;

                    } else if (/^\d{6}$/.test(header)) {
                        if (value.toString().toUpperCase() === 'X') {
                            td.classList.add('paid');
                            td.textContent = 'X';
                        } else if (value.toString().trim() !== '') {
                            td.textContent = value;
                        } else {
                            td.textContent = '';
                        }
                    } else if (header === 'COSTO_MENSUAL' || header === 'ABONO_ACUMULADO') {
                        td.textContent = formatCurrency(parseFloat(value));
                    } else {
                        td.textContent = value;
                    }
                });
                crudParticipantsTableBody.appendChild(tr);
            });
        }

        // --- Funciones de Utilidad y Core ---

        function showToast(message, type = 'info') {
            let toast = document.getElementById('toast');
            const style = getComputedStyle(document.documentElement);
            const dangerColor = style.getPropertyValue('--danger-color').trim();
            const accentColor = style.getPropertyValue('--accent-color').trim();

            toast.textContent = message;
            toast.style.backgroundColor = type === 'error' ? dangerColor : type === 'success' ? accentColor : '#ffc107';
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
            }, 3500);
        }

        async function fetchData(action, data = {}, method = 'GET') {
            let url = `${WEB_APP_URL}?action=${action}`;
            let options = { method: method, redirect: 'follow' };
            const params = new URLSearchParams(data);

            if (method === 'GET') {
                url += '&' + params.toString();
            } else if (method === 'POST') {
                options.headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
                options.body = params.toString();
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status === 'error') {
                    showToast(result.message, 'error');
                }
                return result;
            } catch (error) {
                showToast(`Error de conexi√≥n (fetch): ${error.message}`, 'error');
                console.error("Fetch Error:", error);
                return { status: 'error', message: `Error de conexi√≥n: ${error.message}` };
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            // Buscar el bot√≥n por su onclick attribute
            const targetButton = document.querySelector(`.tab-buttons button[onclick="showTab('${tabId}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            if (tabId === 'notesSection' && (userRole === 'ADMIN' || userRole === 'TUTORA')) {
                loadNotes(noteFilterCodeInput.value.trim());
            } else if (tabId === 'dashboard' && (userRole === 'ADMIN' || userRole === 'TUTORA')) {
                loadDashboardData();
            } else if (tabId === 'paymentsSection' && (userRole === 'ADMIN' || userRole === 'TUTORA')) {
                loadContributionHistory('');
            }
        }

        // Esta funci√≥n es necesaria para el filtro din√°mico de notas (que sigue siendo un input de texto)
        function getParticipantCodeFromNameOrCode(input) {
            const trimmedInput = input.trim();

            // 1. INTENTO DE DATALIST (Formato: "CODIGO - Nombre Completo")
            // Lo mantenemos aunque no haya datalist, por si el usuario escribe el formato completo.
            const parts = trimmedInput.split(' - ');
            const codeFromDatalist = parts[0];

            // Si se encontr√≥ el c√≥digo del formato datalist Y es v√°lido en el mapa
            if (allParticipantsMap[codeFromDatalist]) {
                return codeFromDatalist;
            }

            // 2. INTENTO DIRECTO (Input es solo el CODIGO)
            if (allParticipantsMap[trimmedInput]) {
                return trimmedInput;
            }

            // 3. FALLBACK (Input es solo el Nombre Completo)
            const foundByName = allParticipants.find(p => p[participantNameName] === trimmedInput);
            return foundByName ? foundByName[participantCodeName] : null;
        }

        function formatYearMonth(ym) {
            if (!ym || ym.length !== 6) return ym;
            const year = ym.substring(0, 4);
            const month = ym.substring(4, 6);
            const date = new Date(year, month - 1, 1);
            return dateFns.format(date, 'MMMM YYYY');
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) return '$0.00';
            return `$${amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
        }

        // --- L√≥gica de Autenticaci√≥n y Setup ---

        function setupApp(role) {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', active: true },
                { id: 'paymentsSection', name: 'Aportes (Pago)' },
                { id: 'notesSection', name: 'Notas' }
            ];
            if (role === 'ADMIN') {
                tabs.push({ id: 'participantCrudSection', name: 'Participantes (CRUD)' });
            }

            const tabButtonsContainer = document.getElementById('tabButtons');

            // CORRECCI√ìN: Obtener la referencia al bot√≥n de logout ANTES de limpiar el contenedor
            const logoutButton = document.getElementById('logoutButton');

            tabButtonsContainer.innerHTML = '';

            tabs.forEach(tab => {
                const btn = document.createElement('button');
                btn.className = `tab-button ${tab.active ? 'active' : ''}`;
                btn.textContent = tab.name;
                btn.setAttribute('onclick', `showTab('${tab.id}')`);
                tabButtonsContainer.appendChild(btn);
            });

            // CORRECCI√ìN: Re-insertar la referencia del bot√≥n (que a√∫n es un Node v√°lido)
            if (logoutButton) {
                tabButtonsContainer.appendChild(logoutButton);
            }

            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'flex';

            if (tabs.length > 0) {
                showTab(tabs[0].id);
            }
        }

        // --- L√≥gica de Carga y Renderizado General ---
        async function loadParticipantsAndRender() {
            const result = await fetchData('getParticipants', {
                role: userRole,
                filterValue: userFilterValue,
                filterType: userFilterType
            }, 'GET');

            if (result.status === 'success') {
                allParticipants = result.data || [];
                allParticipantsHeaders = result.headers || [];
                allParticipantsMap = {};

                // Construir el mapa para b√∫squedas r√°pidas (Ej: CODIGO -> {datos})
                allParticipants.forEach(p => {
                    allParticipantsMap[p[participantCodeName]] = p;
                });

                // INICIO: L√ìGICA PARA POBLAR SELECTS (Pagos, Notas, Eliminar, Admin Update)
                // Se asume que las variables 'participantCodeName' (Ej: 'CODIGO') y 'participantNameName' (Ej: 'PARTICIPANTE') est√°n definidas globalmente.
                const selectIds = ['paymentParticipantCode', 'noteParticipantCode', 'deleteCode', 'adminCode'];

                selectIds.forEach(id => {
                    const selectEl = document.getElementById(id);
                    if (selectEl) {
                        // 1. Limpiar y asegurar la opci√≥n por defecto
                        selectEl.innerHTML = '<option value="">-- Seleccionar Participante --</option>';

                        // 2. Insertar todas las opciones (C√ìDIGO - NOMBRE)
                        allParticipants.forEach(p => {
                            const optEl = document.createElement('option');
                            optEl.value = p[participantCodeName]; // El valor es solo el C√ìDIGO
                            optEl.textContent = `${p[participantCodeName]} - ${p[participantNameName]}`; // El texto es CODIGO - NOMBRE
                            selectEl.appendChild(optEl);
                        });
                    }
                });
                // FIN: L√ìGICA PARA POBLAR SELECTS

                // 1. Renderizar la tabla principal de Participantes (Dashboard/Vista simple)
                renderParticipantsTable(allParticipants, allParticipantsHeaders);

                // 2. Renderizar la tabla CRUD (Con Edici√≥n/Eliminaci√≥n)
                // Es crucial para la nueva secci√≥n de Administraci√≥n.
                if (userRole === 'ADMIN') {
                    renderCrudTable(allParticipants, allParticipantsHeaders);
                }

                if (userRole === 'ADMIN' || userRole === 'TUTORA') {
                    // Solo si est√° en el m√≥dulo de Pagos, actualiza el resumen del primer participante
                    if (allParticipants.length > 0 && document.getElementById('paymentsSection').classList.contains('active')) {
                        // Asigna el C√ìDIGO del primer participante al SELECT y carga su resumen
                        document.getElementById('paymentParticipantCode').value = allParticipants[0][participantCodeName];
                        await loadFinancialSummary(allParticipants[0][participantCodeName]);
                    }
                    // Si est√° en Dashboard, recarga los datos
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadDashboardData();
                    }
                }

                showToast(`Carga de ${allParticipants.length} participantes exitosa.`, 'success');
            } else {
                showToast(result.message, 'error');
            }
        }

        function renderParticipantsTable(participants, headers) {
            const participantTableHeaders = document.getElementById('participantTableHeaders');
            const participantsTableBody = document.getElementById('participantsTableBody');

            participantTableHeaders.innerHTML = '';
            participantsTableBody.innerHTML = '';

            if (participants.length === 0) {
                participantsTableBody.innerHTML = '<tr><td colspan="100">No se encontraron participantes.</td></tr>';
                return;
            }

            let baseHeaders = ['CODIGO', 'PARTICIPANTE', 'TUTORA'];
            const monthHeaders = headers.filter(h => /^\d{6}$/.test(h.toString())).sort();
            const visibleHeaders = [...baseHeaders, 'ABONO_ACUMULADO', ...monthHeaders];

            visibleHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                if (/^\d{6}$/.test(header)) {
                    th.textContent = formatYearMonth(header).substring(0, 3) + '/' + header.substring(2, 4);
                }
                participantTableHeaders.appendChild(th);
            });

            participants.forEach(participant => {
                const tr = document.createElement('tr');
                visibleHeaders.forEach(header => {
                    const td = document.createElement('td');
                    let value = participant[header] || '';
                    td.textContent = value;

                    if (/^\d{6}$/.test(header)) {
                        if (value.toString().toUpperCase() === 'X') {
                            td.classList.add('paid');
                        }
                    } else if (header === 'COSTO_MENSUAL' || header === 'ABONO_ACUMULADO') {
                        td.textContent = formatCurrency(parseFloat(value));
                    }

                    tr.appendChild(td);
                });
                participantsTableBody.appendChild(tr);
            });
        }

// --- L√≥gica del Dashboard (Charts) ---
async function loadDashboardData() {
    try {
        // Si es tutora, enviamos su nombre al backend para que devuelva SOLO sus datos
        const params = (userRole === 'TUTORA' && userResponsible) 
            ? { tutora: userResponsible } 
            : {};

        const result = await fetchData('getDashboardData', params, 'GET');

        if (result.status === 'success') {
            const data = result.data;

            // 1Ô∏è‚É£ M√©tricas principales
            document.getElementById('metricTotalParticipants').textContent = data.totalParticipants || 0;
            document.getElementById('metricMonthlyContribution').textContent = formatCurrency(data.monthlyContribution || 0);
            document.getElementById('metricParticipantsPaid').textContent = data.participantsPaid || 0;
            document.getElementById('metricParticipantsDebt').textContent = data.participantsDebt || 0;

            // 2Ô∏è‚É£ Gr√°ficos (usa tus funciones existentes)
            renderDashboardCharts(data.contributionsByTutor, data.nationalityDistribution);
        } else {
            showToast(result.message, 'error');
        }
    } catch (err) {
        console.error("Error al cargar dashboard:", err);
        showToast("Error al cargar dashboard.", "error");
    }
}


        function renderDashboardCharts(tutorData, nationalityData) {
            // Destruir instancias previas
            Object.values(dashboardCharts).forEach(chart => chart.destroy());
            dashboardCharts = {};

            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d', '#17a2b8', '#fd7e14'];

            // Chart 1: Aportes por Tutora (Barra)
            const tutorLabels = Object.keys(tutorData).map(t => t.split(' ')[0]); // Solo el primer nombre
            const tutorValues = Object.values(tutorData);

            dashboardCharts.tutorChart = new Chart(chartContributionsByTutorCtx, {
                type: 'bar',
                data: {
                    labels: tutorLabels,
                    datasets: [{
                        label: 'Aportes ($)',
                        data: tutorValues,
                        backgroundColor: colors.slice(0, tutorLabels.length),
                        borderColor: colors.slice(0, tutorLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 2: Distribuci√≥n por Nacionalidad (Pie)
            const nationalityLabels = Object.keys(nationalityData);
            const nationalityValues = Object.values(nationalityData);

            dashboardCharts.nationalityChart = new Chart(chartNationalityDistributionCtx, {
                type: 'doughnut',
                data: {
                    labels: nationalityLabels,
                    datasets: [{
                        label: 'Participantes',
                        data: nationalityValues,
                        backgroundColor: colors.slice(0, nationalityLabels.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        // --- L√≥gica del M√≥dulo de Aportes/Pagos Compuestos ---

        paymentParticipantCodeInput.addEventListener('change', async (e) => {
            // AL SER UN SELECT, EL VALUE ES DIRECTAMENTE EL C√ìDIGO
            const code = e.target.value;

            if (code && allParticipantsMap[code]) {
                selectedParticipantNameEl.textContent = allParticipantsMap[code][participantNameName];
                await loadFinancialSummary(code);
            } else {
                showToast('Seleccione un participante v√°lido.', 'error');
                selectedParticipantNameEl.textContent = '---';
                monthsToPayList.innerHTML = '<p>Seleccione un participante para cargar los meses.</p>';
                loadContributionHistory('');
            }
        });

        amountPaidInput.addEventListener('input', calculatePaymentSummary);
        monthsToPayList.addEventListener('change', calculatePaymentSummary);

        function renderMonthsCheckboxes(availableMonths, financialStatus) {
            monthsToPayList.innerHTML = '';

            // Ordenar los meses de m√°s antiguo a m√°s nuevo
            const sortedMonths = availableMonths.sort();

            sortedMonths.forEach(ym => {
                const isPaid = financialStatus[ym] === 'X';
                const label = formatYearMonth(ym);

                const item = document.createElement('label');
                item.className = `month-item ${isPaid ? 'paid' : 'pending'}`;

                item.innerHTML = `
                    <input type="checkbox" value="${ym}" ${isPaid ? 'checked disabled' : ''} style="margin-right: 5px;">
                    ${label}
                `;
                monthsToPayList.appendChild(item);
            });
        }


        async function loadFinancialSummary(code) {
            submitPaymentButton.disabled = true;
            monthsToPayList.innerHTML = '<p>Cargando estado financiero...</p>';

            const result = await fetchData('getParticipantFinancialSummary', { participantCode: code }, 'GET');

            if (result.status === 'success') {
                financialSummary = result;

                // üí∞ Calcular Deuda Pendiente TOTAL (versi√≥n mejorada)
                // ======================================================
                const hoy = new Date();
                const a√±oActual = hoy.getFullYear();
                const mesActual = String(hoy.getMonth() + 1).padStart(2, '0');
                const a√±oMesActual = `${a√±oActual}${mesActual}`; // Ej: 202511 (noviembre 2025)

                // Encontrar el √∫ltimo mes pagado con "X"
                const mesesPagados = Object.entries(result.financialStatus)
                    .filter(([ym, estado]) => estado === 'X')
                    .map(([ym]) => ym)
                    .sort(); // de menor a mayor

                let ultimoMesPagado = null;
                if (mesesPagados.length) {
                    ultimoMesPagado = mesesPagados[mesesPagados.length - 1];
                }

                // Determinar los meses pendientes desde el siguiente al √∫ltimo pagado hasta el actual
                const pendingMonths = result.availableMonths
                    .filter(ym => ym > ultimoMesPagado && ym <= a√±oMesActual);

                // Calcular deuda total
                const totalPendingDebt = pendingMonths.length * result.monthlyCost;

                // Mostrar en la interfaz
                totalPendingDebtValueEl.textContent = formatCurrency(totalPendingDebt);
                pendingMonthsCountEl.textContent = pendingMonths.length;


                // Renderizar Resumen
                document.getElementById('summaryCode').textContent = code;
                monthlyCostValueEl.textContent = formatCurrency(result.monthlyCost);
                abonoBalanceValueEl.textContent = formatCurrency(result.abonoBalance);

                renderMonthsCheckboxes(result.availableMonths, result.financialStatus);
                calculatePaymentSummary();
                submitPaymentButton.disabled = false;

                // Cargar historial de aportes para el participante seleccionado
                loadContributionHistory(code);
            } else {
                showToast(result.message, 'error');
                monthsToPayList.innerHTML = `<p style="color: var(--danger-color);">Error al cargar resumen: ${result.message}</p>`;
            }
        }

        function calculatePaymentSummary() {
            if (!financialSummary.monthlyCost) return;

            const montoEntregado = parseFloat(amountPaidInput.value) || 0;
            const abonoAnterior = financialSummary.abonoBalance || 0;
            const costoMensual = financialSummary.monthlyCost;

            const monthsToPay = Array.from(monthsToPayList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
                .filter(ym => financialSummary.financialStatus[ym] !== 'X');

            const totalCostoMeses = monthsToPay.length * costoMensual;
            const totalFondo = abonoAnterior + montoEntregado;
            const nuevoAbono = totalFondo - totalCostoMeses;

            totalCostValueEl.textContent = formatCurrency(totalCostoMeses);
            abonoSurplusValueEl.textContent = formatCurrency(nuevoAbono);

            // Colores
            if (totalCostoMeses > 0 && nuevoAbono < 0) {
                abonoSurplusValueEl.classList.add('status-debt');
                abonoSurplusValueEl.classList.remove('status-abono');
            } else {
                abonoSurplusValueEl.classList.add('status-abono');
                abonoSurplusValueEl.classList.remove('status-debt');
            }

            // Deshabilitar bot√≥n si el nuevo abono es negativo o si no se hace nada
            submitPaymentButton.disabled = nuevoAbono < 0 || (totalCostoMeses === 0 && montoEntregado === 0 && abonoAnterior === 0);

            // Marcar visualmente los meses seleccionados para pago
            monthsToPayList.querySelectorAll('.month-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                item.classList.remove('pending-selected');
                if (!checkbox.disabled && checkbox.checked) {
                    item.classList.add('pending-selected');
                }
            });
        }

        // Listener de Formulario de Pago (Asegurarse de recargar los datos afectados)
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // SE OBTIENE EL C√ìDIGO DIRECTAMENTE DEL VALUE DEL SELECT
            const code = paymentParticipantCodeInput.value.trim();

            if (!code) {
                showToast('Seleccione un participante v√°lido.', 'error');
                return;
            }

            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            const mesesPagados = Array.from(monthsToPayList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value)
                .filter(ym => financialSummary.financialStatus[ym] !== 'X');
            const finalAbono = parseFloat(abonoSurplusValueEl.textContent.replace(/[$,]/g, '')) || 0;
            const paymentObservaciones = document.getElementById('paymentObservaciones').value;

            const data = {
                participantCode: code,
                amountPaid: amountPaid,
                mesesPagados: JSON.stringify(mesesPagados),
                finalAbono: finalAbono,
                paymentObservaciones: paymentObservaciones
            };

            const result = await fetchData('registerComplexPayment', data, 'POST');

            if (result.status === 'success') {
                showToast(result.message, 'success');
                paymentForm.reset();
                // Actualizaciones AS√çNCRONAS:
                await loadParticipantsAndRender(); // Recarga la tabla de dashboard
                await loadFinancialSummary(code); // Recarga el resumen del participante y el historial
            }
        });

        // --- L√≥gica de Historial de Aportes ---

        async function loadContributionHistory(codeFilter = '') {
            contributionHistoryTableBody.innerHTML = '<tr><td colspan="8">Cargando historial de aportes...</td></tr>';

            const result = await fetchData('getContributionHistory', {}, 'GET');

            if (result.status === 'success') {
                historyData = result.data.map(item => ({
                    ...item,
                    // Buscar nombre y tutora en el mapa local
                    PARTICIPANTE: allParticipantsMap[item.CODIGO_PARTICIPANTE] ? allParticipantsMap[item.CODIGO_PARTICIPANTE][participantNameName] : 'N/A',
                    TUTORA: allParticipantsMap[item.CODIGO_PARTICIPANTE] ? allParticipantsMap[item.CODIGO_PARTICIPANTE][participantTutoraName] : 'N/A',
                    FECHA_DATE: new Date(item.FECHA)
                }));
                applyHistoryFilters(codeFilter);
            } else {
                contributionHistoryTableBody.innerHTML = `<tr><td colspan="8">Error al cargar el historial: ${result.message}</td></tr>`;
            }

            // Inicializar los selects de mes y a√±o una sola vez
            if (historyFilterYear.options.length <= 1) {
                const currentYear = new Date().getFullYear();
                for (let i = 0; i < 3; i++) { historyFilterYear.options.add(new Option(currentYear - i, currentYear - i)); }
            }
            if (historyFilterMonth.options.length <= 1) {
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                monthNames.forEach((name, index) => {
                    historyFilterMonth.options.add(new Option(name, (index + 1).toString().padStart(2, '0')));
                });
            }
        }

        function applyHistoryFilters(initialCode = '') {
            const filterText = (initialCode || historyFilterText.value || '').trim().toLowerCase();
            const filterMonth = historyFilterMonth.value;
            const filterYear = historyFilterYear.value;
            const filterTutora = historyFilterTutora.value;

            let filteredData = historyData.filter(item => {
                const codeMatch = item.CODIGO_PARTICIPANTE.toLowerCase().includes(filterText);
                const nameMatch = item.PARTICIPANTE.toLowerCase().includes(filterText);

                const monthMatch = !filterMonth || dateFns.format(item.FECHA_DATE, 'MM') === filterMonth;
                const yearMatch = !filterYear || dateFns.format(item.FECHA_DATE, 'YYYY') === filterYear;
                const tutoraMatch = !filterTutora || item.TUTORA === filterTutora;

                return (codeMatch || nameMatch) && monthMatch && yearMatch && tutoraMatch;
            });

            renderContributionHistoryTable(filteredData);
        }

        function renderContributionHistoryTable(data) {
            contributionHistoryTableBody.innerHTML = '';
            if (data.length === 0) {
                contributionHistoryTableBody.innerHTML = '<tr><td colspan="8">No se encontraron aportes con los filtros aplicados.</td></tr>';
                return;
            }

            data.forEach(item => {
                const tr = document.createElement('tr');
                // Asegurarse de que el MONTO_PAGADO y ABONO_REMANENTE sean n√∫meros
                const montoPagado = parseFloat(item.MONTO_PAGADO) || 0;
                const abonoRemanente = parseFloat(item.ABONO_REMANENTE) || 0;

                tr.innerHTML = `
                     <td>${dateFns.format(item.FECHA_DATE, 'DD/MM/YYYY')}</td>
                     <td>${item.CODIGO_PARTICIPANTE}</td>
                     <td>${item.PARTICIPANTE}</td>
                     <td>${item.TUTORA}</td>
                     <td>${formatCurrency(montoPagado)}</td>
                     <td>${JSON.parse(item.MESES_CUBIERTOS || '[]').map(ym => formatYearMonth(ym).substring(0, 3)).join(', ')}</td>
                     <td>${formatCurrency(abonoRemanente)}</td>
                     <td>${item.OBSERVACIONES || ''}</td>
                 `;
                contributionHistoryTableBody.appendChild(tr);
            });
        }

        // Listeners para filtros del historial de aportes
        // Aseg√∫rate de que las variables historyFilter... est√©n definidas
        if (typeof historyFilterText !== 'undefined') {
            [historyFilterText, historyFilterMonth, historyFilterYear, historyFilterTutora].forEach(input => {
                input.addEventListener('input', () => applyHistoryFilters());
            });
        }

        // --- L√≥gica del M√≥dulo de Participantes (CRUD) ---

        // ============================
        // 1Ô∏è‚É£ BOT√ìN "AGREGAR PARTICIPANTE" (Modal)
        // ============================
        const btnAddParticipant = document.getElementById("btnAddParticipant");
        const addModal = document.getElementById("addParticipantModal");
        const closeAddModal = document.getElementById("closeAddModal");

        if (btnAddParticipant && addModal && closeAddModal) {
            btnAddParticipant.addEventListener("click", () => {
                document.getElementById("modalAddDate").textContent = new Date().toLocaleDateString("es-CO");
                addModal.style.display = "block";
            });
            closeAddModal.addEventListener("click", () => addModal.style.display = "none");
            window.addEventListener("click", (e) => { if (e.target === addModal) addModal.style.display = "none"; });
        }

        // ============================
        // 2Ô∏è‚É£ REGISTRAR NUEVO PARTICIPANTE (desde modal)
        // ============================
        // ============================
        // 2Ô∏è‚É£ REGISTRAR NUEVO PARTICIPANTE (desde modal)
        // ============================
        const addParticipantFormModal = document.getElementById('addParticipantFormModal');

        if (addParticipantFormModal) {
            addParticipantFormModal.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Obtener valores de los campos
                const codigo = document.getElementById('modalAddCode').value.trim().toUpperCase();
                const nombreCompleto = document.getElementById('modalAddName').value.trim();
                const nacionalidad = document.getElementById('modalAddNation').value;
                const tutora = document.getElementById('modalAddTutor').value;
                const costoMensual = document.getElementById('modalAddCost').value.trim() || '3000.00';
                const mesInscripcion = document.getElementById('modalAddMonth').value;
                const fechaInscripcion = new Date().toLocaleDateString("es-CO");

                // Generar URL_ID autom√°ticamente si est√° vac√≠o
                let urlId = document.getElementById('modalAddUrlId').value.trim();
                if (!urlId) {
                    const primerNombre = nombreCompleto.split(" ")[0] || "Usuario";
                    const ultimosTres = codigo.slice(-3) || "000";
                    urlId = `${primerNombre}${ultimosTres}`;
                }

                // Crear el objeto de datos a enviar
                const data = {
                    CODIGO: codigo,
                    PARTICIPANTE: nombreCompleto,
                    NACIONALIDAD: nacionalidad,
                    TUTORA: tutora,
                    URL_ID: urlId,
                    COSTO_MENSUAL: costoMensual,
                    ABONO_ACUMULADO: '0.00',
                    FECHA_INSCRIPCION: fechaInscripcion, // ‚úÖ Fecha actual en formato local
                    MES_INSCRIPCION: mesInscripcion      // ‚úÖ Mes elegido
                };

                // Enviar los datos al Apps Script
                const result = await fetchData('addParticipant', { data: JSON.stringify(data) }, 'POST');

                // Mostrar resultados
                if (result.status === 'success') {
                    showToast(`‚úÖ Participante ${nombreCompleto} agregado correctamente.`, 'success');
                    addParticipantFormModal.reset();
                    document.getElementById("addParticipantModal").style.display = "none";
                    await loadParticipantsAndRender();
                } else {
                    showToast('‚ùå Error al registrar participante: ' + result.message, 'error');
                }
            });
        }



        // ============================
        // 3Ô∏è‚É£ MODAL DE EDICI√ìN
        // ============================
        function openEditModal(code) {
            const participant = allParticipantsMap[code];
            if (!participant) {
                showToast('No se encontr√≥ el participante.', 'error');
                return;
            }

            const modal = document.getElementById("editParticipantModal");
            document.getElementById("editCodigo").value = participant.CODIGO;
            document.getElementById("editNombre").value = participant.PARTICIPANTE;
            document.getElementById("editNacionalidad").value = participant.NACIONALIDAD;
            document.getElementById("editTutora").value = participant.TUTORA;
            document.getElementById("editUrl").value = participant.URL_ID;
            document.getElementById("editCostoMensual").value = participant.COSTO_MENSUAL || 0;
            document.getElementById("editAbono").value = participant.ABONO_ACUMULADO || 0;

            modal.style.display = "block";

            const closeBtn = document.getElementById("closeEditParticipantModal");
            closeBtn.onclick = () => modal.style.display = "none";
            window.onclick = (event) => { if (event.target === modal) modal.style.display = "none"; };
        }

        const editParticipantForm = document.getElementById("editParticipantForm");
        if (editParticipantForm) {
            editParticipantForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                const code = document.getElementById("editCodigo").value.trim();
                const updatedData = {
                    CODIGO: code,
                    PARTICIPANTE: document.getElementById("editNombre").value.trim(),
                    NACIONALIDAD: document.getElementById("editNacionalidad").value,
                    TUTORA: document.getElementById("editTutora").value,
                    URL_ID: document.getElementById("editUrl").value,
                    COSTO_MENSUAL: document.getElementById("editCostoMensual").value,
                    ABONO_ACUMULADO: document.getElementById("editAbono").value,
                    MES_INSCRIPCION: document.getElementById("editMesInscripcion").value
                };


                const result = await fetchData('updateParticipant', { data: JSON.stringify(updatedData) }, 'POST');
                // Nota: si tu Apps Script tiene una funci√≥n espec√≠fica para editar, reemplaza 'addParticipant' por 'updateParticipant'

                if (result.status === 'success') {
                    showToast('Cambios guardados correctamente.', 'success');
                    document.getElementById("editParticipantModal").style.display = "none";
                    await loadParticipantsAndRender();
                } else {
                    showToast('Error al guardar cambios: ' + result.message, 'error');
                }
            });
        }

        // Llenar din√°micamente el select de Mes de Inscripci√≥n (desde 2022 a 2028)
        function fillMonthSelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '<option value="">Seleccione mes...</option>';

            const currentYear = new Date().getFullYear();
            const startYear = 2022;
            const endYear = currentYear + 3;
            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];

            for (let y = startYear; y <= endYear; y++) {
                for (const m of months) {
                    const value = `${y}${m}`;
                    const label = `${m}/${y}`;
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    select.appendChild(option);
                }
            }
        }

        // Ejecutar cuando se abre el modal
        function openEditModal(code) {
            const participant = allParticipantsMap[code];
            if (!participant) {
                showToast('No se encontr√≥ el participante.', 'error');
                return;
            }

            fillMonthSelect('editMesInscripcion');

            const modal = document.getElementById("editParticipantModal");
            document.getElementById("editCodigo").value = participant.CODIGO;
            document.getElementById("editNombre").value = participant.PARTICIPANTE;
            document.getElementById("editNacionalidad").value = participant.NACIONALIDAD;
            document.getElementById("editTutora").value = participant.TUTORA;
            document.getElementById("editUrl").value = participant.URL_ID;
            document.getElementById("editCostoMensual").value = participant.COSTO_MENSUAL || 0;
            document.getElementById("editAbono").value = participant.ABONO_ACUMULADO || 0;
            document.getElementById("editMesInscripcion").value = participant.MES_INSCRIPCION || '';

            modal.style.display = "block";

            const closeBtn = document.getElementById("closeEditParticipantModal");
            closeBtn.onclick = () => modal.style.display = "none";
            window.onclick = (event) => { if (event.target === modal) modal.style.display = "none"; };
        }


        // ============================
        // üåç DETALLE DEL PARTICIPANTE (Profesional y organizado)
        // ============================
        async function openDetailModal(code) {
            const participant = allParticipantsMap[code];
            if (!participant) {
                showToast('No se encontr√≥ el participante.', 'error');
                return;
            }

            const modal = document.getElementById("detailModal");
            const infoDiv = document.getElementById("detailParticipantInfo");
            const finDiv = document.getElementById("detailFinancial");
            const payDiv = document.getElementById("detailPayments");
            const noteDiv = document.getElementById("detailNotes");

            // üé® Colores por nacionalidad (banderas principales)
            const flagColors = {
                "Colombia": ["#FFD700", "#0033A0", "#CE1126"],
                "Venezuela": ["#FCE100", "#0033A0", "#E61E26"],
                "Peru": ["#D91023", "#FFFFFF", "#D91023"],
                "Brasil": ["#009739", "#FEDD00", "#002776"],
                "Ecuador": ["#FFD100", "#0057A0", "#EF3340"],
                "Otro": ["#999", "#ccc", "#999"]
            };
            const colors = flagColors[participant.NACIONALIDAD] || flagColors["Otro"];
            const gradient = `linear-gradient(90deg, ${colors[0]}, ${colors[1]}, ${colors[2]})`;

            // üßæ Informaci√≥n general
            infoDiv.innerHTML = `
    <div style="background:${gradient}; color:#fff; padding:10px 15px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:15px;">
      ${participant.NACIONALIDAD.toUpperCase()}
    </div>

    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px;">
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
        <p><strong>C√≥digo:</strong> ${participant.CODIGO}</p>
        <p><strong>Nombre:</strong> ${participant.PARTICIPANTE}</p>
        <p><strong>Tutora:</strong> ${participant.TUTORA}</p>
        <p><strong>URL ID:</strong> ${participant.URL_ID || '-'}</p>
      </div>
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
        <p><strong>Costo Mensual:</strong> $${participant.COSTO_MENSUAL}</p>
        <p><strong>Abono Acumulado:</strong> $${participant.ABONO_ACUMULADO}</p>
        <p><strong>Fecha Registro:</strong> ${participant.FECHA_REGISTRO || '-'}</p>
        <p><strong>Mes Inscripci√≥n:</strong> ${participant.MES_INSCRIPCION || '-'}</p>
      </div>
    </div>
  `;

            // üí∞ Estado financiero resumido
            const finRes = await fetchData('getParticipantFinancialSummary', { participantCode: code }, 'GET');
            if (finRes.status === 'success') {
                const deudaMeses = Object.entries(finRes.financialStatus).filter(([k, v]) => v !== 'X').length;
                finDiv.innerHTML = `
      <h3 style="margin-bottom:10px; color:#333;">üíµ Estado Financiero</h3>
      <div style="background:#f1f3f5; padding:15px; border-radius:8px;">
        <p><strong>Meses Pendientes:</strong> ${deudaMeses}</p>
      </div>
    `;
            } else {
                finDiv.innerHTML = `<p>Error al cargar resumen financiero.</p>`;
            }

            // üí≥ Historial de pagos mejorado
            const hist = await fetchData('getContributionHistory', {}, 'GET');
            if (hist.status === 'success') {
                const pagos = hist.data.filter(p => p.CODIGO_PARTICIPANTE === code);

                if (pagos.length) {
                    const pagosHTML = pagos.map(p => {
                        // Formatear meses en chips elegantes
                        let mesesArray = [];
                        try {
                            mesesArray = JSON.parse(p.MESES_CUBIERTOS || "[]");
                        } catch {
                            mesesArray = Array.isArray(p.MESES_CUBIERTOS) ? p.MESES_CUBIERTOS : [p.MESES_CUBIERTOS];
                        }

                        const mesesHTML = mesesArray.length
                            ? mesesArray.map(m => `
            <span style="
              display:inline-block;
              background:#007bff;
              color:white;
              padding:4px 8px;
              border-radius:12px;
              font-size:13px;
              margin:2px;
              font-weight:500;
            ">${m}</span>
          `).join('')
                            : `<span style="color:#777;">No especificado</span>`;

                        return `
        <div style="
          background:#f8f9fa;
          border:1px solid #dee2e6;
          border-radius:10px;
          padding:15px;
          margin-bottom:10px;
          box-shadow:0 1px 3px rgba(0,0,0,0.1);
        ">
          <p style="margin:4px 0;"><strong>üìÖ Fecha:</strong> ${new Date(p.FECHA).toLocaleDateString("es-CO")}</p>
          <p style="margin:4px 0;"><strong>üí∞ Monto Pagado:</strong> ${formatCurrency(p.MONTO_PAGADO)}</p>
          <p style="margin:6px 0;"><strong>üóìÔ∏è Meses Correspondientes:</strong></p>
          <div style="margin-top:5px;">${mesesHTML}</div>
        </div>
      `;
                    }).join('');

                    payDiv.innerHTML = `
      <h3 style="margin-bottom:12px; color:#333;">üí≥ Pagos Realizados</h3>
      ${pagosHTML}
    `;
                } else {
                    payDiv.innerHTML = `<h3>üí≥ Pagos Realizados</h3><p>No hay pagos registrados.</p>`;
                }
            } else {
                payDiv.innerHTML = `<p>Error al cargar historial de pagos.</p>`;
            }


            // üóíÔ∏è Notas y soluciones (versi√≥n mejorada y profesional)
            const notas = await fetchData('getNotes', { filterValue: code }, 'GET');
            if (notas.status === 'success') {
                const lista = notas.data.filter(n => n.CODIGO_PARTICIPANTE === code);

                if (lista.length) {
                    const notasHTML = lista.map(n => {
                        const tieneSolucion = n.SOLUCION && n.SOLUCION.trim() !== "";
                        return `
        <div style="
          background:#f9fafb;
          border:1px solid #e0e0e0;
          border-radius:10px;
          padding:15px 18px;
          margin-bottom:12px;
          box-shadow:0 1px 3px rgba(0,0,0,0.08);
          transition: all 0.2s ease-in-out;
        " onmouseover="this.style.transform='scale(1.01)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';" 
           onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)';">
          
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <h4 style="margin:0; color:#007bff; font-weight:600; font-size:16px;">
              üóÇÔ∏è ${n.TIPO}
            </h4>
            <span style="
              background:${tieneSolucion ? '#d1e7dd' : '#f8d7da'};
              color:${tieneSolucion ? '#0f5132' : '#842029'};
              font-size:13px;
              font-weight:600;
              padding:4px 10px;
              border-radius:12px;
              ">
              ${tieneSolucion ? '‚úÖ Resuelto' : '‚ö†Ô∏è Pendiente'}
            </span>
          </div>

          <p style="margin:8px 0 5px; color:#333; font-size:14px;">
            <strong>üìù Descripci√≥n:</strong> ${n.DESCRIPCION}
          </p>

          ${tieneSolucion ? `
            <div style="background:#e9f7ef; border-left:4px solid #198754; padding:10px; border-radius:6px; margin-top:6px;">
              <p style="margin:0; color:#155724; font-size:14px;">
                <strong>üí° Soluci√≥n:</strong> ${n.SOLUCION}
              </p>
            </div>` : ''
                            }

          <p style="margin-top:8px; font-size:13px; color:#555;">
            <strong>üë§ Registrado por:</strong> ${n.RESPONSABLE_REGISTRO || 'Desconocido'}
          </p>
        </div>
      `;
                    }).join('');

                    noteDiv.innerHTML = `
      <h3 style="margin-bottom:15px; color:#333;">üìù Notas y Soluciones</h3>
      ${notasHTML}
    `;
                } else {
                    noteDiv.innerHTML = `
      <h3 style="margin-bottom:10px;">üìù Notas y Soluciones</h3>
      <p style="color:#666;">No hay notas registradas.</p>
    `;
                }
            } else {
                noteDiv.innerHTML = `<p style="color:red;">Error al cargar notas.</p>`;
            }


            modal.style.display = "block";
            document.getElementById("closeDetailModal").onclick = () => modal.style.display = "none";
            window.onclick = (event) => { if (event.target === modal) modal.style.display = "none"; };
        }

        // --- L√≥gica del M√≥dulo de Notas ---

        // Listener de Formulario de Notas
        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // SE OBTIENE EL C√ìDIGO DIRECTAMENTE DEL VALUE DEL SELECT
            const code = document.getElementById('noteParticipantCode').value.trim();
            if (!code) { showToast('Seleccione un participante v√°lido.', 'error'); return; }

            const fecha = document.getElementById('noteFecha').value;
            const tipo = document.getElementById('noteTipo').value;
            const descripcion = document.getElementById('noteDescripcion').value;

            const result = await fetchData('registerNote', {
                code, fecha, tipo, descripcion, responsable: userResponsible
            }, 'POST');

            if (result.status === 'success') {
                showToast('Nota registrada. ' + result.message, 'success');
                document.getElementById('noteForm').reset();
                // Aseg√∫rate de que la fecha se reinicie correctamente
                document.getElementById('noteFecha').value = dateFns.format(new Date(), 'YYYY-MM-DD');
                // Recarga las notas filtrando por el participante registrado (o todas si es ADMIN/TUTORA)
                loadNotes(userRole === 'PARTICIPANTE' ? userFilterValue : code);
            } else {
                showToast('Error al registrar nota: ' + result.message, 'error');
            }
        });

        // Listener para el filtro de notas (funciona por c√≥digo o nombre)
        // Se asume que 'noteFilterCodeInput' es el input de texto donde se escribe el filtro.
        if (typeof noteFilterCodeInput !== 'undefined') {
            noteFilterCodeInput.addEventListener('input', (e) => {
                const fullInput = e.target.value.trim();
                // Esta funci√≥n se mantiene porque el filtro sigue siendo un INPUT DE TEXTO que usa datalist (o simple texto)
                const code = getParticipantCodeFromNameOrCode(fullInput) || fullInput;
                loadNotes(code);
            });
        }
        async function loadNotes(filterValue = '') {
            if (userRole === 'PARTICIPANTE' && userFilterValue) {
                filterValue = userFilterValue;
            } else if (!userRole) {
                return;
            }

            notesListContainer.innerHTML = '<p>Cargando notas...</p>';

            const result = await fetchData('getNotes', { filterValue }, 'GET');

            if (result.status === 'success') {
                renderNotes(result.data);
            } else {
                notesListContainer.innerHTML = `<p style="color: var(--danger-color);">${result.message}</p>`;
            }
        }

        function renderNotes(notes) {
            notesListContainer.innerHTML = '';
            if (notes.length === 0) {
                notesListContainer.innerHTML = '<p>No se encontraron notas registradas.</p>';
                return;
            }

            notes.sort((a, b) => new Date(b.FECHA) - new Date(a.FECHA));

            notes.forEach(note => {
                const isSolved = !!note.SOLUCION;
                const participantCode = note.CODIGO_PARTICIPANTE;
                const participantName = allParticipantsMap[participantCode] ? allParticipantsMap[participantCode][participantNameName] : 'N/A';
                // La fecha puede venir como objeto Date o string, la normalizamos
                const dateObj = note.FECHA instanceof Date ? note.FECHA : new Date(note.FECHA);
                const formattedDate = dateFns.format(dateObj, 'DD/MM/YYYY');

                const noteCard = document.createElement('div');
                noteCard.className = `note-card ${note.TIPO} ${isSolved ? 'Solucionada' : ''}`;

                let actionsHtml = '';
                if (userRole === 'ADMIN' || userRole === 'TUTORA') {
                    actionsHtml = `
                        <div class="note-actions" style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="action-button edit solution-btn" data-id="${note.ID}">
                                 ${isSolved ? 'Editar Soluci√≥n' : 'A√±adir Soluci√≥n'}
                            </button>
                            <button class="action-button delete delete-note-btn" data-id="${note.ID}">Eliminar</button>
                        </div>
                        <form class="note-solution-form" data-id="${note.ID}" style="display: none;">
                            <textarea name="solutionText" rows="2" placeholder="Escriba la soluci√≥n/respuesta...">${note.SOLUCION || ''}</textarea>
                            <button type="submit" class="secondary-button" style="margin-top: 5px;">Guardar Soluci√≥n</button>
                        </form>
                    `;
                }

                noteCard.innerHTML = `
                    <h4>${note.TIPO}${isSolved ? ' (SOLUCIONADA)' : ''} - ${participantName} (${participantCode})</h4>
                    <p style="font-size: 0.9em; color: var(--secondary-color);">Fecha: ${formattedDate} | Registrado por: ${note.RESPONSABLE_REGISTRO}</p>
                    <p><strong>Descripci√≥n:</strong> ${note.DESCRIPCION}</p>
                    
                    ${isSolved ? `<div class="solution-text" style="margin-top: 10px; padding: 5px; border-left: 3px solid #6f42c1; background-color: #f8f6ff;"><strong>Soluci√≥n:</strong> ${note.SOLUCION}</div>` : ''}
                    ${actionsHtml}
                `;
                notesListContainer.appendChild(noteCard);
            });

            // Re-adjuntar listeners de soluci√≥n y eliminar solo si el rol lo permite
            if (userRole === 'ADMIN' || userRole === 'TUTORA') {
                notesListContainer.querySelectorAll('.solution-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const form = notesListContainer.querySelector(`.note-solution-form[data-id="${btn.dataset.id}"]`);
                        form.style.display = form.style.display === 'none' ? 'block' : 'none';
                    });
                });

                notesListContainer.querySelectorAll('.note-solution-form').forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const noteId = form.dataset.id;
                        const solution = form.querySelector('textarea[name="solutionText"]').value;

                        const result = await fetchData('updateNoteSolution', {
                            noteId, solution, responsible: userResponsible
                        }, 'POST');
                        if (result.status === 'success') {
                            showToast(result.message, 'success');
                            loadNotes(noteFilterCodeInput.value.trim()); // Actualizaci√≥n as√≠ncrona
                        }
                    });
                });

                notesListContainer.querySelectorAll('.delete-note-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const noteId = btn.dataset.id;
                        if (!confirm('¬øEst√° seguro de eliminar esta nota?')) return;

                        const result = await fetchData('deleteNote', { noteId }, 'POST');
                        if (result.status === 'success') {
                            showToast(result.message, 'success');
                            loadNotes(noteFilterCodeInput.value.trim()); // Actualizaci√≥n as√≠ncrona
                        }
                    });
                });
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('noteFecha').value = dateFns.format(new Date(), 'YYYY-MM-DD');

            // Adjuntar listeners de login
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                document.getElementById('loginMessage').textContent = 'Autenticando...';

                const result = await fetchData('authenticateUser', { username, password }, 'POST');

                if (result.status === 'success') {
                    userRole = result.role;
                    userResponsible = result.responsible;
                    userFilterValue = result.filterValue;
                    userFilterType = result.filterType;

                    document.getElementById('loginMessage').textContent = 'Acceso concedido.';

                    // LLAMA LA FUNCI√ìN CORREGIDA
                    setupApp(userRole);
                    await loadParticipantsAndRender();
                } else {
                    document.getElementById('loginMessage').textContent = result.message;
                }
            });

            // Listener para cerrar sesi√≥n
            document.getElementById('logoutButton').addEventListener('click', () => {
                userRole = null;
                userResponsible = null;
                userFilterValue = null;
                userFilterType = null;
                document.getElementById('appSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('loginForm').reset();
                showToast('Sesi√≥n cerrada correctamente.', 'info');
            });
        });
    </script>
    <script>
        /**
         * Funci√≥n global cliente para eliminar un participante.
         * Llamada desde botones en la tabla: onclick="deleteParticipant('CO0678...', 'Nombre')"
         */
        window.deleteParticipant = async function (code, name = '') {
            try {
                if (!code) {
                    showToast('C√≥digo inv√°lido.', 'error');
                    return;
                }

                const displayName = name || code;
                const confirmed = confirm(`¬øSeguro que deseas eliminar al participante ${displayName} (c√≥digo ${code})? Esta acci√≥n NO se puede deshacer.`);
                if (!confirmed) return;

                // Llamada al backend (usa tu fetchData ya definida)
                // Aseg√∫rate de que fetchData acepte (action, params, method)
                const result = await fetchData('deleteParticipant', { code }, 'POST');

                if (!result) {
                    showToast('Respuesta vac√≠a del servidor.', 'error');
                    return;
                }

                if (result.status && result.status === 'success') {
                    showToast(result.message || 'Participante eliminado correctamente.', 'success');

                    // Recargar participantes en la UI (funci√≥n que ya usas)
                    if (typeof loadParticipantsAndRender === 'function') {
                        await loadParticipantsAndRender();
                    } else {
                        // fallback: recargar la p√°gina si no existe la funci√≥n
                        location.reload();
                    }

                } else {
                    // Manejo de errores desde el servidor
                    const msg = (result && (result.message || result.error)) || 'Error al eliminar participante.';
                    showToast(msg, 'error');
                    console.error('deleteParticipant result error:', result);
                }

            } catch (err) {
                console.error('Error en deleteParticipant (cliente):', err);
                showToast('Error al eliminar participante: ' + (err.message || err), 'error');
            }
        };

        // ====================================================
// üéì CONTROL DE ACCESO PARA ADMIN Y TUTORA
// ====================================================

async function loadParticipantsAndRender() {
    const result = await fetchData('getParticipants', {
        role: userRole,
        filterValue: userFilterValue,
        filterType: userFilterType
    }, 'GET');

    if (result.status === 'success') {
        allParticipants = result.data || [];
        allParticipantsHeaders = result.headers || [];
        allParticipantsMap = {};

        // Crear mapa r√°pido (por c√≥digo)
        allParticipants.forEach(p => {
            allParticipantsMap[p[participantCodeName]] = p;
        });

        // üîπ Filtrar solo los participantes de la tutora (si aplica)
        if (userRole === 'TUTORA' && userResponsible) {
            allParticipants = allParticipants.filter(p =>
                (p.TUTORA || '').toLowerCase().trim() === userResponsible.toLowerCase().trim()
            );
        }

        // --- Renderizar todo normalmente ---
        renderParticipantsTable(allParticipants, allParticipantsHeaders);
        renderCrudTable(allParticipants, allParticipantsHeaders);
        loadDashboardData(); // ‚úÖ Ahora las tutoras tambi√©n ver√°n el Dashboard completo

        // --- Poblaci√≥n de selects ---
        const selectIds = ['paymentParticipantCode', 'noteParticipantCode', 'deleteCode', 'adminCode'];
        selectIds.forEach(id => {
            const selectEl = document.getElementById(id);
            if (selectEl) {
                selectEl.innerHTML = '<option value="">-- Seleccionar Participante --</option>';
                allParticipants.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p[participantCodeName];
                    opt.textContent = `${p[participantCodeName]} - ${p[participantNameName]}`;
                    selectEl.appendChild(opt);
                });
            }
        });

        // Si hay participantes y la pesta√±a de pagos est√° activa
        if (allParticipants.length > 0 && document.getElementById('paymentsSection').classList.contains('active')) {
            document.getElementById('paymentParticipantCode').value = allParticipants[0][participantCodeName];
            await loadFinancialSummary(allParticipants[0][participantCodeName]);
        }

        showToast(`Carga de ${allParticipants.length} participantes exitosa.`, 'success');
    } else {
        showToast(result.message, 'error');
    }
}

// ====================================================
// üß© CONFIGURACI√ìN DE TABS UNIVERSAL (ADMIN y TUTORA)
// ====================================================

function setupApp(role) {
    const tabs = [
        { id: 'dashboard', name: 'Dashboard', active: true },
        { id: 'paymentsSection', name: 'Aportes (Pago)' },
        { id: 'notesSection', name: 'Notas' },
        { id: 'participantCrudSection', name: 'Participantes (CRUD)' } // ‚úÖ Ambas lo tienen ahora
    ];

    const tabButtonsContainer = document.getElementById('tabButtons');
    const logoutButton = document.getElementById('logoutButton');

    tabButtonsContainer.innerHTML = '';

    tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = `tab-button ${tab.active ? 'active' : ''}`;
        btn.textContent = tab.name;
        btn.setAttribute('onclick', `showTab('${tab.id}')`);
        tabButtonsContainer.appendChild(btn);
    });

    if (logoutButton) {
        tabButtonsContainer.appendChild(logoutButton);
    }

    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('appSection').style.display = 'flex';

    if (tabs.length > 0) {
        showTab(tabs[0].id);
    }
}


    </script>

</body>

</html>
