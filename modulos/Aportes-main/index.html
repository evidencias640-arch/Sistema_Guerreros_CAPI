<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n Avanzada de Participantes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* Estilos Globales y Variables CSS */
        :root {
            --primary-color: #007bff; /* Azul para gesti√≥n */
            --secondary-color: #6c757d; /* Gris oscuro */
            --accent-color: #28a745; /* Verde para √©xito/Acciones */
            --danger-color: #dc3545; /* Rojo para eliminaci√≥n/Deuda */
            --background-light: #f8f9fa; /* Fondo claro */
            --background-dark: #343a40; /* Fondo oscuro para headers/footers */
            --text-color: #343a40;
            --light-text-color: #FFFFFF;
            --border-color: #dee2e6;
            --box-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.15);
            --border-radius-card: 12px;
            --border-radius-input: 8px;
            --transition-speed: 0.3s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: var(--background-light);
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Contenedores Principales */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--background-dark) 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-hover);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
            position: relative;
        }

        .app-container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 30px;
            display: none; /* Se mostrar√° con JS */
            flex-direction: column;
            gap: 25px;
            background: #fff;
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-light);
            width: 100%;
        }

        /* Dashboard Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-light);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.2s;
        }
        
        .metric-card.danger { border-left-color: var(--danger-color); }
        .metric-card.success { border-left-color: var(--accent-color); }

        .metric-card h4 {
            font-size: 0.9em;
            color: var(--secondary-color);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .metric-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-card {
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-light);
            min-height: 300px;
        }

        /* Contenido de las Pesta√±as */
        .tab-content {
            padding: 30px;
            border-radius: var(--border-radius-card);
            box-shadow: var(--box-shadow-light);
            display: none;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.6s ease-out;
            background-color: var(--background-light);
        }

        .tab-content.active {
            display: flex;
        }
        
        /* Resumen de Deuda en Aportes */
        .debt-summary-box {
            background-color: #ffe0e6; /* Fondo rojo claro para la deuda */
            border: 2px solid var(--danger-color);
            padding: 15px;
            border-radius: var(--border-radius-input);
            margin-top: 15px;
            font-size: 1.1em;
        }
        
        .debt-summary-box strong {
            color: var(--danger-color);
            font-size: 1.2em;
        }
        
        /* Tabla de Historial de Pagos */
        #contributionHistoryTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 800px;
        }
        
        #contributionHistoryTable th, #contributionHistoryTable td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        #contributionHistoryTable thead th {
             background-color: var(--secondary-color);
             color: var(--light-text-color);
             font-weight: 600;
             text-transform: uppercase;
        }
        
        /* Asegurar que los estilos de Toast est√©n aqu√≠ */
        #toast {
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            padding: 15px 20px; 
            border-radius: 8px; 
            color: white; 
            z-index: 1000; 
            opacity: 0; 
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(20px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: block;
        }

        /* Estilos de Botones y Formularios Adicionales */
        .primary-button {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius-input);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .action-button.delete {
            background-color: var(--danger-color);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            color: var(--light-text-color);
            transition: background-color 0.2s;
            border-radius: 6px 6px 0 0;
            font-weight: 500;
            margin-right: 5px;
        }

        .tab-buttons {
            display: flex;
            align-items: center;
            background-color: var(--background-dark);
            border-radius: 8px 8px 0 0;
            padding: 5px;
        }

        header {
            width: 100%;
            background-color: var(--background-dark);
            color: var(--light-text-color);
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow-light);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-input);
            margin-top: 5px;
        }
        
        /* Estilos de la tabla de participantes */
        .participants-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #fff;
            min-width: 800px;
        }

        .participants-table th, .participants-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .participants-table th {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            font-weight: 600;
        }

        .paid {
            background-color: #c8e6c9; /* Verde muy claro */
            font-weight: bold;
            color: var(--accent-color);
        }

        .month-item {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 10px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            background-color: #fff;
            transition: background-color 0.1s;
        }

        .month-item.paid {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            cursor: default;
        }
        
        .month-item.pending-selected {
            background-color: #ffe0b2; /* Naranja claro */
            border-color: #ffb74d;
        }
        
        .notes-list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .note-card {
            padding: 15px;
            border-radius: var(--border-radius-card);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 5px solid;
            background-color: #fff;
        }

        .note-card.Positiva { border-left-color: var(--accent-color); }
        .note-card.Aviso { border-left-color: var(--primary-color); }
        .note-card.Conducta { border-left-color: #ffc107; }
        .note-card.Academica { border-left-color: #17a2b8; }
        .note-card.General { border-left-color: var(--secondary-color); }
        .note-card.Solucionada { border-left-color: #6f42c1; background-color: #f3f0fb; }

    </style>
</head>

<body>
    <div id="loginSection" class="login-container">
        <div class="login-box">
            <h2>Acceder al Sistema de Gesti√≥n</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario / C√≥digo:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="primary-button" style="margin-top: 15px;">Iniciar Sesi√≥n</button>
            </form>
            <p id="loginMessage" style="color: var(--danger-color); margin-top: 15px; font-weight: 500;"></p>
        </div>
    </div>

    <div id="appSection" class="app-container">
        <header>
            <h1 id="appTitle">Gesti√≥n de Participantes</h1>
            <div class="tab-buttons" id="tabButtons">
                <button id="logoutButton" class="tab-button">Cerrar Sesi√≥n</button>
            </div>
        </header>

        <main id="mainContent">
            <section id="dashboard" class="tab-content active">
                <h2>Dashboard de Participantes y Finanzas üìä</h2>
                
                <div class="metrics-grid" id="dashboardMetrics">
                    <div class="metric-card success">
                        <h4>Total Participantes</h4>
                        <p id="metricTotalParticipants">0</p>
                    </div>
                     <div class="metric-card danger">
                        <h4>Valor Ingresado (Mes Actual)</h4>
                        <p id="metricMonthlyContribution">$0.00</p>
                    </div>
                    <div class="metric-card success">
                        <h4>Participantes Saldos OK</h4>
                        <p id="metricParticipantsPaid">0</p>
                    </div>
                    <div class="metric-card danger">
                        <h4>Participantes con Deuda</h4>
                        <p id="metricParticipantsDebt">0</p>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Aportes por Tutora (Mes Actual)</h3>
                        <canvas id="chartContributionsByTutor"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Distribuci√≥n por Nacionalidad</h3>
                        <canvas id="chartNationalityDistribution"></canvas>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Tabla Resumen Mensual</h3>
                <div class="table-container">
                    <table id="participantsTable" class="participants-table">
                        <thead>
                            <tr id="participantTableHeaders"></tr>
                        </thead>
                        <tbody id="participantsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="paymentsSection" class="tab-content">
                <h2>Registro de Aportes/Pagos Compuestos üí∞</h2>
                <form id="paymentForm">
                    <div class="form-grid">
                         <div class="form-group">
                            <label for="paymentParticipantCode">C√≥digo o Nombre del Participante:</label>
                            <select id="paymentParticipantCode" required>
                                <option value="">-- Seleccionar Participante --</option>
                            </select>
                            <p style="font-size: 0.9em; margin-top: 5px;">Participante Seleccionado: <strong id="selectedParticipantName">---</strong></p>
                        </div>
                        <div class="form-group">
                            <label for="amountPaid">Monto Entregado por Cliente (Ej: 10000.00):</label>
                            <input type="number" id="amountPaid" step="0.01" min="0" required>
                        </div>
                    </div>
                    
                    <div class="debt-summary-box">
                        <p>Deuda Total Pendiente (Meses Atrasados):</p>
                        <p><strong><span id="totalPendingDebtValue">$0.00</span></strong> (<span id="pendingMonthsCount">0</span> meses)</p>
                    </div>
                   
                    <div id="paymentSummary">
                        <h3>Resumen Financiero - <span id="summaryCode"></span></h3>
                        <p>Costo Mensual: <strong id="monthlyCostValue">Cargando...</strong></p>
                        <p>Saldo de Abono Anterior: <strong id="abonoBalanceValue">Cargando...</strong></p>
                        <p>Total a Pagar por Meses Seleccionados: <strong id="totalCostValue" class="status-debt">0.00</strong></p>
                        <p class="payment-status">Nuevo Saldo de Abono: <strong id="abonoSurplusValue" class="status-abono">0.00</strong></p>
                        <p style="margin-top: 10px; color: var(--danger-color); font-size: 0.9em;">**El sistema usar√° primero el Saldo de Abono Anterior.**</p>
                    </div>

                    <label style="margin-top: 15px;">Seleccionar Meses Pendientes (Bloqueado/Verde = Pagado):</label>
                    <div id="monthsToPayList">
                        <p>Seleccione un participante para cargar los meses.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentObservaciones">Observaciones (Opcional):</label>
                        <textarea id="paymentObservaciones" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="primary-button" id="submitPaymentButton" disabled>Registrar Aporte</button>
                </form>
                
                <h3 style="margin-top: 40px;">Historial de Aportes Registrados</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="historyFilterText" placeholder="C√≥digo o Nombre (din√°mico)..." style="flex: 2;">
                    <select id="historyFilterMonth" style="flex: 1;">
                        <option value="">Mes</option>
                        </select>
                    <select id="historyFilterYear" style="flex: 1;">
                        <option value="">A√±o</option>
                        </select>
                     <select id="historyFilterTutora" style="flex: 1;">
                        <option value="">Tutora</option>
                        <option value="Juliana Villamizar Ortiz">Juliana Villamizar Ortiz</option>
                        <option value="Diana Carolina Ure√±a Mendoza">Diana Carolina Ure√±a Mendoza</option>
                        <option value="Helen Abelyn Sanchez Herrera">Helen Abelyn Sanchez Herrera</option>
                        <option value="Yrany Lisbeth Martinez Perez">Yrany Lisbeth Martinez Perez</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table id="contributionHistoryTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>C√≥digo</th>
                                <th>Participante</th>
                                <th>Tutora</th>
                                <th>Monto Pagado</th>
                                <th>Meses Cubiertos</th>
                                <th>Abono Restante</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody id="contributionHistoryTableBody">
                            <tr><td colspan="8">Cargando historial de aportes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="participantCrudSection" class="tab-content">
                <h2>Administraci√≥n de Participantes (CRUD) üßë‚Äçüéì</h2>
                
                <h3>A√±adir Nuevo Participante</h3>
                <form id="addParticipantForm" class="form-grid">
                    <div class="form-group"><label for="addCode">C√≥digo:</label><input type="text" id="addCode" required></div>
                    <div class="form-group"><label for="addParticipant">Participante:</label><input type="text" id="addParticipant" required></div>
                    <div class="form-group">
                        <label for="addNacionalidad">Nacionalidad:</label>
                        <select id="addNacionalidad">
                            <option value="">Seleccione</option>
                            <option value="Colombia">Colombia</option>
                            <option value="Venezuela">Venezuela</option>
                            <option value="Peru">Per√∫</option>
                            <option value="Brasil">Brasil</option>
                            <option value="Ecuador">Ecuador</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addTutor">Tutor/a:</label>
                        <select id="addTutor">
                            <option value="">Seleccione</option>
                            <option value="Juliana Villamizar Ortiz">Juliana Villamizar Ortiz</option>
                            <option value="Diana Carolina Ure√±a Mendoza">Diana Carolina Ure√±a Mendoza</option>
                            <option value="Helen Abelyn Sanchez Herrera">Helen Abelyn Sanchez Herrera</option>
                            <option value="Yrany Lisbeth Martinez Perez">Yrany Lisbeth Martinez Perez</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="addUrlId">URL_ID (Acceso Padre):</label><input type="text" id="addUrlId"></div>
                    <div class="form-group" style="grid-column: 1 / -1;"><button type="submit" class="primary-button">Registrar Participante</button></div>
                </form>
                <p id="addParticipantMessage" style="margin-top: 15px; font-weight: 500;"></p>
                
                <h3 style="margin-top: 30px;">Eliminar Participante</h3>
                <form id="deleteParticipantForm" style="display: flex; gap: 10px; align-items: flex-end;">
                    <div class="form-group" style="flex-grow: 1;">
                        <label for="deleteCode">C√≥digo del Participante a Eliminar:</label>
                        <select id="deleteCode" required>
                            <option value="">-- Seleccionar C√≥digo --</option>
                        </select>
                        </div>
                    <button type="submit" class="action-button delete">Eliminar Participante</button>
                </form>
                <p id="deleteParticipantMessage" style="margin-top: 15px; font-weight: 500;"></p>
                
                <h3 style="margin-top: 30px;">Editar/Actualizar Estado Mensual (Admin - Para saldar)</h3>
                <form id="adminUpdateForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div class="form-group">
                        <label for="adminCode">C√≥digo:</label>
                        <select id="adminCode" required>
                            <option value="">-- Seleccionar C√≥digo --</option>
                        </select>
                        </div>
                    <div class="form-group">
                        <label for="adminYearMonth">Mes (YYYYMM):</label>
                        <input type="text" id="adminYearMonth" placeholder="Ej: 202310" required>
                    </div>
                    <div class="form-group">
                        <label for="adminValue">Valor (X para pago/OK, vac√≠o para pendiente):</label>
                        <input type="text" id="adminValue" placeholder="X o dejar vac√≠o">
                    </div>
                    <button type="submit" class="primary-button" style="align-self: flex-end;">Actualizar Mes</button>
                </form>
            </section>

            <section id="notesSection" class="tab-content">
                <h2>Registro de Notas/Observaciones üìù</h2>
                <form id="noteForm" class="form-grid">
                    <div class="form-group">
                        <label for="noteParticipantCode">C√≥digo o Nombre del Participante:</label>
                        <select id="noteParticipantCode" required>
                            <option value="">-- Seleccionar Participante --</option>
                        </select>
                        </div>
                    <div class="form-group">
                        <label for="noteFecha">Fecha:</label>
                        <input type="date" id="noteFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="noteTipo">Tipo de Nota:</label>
                        <select id="noteTipo" required>
                            <option value="Positiva">Positiva</option>
                            <option value="Aviso">Aviso</option>
                            <option value="Conducta">Conducta</option>
                            <option value="Academica">Acad√©mica</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="noteDescripcion">Descripci√≥n:</label>
                        <textarea id="noteDescripcion" rows="4" required></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;"><button type="submit" class="primary-button">Registrar Nota</button></div>
                </form>
                
                <h3 style="margin-top: 30px;">Notas Registradas (Acciones)</h3>
                <input type="text" id="noteFilterCode" placeholder="Filtrar por C√≥digo o Nombre (din√°mico)..." style="margin-bottom: 15px;">
                <div id="notesListContainer" class="notes-list-container">
                    <p>Cargue notas de un participante o todas las notas si es administrador/tutora.</p>
                </div>
            </section>
        </main>
    </div>
    
    <div id="toast"></div>

    <script src="animaciones.js"></script>
    <script>
        // *****************************************************************
        // ***** REEMPLAZA ESTA URL con la de tu Despliegue de Apps Script *****
        // *****************************************************************
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzTbndAlOOlEx17kTLQPVEAsutMFQo5HoL5mAEsT59SUDlmmLyez6KECK8Lf5Md-8rn/exec'; 
        // Usa la URL de tu despliegue de Apps Script

        // Variables de estado global
        let userRole = null;
        let userResponsible = null;
        let userFilterValue = null;
        let userFilterType = null;
        let allParticipants = [];
        let allParticipantsHeaders = [];
        let allParticipantsMap = {}; // C√≥digo -> {Participante, Tutora, etc}
        let financialSummary = {}; 
        let historyData = []; // Para historial de aportes
        
        // Constantes para nombres de columnas
        const participantCodeName = 'CODIGO';
        const participantNameName = 'PARTICIPANTE';
        const participantTutoraName = 'TUTORA';
        const participantNacionalidadName = 'NACIONALIDAD';
        
        // Elementos del DOM - Aportes
        const paymentForm = document.getElementById('paymentForm');
        const paymentParticipantCodeInput = document.getElementById('paymentParticipantCode');
        const amountPaidInput = document.getElementById('amountPaid');
        const monthsToPayList = document.getElementById('monthsToPayList');
        const totalCostValueEl = document.getElementById('totalCostValue');
        const abonoBalanceValueEl = document.getElementById('abonoBalanceValue');
        const abonoSurplusValueEl = document.getElementById('abonoSurplusValue');
        const monthlyCostValueEl = document.getElementById('monthlyCostValue');
        const submitPaymentButton = document.getElementById('submitPaymentButton');
        const selectedParticipantNameEl = document.getElementById('selectedParticipantName');
        const totalPendingDebtValueEl = document.getElementById('totalPendingDebtValue');
        const pendingMonthsCountEl = document.getElementById('pendingMonthsCount');
        
        // Elementos del DOM - Dashboard
        let dashboardCharts = {}; // Para almacenar instancias de Chart.js
        const chartContributionsByTutorCtx = document.getElementById('chartContributionsByTutor').getContext('2d');
        const chartNationalityDistributionCtx = document.getElementById('chartNationalityDistribution').getContext('2d');

        // Elementos del DOM - Historial de Aportes
        const historyFilterText = document.getElementById('historyFilterText');
        const historyFilterMonth = document.getElementById('historyFilterMonth');
        const historyFilterYear = document.getElementById('historyFilterYear');
        const historyFilterTutora = document.getElementById('historyFilterTutora');
        const contributionHistoryTableBody = document.getElementById('contributionHistoryTableBody');
        
        // Elementos del DOM - Notas
        const noteFilterCodeInput = document.getElementById('noteFilterCode');
        const notesListContainer = document.getElementById('notesListContainer');
        
        // --- Funciones de Utilidad y Core ---
        
        function showToast(message, type = 'info') {
            let toast = document.getElementById('toast');
            const style = getComputedStyle(document.documentElement);
            const dangerColor = style.getPropertyValue('--danger-color').trim();
            const accentColor = style.getPropertyValue('--accent-color').trim();

            toast.textContent = message;
            toast.style.backgroundColor = type === 'error' ? dangerColor : type === 'success' ? accentColor : '#ffc107'; 
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
            }, 3500);
        }
        
        async function fetchData(action, data = {}, method = 'GET') {
            let url = `${WEB_APP_URL}?action=${action}`;
            let options = { method: method, redirect: 'follow' };
            const params = new URLSearchParams(data);

            if (method === 'GET') {
                url += '&' + params.toString();
            } else if (method === 'POST') {
                options.headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
                options.body = params.toString();
            }
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status === 'error') {
                    showToast(result.message, 'error');
                }
                return result;
            } catch (error) {
                showToast(`Error de conexi√≥n (fetch): ${error.message}`, 'error');
                console.error("Fetch Error:", error);
                return { status: 'error', message: `Error de conexi√≥n: ${error.message}` };
            }
        }
        
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            // Buscar el bot√≥n por su onclick attribute
            const targetButton = document.querySelector(`.tab-buttons button[onclick="showTab('${tabId}')"]`); 
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            if (tabId === 'notesSection' && (userRole === 'ADMIN' || userRole === 'TUTORA')) {
                loadNotes(noteFilterCodeInput.value.trim()); 
            } else if (tabId === 'dashboard' && (userRole === 'ADMIN' || userRole === 'TUTORA')) {
                 loadDashboardData();
            } else if (tabId === 'paymentsSection' && (userRole === 'ADMIN' || userRole === 'TUTORA')) {
                loadContributionHistory('');
            }
        }

// Esta funci√≥n es necesaria para el filtro din√°mico de notas (que sigue siendo un input de texto)
function getParticipantCodeFromNameOrCode(input) {
    const trimmedInput = input.trim();
    
    // 1. INTENTO DE DATALIST (Formato: "CODIGO - Nombre Completo")
    // Lo mantenemos aunque no haya datalist, por si el usuario escribe el formato completo.
    const parts = trimmedInput.split(' - ');
    const codeFromDatalist = parts[0];
    
    // Si se encontr√≥ el c√≥digo del formato datalist Y es v√°lido en el mapa
    if (allParticipantsMap[codeFromDatalist]) {
        return codeFromDatalist;
    }
    
    // 2. INTENTO DIRECTO (Input es solo el CODIGO)
    if (allParticipantsMap[trimmedInput]) {
         return trimmedInput;
    }
    
    // 3. FALLBACK (Input es solo el Nombre Completo)
    const foundByName = allParticipants.find(p => p[participantNameName] === trimmedInput);
    return foundByName ? foundByName[participantCodeName] : null;
}
        
        function formatYearMonth(ym) {
            if (!ym || ym.length !== 6) return ym;
            const year = ym.substring(0, 4);
            const month = ym.substring(4, 6);
            const date = new Date(year, month - 1, 1);
            return dateFns.format(date, 'MMMM YYYY');
        }
        
        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) return '$0.00';
            return `$${amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
        }
        
        // --- L√≥gica de Autenticaci√≥n y Setup ---

        function setupApp(role) {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', active: true },
                { id: 'paymentsSection', name: 'Aportes (Pago)' },
                { id: 'notesSection', name: 'Notas' }
            ];
            if (role === 'ADMIN') {
                 tabs.push({ id: 'participantCrudSection', name: 'Participantes (CRUD)' });
            }

            const tabButtonsContainer = document.getElementById('tabButtons');
            
            // CORRECCI√ìN: Obtener la referencia al bot√≥n de logout ANTES de limpiar el contenedor
            const logoutButton = document.getElementById('logoutButton'); 
            
            tabButtonsContainer.innerHTML = ''; 
            
            tabs.forEach(tab => {
                const btn = document.createElement('button');
                btn.className = `tab-button ${tab.active ? 'active' : ''}`;
                btn.textContent = tab.name;
                btn.setAttribute('onclick', `showTab('${tab.id}')`);
                tabButtonsContainer.appendChild(btn);
            });
            
            // CORRECCI√ìN: Re-insertar la referencia del bot√≥n (que a√∫n es un Node v√°lido)
            if (logoutButton) {
                tabButtonsContainer.appendChild(logoutButton);
            }
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'flex';
            
            if(tabs.length > 0) {
                 showTab(tabs[0].id);
            }
        }
        
        // --- L√≥gica de Carga y Renderizado General ---
        
        async function loadParticipantsAndRender() {
            const result = await fetchData('getParticipants', { 
                role: userRole, 
                filterValue: userFilterValue, 
                filterType: userFilterType 
            }, 'GET');

            if (result.status === 'success') {
                allParticipants = result.data || [];
                allParticipantsHeaders = result.headers || [];
                allParticipantsMap = {}; 
                
                // Construir el mapa para b√∫squedas r√°pidas
                allParticipants.forEach(p => {
                    allParticipantsMap[p[participantCodeName]] = p;
                });
                
                // INICIO: NUEVA L√ìGICA PARA POBLAR SELECTS
                const selectIds = ['paymentParticipantCode', 'noteParticipantCode', 'deleteCode', 'adminCode'];

                selectIds.forEach(id => {
                    const selectEl = document.getElementById(id);
                    if (selectEl) { 
                        // 1. Limpiar y asegurar la opci√≥n por defecto
                        selectEl.innerHTML = '<option value="">-- Seleccionar Participante --</option>';
                        
                        // 2. Insertar todas las opciones (C√ìDIGO - NOMBRE)
                        allParticipants.forEach(p => {
                            const optEl = document.createElement('option');
                            optEl.value = p[participantCodeName]; // El valor es solo el C√ìDIGO
                            optEl.textContent = `${p[participantCodeName]} - ${p[participantNameName]}`; // El texto es CODIGO - NOMBRE
                            selectEl.appendChild(optEl);
                        });
                    }
                });
                // FIN: NUEVA L√ìGICA PARA POBLAR SELECTS

                // Rellenar datalists (solo se necesita para el filtro de notas si sigue siendo input/datalist)
                // Se elimina la poblaci√≥n de los datalists que se reemplazaron por SELECTS
                
                renderParticipantsTable(allParticipants, allParticipantsHeaders);
                
                if (userRole === 'ADMIN' || userRole === 'TUTORA') {
                     // Solo si est√° en el m√≥dulo de Pagos, actualiza el resumen del primer participante
                     if (allParticipants.length > 0 && document.getElementById('paymentsSection').classList.contains('active')) {
                          // Se asigna el C√ìDIGO puro al value del SELECT
                          document.getElementById('paymentParticipantCode').value = allParticipants[0][participantCodeName];
                          await loadFinancialSummary(allParticipants[0][participantCodeName]);
                     }
                     // Si est√° en Dashboard, recarga los datos
                     if (document.getElementById('dashboard').classList.contains('active')) {
                         loadDashboardData();
                     }
                }
                
                showToast(`Carga de ${allParticipants.length} participantes exitosa.`, 'success');
            } else {
                 showToast(result.message, 'error');
            }
        }
        
        function renderParticipantsTable(participants, headers) {
             const participantTableHeaders = document.getElementById('participantTableHeaders');
             const participantsTableBody = document.getElementById('participantsTableBody');
             
             participantTableHeaders.innerHTML = '';
             participantsTableBody.innerHTML = '';
            
            if (participants.length === 0) {
                 participantsTableBody.innerHTML = '<tr><td colspan="100">No se encontraron participantes.</td></tr>';
                 return;
            }
            
            let baseHeaders = ['CODIGO', 'PARTICIPANTE', 'NACIONALIDAD', 'TUTORA', 'URL_ID'];
            const monthHeaders = headers.filter(h => /^\d{6}$/.test(h.toString())).sort();
            const visibleHeaders = [...baseHeaders, 'COSTO_MENSUAL', 'ABONO_ACUMULADO', ...monthHeaders];
            
            visibleHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                if (/^\d{6}$/.test(header)) {
                    th.textContent = formatYearMonth(header).substring(0, 3) + '/' + header.substring(2, 4); 
                }
                participantTableHeaders.appendChild(th);
            });
            
            participants.forEach(participant => {
                const tr = document.createElement('tr');
                visibleHeaders.forEach(header => {
                    const td = document.createElement('td');
                    let value = participant[header] || '';
                    td.textContent = value;
                    
                    if (/^\d{6}$/.test(header)) {
                        if (value.toString().toUpperCase() === 'X') {
                            td.classList.add('paid');
                        }
                    } else if (header === 'COSTO_MENSUAL' || header === 'ABONO_ACUMULADO') {
                        td.textContent = formatCurrency(parseFloat(value));
                    }
                    
                    tr.appendChild(td);
                });
                participantsTableBody.appendChild(tr);
            });
        }
        
        // --- L√≥gica del Dashboard (Charts) ---
        
        async function loadDashboardData() {
            const result = await fetchData('getDashboardData', {}, 'GET');

            if (result.status === 'success') {
                const data = result.data;
                
                // 1. M√©tricas
                document.getElementById('metricTotalParticipants').textContent = data.totalParticipants || 0;
                document.getElementById('metricMonthlyContribution').textContent = formatCurrency(data.monthlyContribution || 0);
                document.getElementById('metricParticipantsPaid').textContent = data.participantsPaid || 0;
                document.getElementById('metricParticipantsDebt').textContent = data.participantsDebt || 0;
                
                // 2. Gr√°ficos
                renderDashboardCharts(data.contributionsByTutor, data.nationalityDistribution);
            } else {
                 showToast(result.message, 'error');
            }
        }
        
        function renderDashboardCharts(tutorData, nationalityData) {
            // Destruir instancias previas
            Object.values(dashboardCharts).forEach(chart => chart.destroy());
            dashboardCharts = {};

            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d', '#17a2b8', '#fd7e14'];

            // Chart 1: Aportes por Tutora (Barra)
            const tutorLabels = Object.keys(tutorData).map(t => t.split(' ')[0]); // Solo el primer nombre
            const tutorValues = Object.values(tutorData);
            
            dashboardCharts.tutorChart = new Chart(chartContributionsByTutorCtx, {
                type: 'bar',
                data: {
                    labels: tutorLabels,
                    datasets: [{
                        label: 'Aportes ($)',
                        data: tutorValues,
                        backgroundColor: colors.slice(0, tutorLabels.length),
                        borderColor: colors.slice(0, tutorLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 2: Distribuci√≥n por Nacionalidad (Pie)
            const nationalityLabels = Object.keys(nationalityData);
            const nationalityValues = Object.values(nationalityData);
            
            dashboardCharts.nationalityChart = new Chart(chartNationalityDistributionCtx, {
                type: 'doughnut',
                data: {
                    labels: nationalityLabels,
                    datasets: [{
                        label: 'Participantes',
                        data: nationalityValues,
                        backgroundColor: colors.slice(0, nationalityLabels.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        // --- L√≥gica del M√≥dulo de Aportes/Pagos Compuestos ---
        
        paymentParticipantCodeInput.addEventListener('change', async (e) => {
            // AL SER UN SELECT, EL VALUE ES DIRECTAMENTE EL C√ìDIGO
            const code = e.target.value;
            
            if (code && allParticipantsMap[code]) {
                selectedParticipantNameEl.textContent = allParticipantsMap[code][participantNameName];
                await loadFinancialSummary(code);
            } else {
                showToast('Seleccione un participante v√°lido.', 'error');
                selectedParticipantNameEl.textContent = '---';
                monthsToPayList.innerHTML = '<p>Seleccione un participante para cargar los meses.</p>';
                loadContributionHistory('');
            }
        });
        
        amountPaidInput.addEventListener('input', calculatePaymentSummary);
        monthsToPayList.addEventListener('change', calculatePaymentSummary);
        
        function renderMonthsCheckboxes(availableMonths, financialStatus) {
            monthsToPayList.innerHTML = '';
            
            // Ordenar los meses de m√°s antiguo a m√°s nuevo
            const sortedMonths = availableMonths.sort(); 
            
            sortedMonths.forEach(ym => {
                const isPaid = financialStatus[ym] === 'X';
                const label = formatYearMonth(ym);
                
                const item = document.createElement('label');
                item.className = `month-item ${isPaid ? 'paid' : 'pending'}`;
                
                item.innerHTML = `
                    <input type="checkbox" value="${ym}" ${isPaid ? 'checked disabled' : ''} style="margin-right: 5px;">
                    ${label}
                `;
                monthsToPayList.appendChild(item);
            });
        }


        async function loadFinancialSummary(code) {
             submitPaymentButton.disabled = true;
             monthsToPayList.innerHTML = '<p>Cargando estado financiero...</p>';
             
             const result = await fetchData('getParticipantFinancialSummary', { participantCode: code }, 'GET');
             
             if (result.status === 'success') {
                financialSummary = result;
                
                // Calcular Deuda Pendiente TOTAL (NUEVO)
                const pendingMonths = result.availableMonths.filter(ym => result.financialStatus[ym] !== 'X');
                const totalPendingDebt = pendingMonths.length * result.monthlyCost;

                totalPendingDebtValueEl.textContent = formatCurrency(totalPendingDebt);
                pendingMonthsCountEl.textContent = pendingMonths.length;
                
                // Renderizar Resumen
                document.getElementById('summaryCode').textContent = code;
                monthlyCostValueEl.textContent = formatCurrency(result.monthlyCost);
                abonoBalanceValueEl.textContent = formatCurrency(result.abonoBalance);
                
                renderMonthsCheckboxes(result.availableMonths, result.financialStatus);
                calculatePaymentSummary();
                submitPaymentButton.disabled = false;
                
                // Cargar historial de aportes para el participante seleccionado
                loadContributionHistory(code); 
             } else {
                 showToast(result.message, 'error');
                 monthsToPayList.innerHTML = `<p style="color: var(--danger-color);">Error al cargar resumen: ${result.message}</p>`;
             }
        }
        
        function calculatePaymentSummary() {
            if (!financialSummary.monthlyCost) return;
            
            const montoEntregado = parseFloat(amountPaidInput.value) || 0;
            const abonoAnterior = financialSummary.abonoBalance || 0;
            const costoMensual = financialSummary.monthlyCost;
            
            const monthsToPay = Array.from(monthsToPayList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
                               .filter(ym => financialSummary.financialStatus[ym] !== 'X');
            
            const totalCostoMeses = monthsToPay.length * costoMensual;
            const totalFondo = abonoAnterior + montoEntregado;
            const nuevoAbono = totalFondo - totalCostoMeses;
            
            totalCostValueEl.textContent = formatCurrency(totalCostoMeses);
            abonoSurplusValueEl.textContent = formatCurrency(nuevoAbono);
            
            // Colores
            if (totalCostoMeses > 0 && nuevoAbono < 0) {
                 abonoSurplusValueEl.classList.add('status-debt');
                 abonoSurplusValueEl.classList.remove('status-abono');
            } else {
                 abonoSurplusValueEl.classList.add('status-abono');
                 abonoSurplusValueEl.classList.remove('status-debt');
            }

            // Deshabilitar bot√≥n si el nuevo abono es negativo o si no se hace nada
            submitPaymentButton.disabled = nuevoAbono < 0 || (totalCostoMeses === 0 && montoEntregado === 0 && abonoAnterior === 0);

            // Marcar visualmente los meses seleccionados para pago
            monthsToPayList.querySelectorAll('.month-item').forEach(item => {
                 const checkbox = item.querySelector('input[type="checkbox"]');
                 item.classList.remove('pending-selected');
                 if (!checkbox.disabled && checkbox.checked) { 
                     item.classList.add('pending-selected');
                 }
            });
        }
        
        // Listener de Formulario de Pago (Asegurarse de recargar los datos afectados)
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // SE OBTIENE EL C√ìDIGO DIRECTAMENTE DEL VALUE DEL SELECT
            const code = paymentParticipantCodeInput.value.trim();
            
            if (!code) {
                 showToast('Seleccione un participante v√°lido.', 'error');
                 return;
            }
            
            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            const mesesPagados = Array.from(monthsToPayList.querySelectorAll('input[type="checkbox"]:checked'))
                                     .map(cb => cb.value)
                                     .filter(ym => financialSummary.financialStatus[ym] !== 'X');
            const finalAbono = parseFloat(abonoSurplusValueEl.textContent.replace(/[$,]/g, '')) || 0;
            const paymentObservaciones = document.getElementById('paymentObservaciones').value;

            const data = {
                participantCode: code,
                amountPaid: amountPaid,
                mesesPagados: JSON.stringify(mesesPagados),
                finalAbono: finalAbono,
                paymentObservaciones: paymentObservaciones
            };

            const result = await fetchData('registerComplexPayment', data, 'POST');
            
            if (result.status === 'success') {
                showToast(result.message, 'success');
                paymentForm.reset();
                // Actualizaciones AS√çNCRONAS:
                await loadParticipantsAndRender(); // Recarga la tabla de dashboard
                await loadFinancialSummary(code); // Recarga el resumen del participante y el historial
            }
        });
        
        // --- L√≥gica de Historial de Aportes ---
        
        async function loadContributionHistory(codeFilter = '') {
             contributionHistoryTableBody.innerHTML = '<tr><td colspan="8">Cargando historial de aportes...</td></tr>';
             
             const result = await fetchData('getContributionHistory', {}, 'GET'); 
             
             if (result.status === 'success') {
                 historyData = result.data.map(item => ({
                     ...item,
                     // Buscar nombre y tutora en el mapa local
                     PARTICIPANTE: allParticipantsMap[item.CODIGO_PARTICIPANTE] ? allParticipantsMap[item.CODIGO_PARTICIPANTE][participantNameName] : 'N/A',
                     TUTORA: allParticipantsMap[item.CODIGO_PARTICIPANTE] ? allParticipantsMap[item.CODIGO_PARTICIPANTE][participantTutoraName] : 'N/A',
                     FECHA_DATE: new Date(item.FECHA)
                 }));
                 applyHistoryFilters(codeFilter);
             } else {
                 contributionHistoryTableBody.innerHTML = `<tr><td colspan="8">Error al cargar el historial: ${result.message}</td></tr>`;
             }
             
             // Inicializar los selects de mes y a√±o una sola vez
             if (historyFilterYear.options.length <= 1) {
                 const currentYear = new Date().getFullYear();
                 for(let i = 0; i < 3; i++) { historyFilterYear.options.add(new Option(currentYear - i, currentYear - i)); }
             }
             if (historyFilterMonth.options.length <= 1) {
                 const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                 monthNames.forEach((name, index) => {
                     historyFilterMonth.options.add(new Option(name, (index + 1).toString().padStart(2, '0')));
                 });
             }
        }
        
        function applyHistoryFilters(initialCode = '') {
            const filterText = (initialCode || historyFilterText.value || '').trim().toLowerCase();
            const filterMonth = historyFilterMonth.value;
            const filterYear = historyFilterYear.value;
            const filterTutora = historyFilterTutora.value;

            let filteredData = historyData.filter(item => {
                const codeMatch = item.CODIGO_PARTICIPANTE.toLowerCase().includes(filterText);
                const nameMatch = item.PARTICIPANTE.toLowerCase().includes(filterText);
                
                const monthMatch = !filterMonth || dateFns.format(item.FECHA_DATE, 'MM') === filterMonth;
                const yearMatch = !filterYear || dateFns.format(item.FECHA_DATE, 'YYYY') === filterYear;
                const tutoraMatch = !filterTutora || item.TUTORA === filterTutora;

                return (codeMatch || nameMatch) && monthMatch && yearMatch && tutoraMatch;
            });

            renderContributionHistoryTable(filteredData);
        }
        
        function renderContributionHistoryTable(data) {
            contributionHistoryTableBody.innerHTML = '';
            if (data.length === 0) {
                 contributionHistoryTableBody.innerHTML = '<tr><td colspan="8">No se encontraron aportes con los filtros aplicados.</td></tr>';
                 return;
            }
            
            data.forEach(item => {
                 const tr = document.createElement('tr');
                 // Asegurarse de que el MONTO_PAGADO y ABONO_REMANENTE sean n√∫meros
                 const montoPagado = parseFloat(item.MONTO_PAGADO) || 0;
                 const abonoRemanente = parseFloat(item.ABONO_REMANENTE) || 0;
                 
                 tr.innerHTML = `
                     <td>${dateFns.format(item.FECHA_DATE, 'DD/MM/YYYY')}</td>
                     <td>${item.CODIGO_PARTICIPANTE}</td>
                     <td>${item.PARTICIPANTE}</td>
                     <td>${item.TUTORA}</td>
                     <td>${formatCurrency(montoPagado)}</td>
                     <td>${JSON.parse(item.MESES_CUBIERTOS || '[]').map(ym => formatYearMonth(ym).substring(0, 3)).join(', ')}</td>
                     <td>${formatCurrency(abonoRemanente)}</td>
                     <td>${item.OBSERVACIONES || ''}</td>
                 `;
                 contributionHistoryTableBody.appendChild(tr);
            });
        }
        
        // Listeners para filtros del historial de aportes
        [historyFilterText, historyFilterMonth, historyFilterYear, historyFilterTutora].forEach(input => {
             input.addEventListener('input', () => applyHistoryFilters());
        });
        
        // --- L√≥gica del M√≥dulo de Participantes (CRUD) ---

        document.getElementById('addParticipantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                CODIGO: document.getElementById('addCode').value.trim(),
                PARTICIPANTE: document.getElementById('addParticipant').value.trim(),
                NACIONALIDAD: document.getElementById('addNacionalidad').value,
                TUTORA: document.getElementById('addTutor').value,
                URL_ID: document.getElementById('addUrlId').value.trim()
                // COSTO_MENSUAL y ABONO_ACUMULADO se manejan con valores por defecto en el Apps Script
            };
            
            const result = await fetchData('addParticipant', { data: JSON.stringify(data) }, 'POST');
            if (result.status === 'success') {
                showToast(result.message, 'success');
                document.getElementById('addParticipantForm').reset();
                await loadParticipantsAndRender(); 
            }
        });
        
        document.getElementById('deleteParticipantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // SE OBTIENE EL C√ìDIGO DIRECTAMENTE DEL VALUE DEL SELECT
            const code = document.getElementById('deleteCode').value.trim();
            
            if (!code) { showToast('Seleccione un participante v√°lido para eliminar.', 'error'); return; }
            
            if (!confirm(`¬øEst√° seguro de eliminar al participante con c√≥digo ${code}? Esta acci√≥n es irreversible.`)) {
                return;
            }
            
            const result = await fetchData('deleteParticipant', { code }, 'POST');
            if (result.status === 'success') {
                showToast(result.message, 'success');
                document.getElementById('deleteParticipantForm').reset();
                await loadParticipantsAndRender(); 
            }
        });
        
        document.getElementById('adminUpdateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // SE OBTIENE EL C√ìDIGO DIRECTAMENTE DEL VALUE DEL SELECT
            const code = document.getElementById('adminCode').value.trim();
            if (!code) { showToast('Seleccione un participante v√°lido.', 'error'); return; }

            const yearMonth = document.getElementById('adminYearMonth').value.trim();
            let value = document.getElementById('adminValue').value.trim().toUpperCase();
            
            if (value !== 'X') {
                value = '';
            }

            const result = await fetchData('updateParticipantMonth', { 
                code, yearMonth, value 
            }, 'POST');
            
            if (result.status === 'success') {
                showToast(result.message, 'success');
                await loadParticipantsAndRender(); 
            }
        });


        // --- L√≥gica del M√≥dulo de Notas ---

        // Listener de Formulario de Notas
        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // SE OBTIENE EL C√ìDIGO DIRECTAMENTE DEL VALUE DEL SELECT
            const code = document.getElementById('noteParticipantCode').value.trim();
            if (!code) { showToast('Seleccione un participante v√°lido.', 'error'); return; }

            const fecha = document.getElementById('noteFecha').value;
            const tipo = document.getElementById('noteTipo').value;
            const descripcion = document.getElementById('noteDescripcion').value;
            
            const result = await fetchData('registerNote', { 
                code, fecha, tipo, descripcion, responsable: userResponsible 
            }, 'POST');
            
            if (result.status === 'success') {
                showToast('Nota registrada. ' + result.message, 'success');
                document.getElementById('noteForm').reset();
                document.getElementById('noteFecha').value = dateFns.format(new Date(), 'YYYY-MM-DD');
                loadNotes(code); 
            }
        });
        
        // Listener para el filtro de notas (funciona por c√≥digo o nombre)
        noteFilterCodeInput.addEventListener('input', (e) => {
            const fullInput = e.target.value.trim();
            // Esta funci√≥n se mantiene porque el filtro sigue siendo un INPUT DE TEXTO
            const code = getParticipantCodeFromNameOrCode(fullInput) || fullInput; 
            loadNotes(code);
        });

        async function loadNotes(filterValue = '') {
            if (userRole === 'PARTICIPANTE' && userFilterValue) {
                filterValue = userFilterValue; 
            } else if (!userRole) {
                return; 
            }
            
            notesListContainer.innerHTML = '<p>Cargando notas...</p>';
            
            const result = await fetchData('getNotes', { filterValue }, 'GET');
            
            if (result.status === 'success') {
                renderNotes(result.data);
            } else {
                notesListContainer.innerHTML = `<p style="color: var(--danger-color);">${result.message}</p>`;
            }
        }
        
        function renderNotes(notes) {
            notesListContainer.innerHTML = '';
            if (notes.length === 0) {
                 notesListContainer.innerHTML = '<p>No se encontraron notas registradas.</p>';
                 return;
            }
            
            notes.sort((a, b) => new Date(b.FECHA) - new Date(a.FECHA)); 
            
            notes.forEach(note => {
                const isSolved = !!note.SOLUCION;
                const participantCode = note.CODIGO_PARTICIPANTE;
                const participantName = allParticipantsMap[participantCode] ? allParticipantsMap[participantCode][participantNameName] : 'N/A';
                // La fecha puede venir como objeto Date o string, la normalizamos
                const dateObj = note.FECHA instanceof Date ? note.FECHA : new Date(note.FECHA);
                const formattedDate = dateFns.format(dateObj, 'DD/MM/YYYY');
                
                const noteCard = document.createElement('div');
                noteCard.className = `note-card ${note.TIPO} ${isSolved ? 'Solucionada' : ''}`;
                
                let actionsHtml = '';
                if (userRole === 'ADMIN' || userRole === 'TUTORA') {
                     actionsHtml = `
                        <div class="note-actions" style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="action-button edit solution-btn" data-id="${note.ID}">
                                 ${isSolved ? 'Editar Soluci√≥n' : 'A√±adir Soluci√≥n'}
                            </button>
                            <button class="action-button delete delete-note-btn" data-id="${note.ID}">Eliminar</button>
                        </div>
                        <form class="note-solution-form" data-id="${note.ID}" style="display: none;">
                            <textarea name="solutionText" rows="2" placeholder="Escriba la soluci√≥n/respuesta...">${note.SOLUCION || ''}</textarea>
                            <button type="submit" class="secondary-button" style="margin-top: 5px;">Guardar Soluci√≥n</button>
                        </form>
                    `;
                }

                noteCard.innerHTML = `
                    <h4>${note.TIPO}${isSolved ? ' (SOLUCIONADA)' : ''} - ${participantName} (${participantCode})</h4>
                    <p style="font-size: 0.9em; color: var(--secondary-color);">Fecha: ${formattedDate} | Registrado por: ${note.RESPONSABLE_REGISTRO}</p>
                    <p><strong>Descripci√≥n:</strong> ${note.DESCRIPCION}</p>
                    
                    ${isSolved ? `<div class="solution-text" style="margin-top: 10px; padding: 5px; border-left: 3px solid #6f42c1; background-color: #f8f6ff;"><strong>Soluci√≥n:</strong> ${note.SOLUCION}</div>` : ''}
                    ${actionsHtml}
                `;
                notesListContainer.appendChild(noteCard);
            });
            
            // Re-adjuntar listeners de soluci√≥n y eliminar solo si el rol lo permite
            if (userRole === 'ADMIN' || userRole === 'TUTORA') {
                notesListContainer.querySelectorAll('.solution-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const form = notesListContainer.querySelector(`.note-solution-form[data-id="${btn.dataset.id}"]`);
                        form.style.display = form.style.display === 'none' ? 'block' : 'none';
                    });
                });

                notesListContainer.querySelectorAll('.note-solution-form').forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const noteId = form.dataset.id;
                        const solution = form.querySelector('textarea[name="solutionText"]').value;
                        
                        const result = await fetchData('updateNoteSolution', { 
                            noteId, solution, responsible: userResponsible 
                        }, 'POST');
                        if (result.status === 'success') {
                            showToast(result.message, 'success');
                            loadNotes(noteFilterCodeInput.value.trim()); // Actualizaci√≥n as√≠ncrona
                        }
                    });
                });

                notesListContainer.querySelectorAll('.delete-note-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const noteId = btn.dataset.id;
                        if (!confirm('¬øEst√° seguro de eliminar esta nota?')) return;
                        
                        const result = await fetchData('deleteNote', { noteId }, 'POST');
                        if (result.status === 'success') {
                            showToast(result.message, 'success');
                            loadNotes(noteFilterCodeInput.value.trim()); // Actualizaci√≥n as√≠ncrona
                        }
                    });
                });
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('noteFecha').value = dateFns.format(new Date(), 'YYYY-MM-DD');
             
             // Adjuntar listeners de login
             const loginForm = document.getElementById('loginForm');
             loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                document.getElementById('loginMessage').textContent = 'Autenticando...';
                
                const result = await fetchData('authenticateUser', { username, password }, 'POST');
                
                if (result.status === 'success') {
                    userRole = result.role;
                    userResponsible = result.responsible;
                    userFilterValue = result.filterValue;
                    userFilterType = result.filterType;
                    
                    document.getElementById('loginMessage').textContent = 'Acceso concedido.';
                    
                    // LLAMA LA FUNCI√ìN CORREGIDA
                    setupApp(userRole); 
                    await loadParticipantsAndRender(); 
                } else {
                    document.getElementById('loginMessage').textContent = result.message;
                }
            });
             
            // Listener para cerrar sesi√≥n
            document.getElementById('logoutButton').addEventListener('click', () => {
                userRole = null;
                userResponsible = null;
                userFilterValue = null;
                userFilterType = null;
                document.getElementById('appSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('loginForm').reset();
                showToast('Sesi√≥n cerrada correctamente.', 'info');
            });
        });
    </script>
</body>

</html>